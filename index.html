<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kiscord</title>
    <link rel="icon" type="image/png" href="czippel2_kytka-modified.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#202225">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kiscord.github.io/"> <meta property="og:title" content="Kiscord Premium: Kl√°rka Edition"> <meta property="og:description" content="Exkluzivn√≠ p≈ô√≠stup do soukrom√©ho serveru.">
    <meta property="og:image" content="Czippel2_kytka.jpg"> <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Kiscord Premium: Kl√°rka Edition">
    <meta property="twitter:description" content="Exkluzivn√≠ p≈ô√≠stup do soukrom√©ho serveru. ƒåek√° na tebe Timeline, Knihovna a Pl√°novaƒç rande.">
    <meta property="twitter:image" content="Czippel2_vanoce.png">
    
    <meta name="theme-color" content="#5865F2">
    <link rel="apple-touch-icon" href="Czippel2_kytka.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Consolas:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- LEAFLET MAPS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- LEAFLET MAPS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            /* Discord barvy */
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --text-normal: #dcddde;
            --text-header: #ffffff;
            --interactive-normal: #b9bbbe;
            --blurple: #5865F2;
            --green: #3ba55c;
            --red: #ed4245;
            --yellow: #faa61a;
            --pink: #eb459e;
            --font-main: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-primary);
            color: var(--text-normal);
            overflow: hidden;
        }

        html { scroll-behavior: smooth; }

        input, textarea { user-select: text !important; -webkit-user-select: text !important; }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: var(--bg-tertiary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #1a1b1e; border-radius: 4px; }

        /* Animace */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(235, 69, 158, 0.3); } 50% { box-shadow: 0 0 15px rgba(235, 69, 158, 0.6); } }
        .pulse-glow { animation: pulse-glow 2s infinite; }

        /* --- STYL MAPY A PINOV --- */
        #leaflet-map { width: 100%; height: 100%; background: #e3e8eb; z-index: 1; }

        /* Vzhled Pinu (Kapka) */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 30px; height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #5865F2;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%; top: 50%;
            margin: -15px 0 0 -15px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            border: 2px solid white;
        }
        /* Ikona uvnit≈ô pinu (otoƒçen√≠ zpƒõt) */
        .marker-pin i {
            transform: rotate(45deg);
            color: white; font-size: 14px;
        }
        .marker-pin:hover { transform: rotate(-45deg) scale(1.2); z-index: 1000; transition: transform 0.2s; }

        /* Bubliny na mapƒõ */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #2f3136; color: #dcddde; border: 1px solid #202225;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .leaflet-container a { color: #5865F2; }
        .leaflet-popup-content b { color: #fff; font-size: 14px; }
        .leaflet-container a.leaflet-popup-close-button { color: #b9bbbe; }

        /* --- KNIHOVNA & HODNOCEN√ç --- */
        .star-btn {
            color: #4f545c; /* ≈†ed√° pro neaktivn√≠ */
            transition: color 0.2s, transform 0.1s;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .star-btn.active {
            color: #faa61a; /* Zlat√° pro aktivn√≠ */
        }
        .star-btn:hover {
            transform: scale(1.2);
        }

        /* User Popout Animation */
        /* .user-popout {
            position: absolute;
            bottom: 60px;
            left: 10px;
            width: 300px;
            background: #18191c;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.24);
            z-index: 100;
            overflow: hidden;
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #2f3136;
        }
        .user-popout.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        } */
        /* .popout-banner { height: 60px; background: #5865F2; }
        .popout-avatar { 
            width: 80px; height: 80px; 
            border-radius: 50%; 
            border: 6px solid #18191c; 
            position: absolute; top: 20px; left: 20px; 
        }
        .popout-badges { position: absolute; top: 85px; right: 16px; background: #18191c; border-radius: 4px; padding: 2px; } */

        /* Ostatn√≠ styly (CMD, Modals...) */
        .modal-backdrop { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(3px); }
        .cmd-window { font-family: 'Consolas', monospace; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .cmd-header { background: #fff; color: #000; padding: 2px 10px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .cmd-body { background: #0c0c0c; color: #ccc; padding: 5px; height: 400px; overflow-y: auto; }
        .cmd-cursor { display: inline-block; width: 8px; height: 14px; background: #ccc; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .typing-cursor::after { content: '|'; animation: blink 1s infinite; color: var(--pink); margin-left: 2px; }

        /* Mobiln√≠ zobrazen√≠ */
        @media (max-width: 768px) {
            #leaflet-map { min-height: 350px; }
            .flex-col-mobile { flex-direction: column; }
        }

        /* --- NOV√â: 1. User Popout Animation --- */
        .user-popout {
            position: absolute;
            bottom: 60px;
            left: 10px;
            width: 300px;
            background: #18191c;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.24);
            z-index: 200; /* Zv√Ω≈°eno, aby to bylo nad v≈°√≠m */
            overflow: hidden;
            transform: scale(0.9);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #2f3136;
        }
        .user-popout.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        .popout-banner { height: 60px; background: #5865F2; }
        .popout-avatar { 
            width: 80px; height: 80px; 
            border-radius: 50%; 
            border: 6px solid #18191c; 
            position: absolute; top: 20px; left: 20px; 
        }
        .popout-badges { position: absolute; top: 85px; right: 16px; background: #18191c; border-radius: 4px; padding: 2px; }

        /* --- NOV√â: 2. Message Hover Effect --- */
        .message-group {
            padding: 8px 16px; /* Zvƒõt≈°eno pro lep≈°√≠ vzhled */
            margin-top: 2px;
            position: relative;
        }
        .message-group:hover {
            background-color: rgba(4, 4, 5, 0.07);
        }
        .message-actions {
            position: absolute;
            top: -10px;
            right: 16px;
            background: #36393f;
            border: 1px solid #202225;
            border-radius: 4px;
            padding: 4px;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .message-group:hover .message-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- NOV√â: 3. Custom Tooltip --- */
        [data-tooltip] { position: relative; }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #18191c;
            color: #dcddde;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-bottom: 8px;
            z-index: 1000;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #18191c;
            margin-bottom: -4px;
            z-index: 1000;
        }

        /* --- VYLEP≈†EN√â HVƒöZDIƒåKY (Interactive Stars) --- */
        /* Kontejner otoƒç√≠ po≈ôad√≠ prvk≈Ø, aby fungoval CSS selektor pro "p≈ôedchoz√≠" sourozence */
        .star-rating-group {
            display: flex;
            flex-direction: row-reverse; 
            justify-content: flex-end;
            gap: 2px;
        }

        .star-btn {
            color: #4f545c; /* Neaktivn√≠ ≈°ed√° */
            font-size: 1.2rem;
            transition: color 0.1s, transform 0.1s;
            padding: 0 2px;
        }

        /* 1. Logika pro ULO≈ΩEN√â hodnocen√≠ (zlat√°) */
        /* V≈°echny hvƒõzdy, kter√© maj√≠ class active, budou zlat√© */
        /* Kv≈Øli row-reverse mus√≠me barvit trochu chyt≈ôeji v JS, ale tady staƒç√≠ z√°klad */
        .star-btn.active {
            color: #faa61a;
        }

        /* 2. Logika pro HOVER (interaktivn√≠) */
        /* Jakmile najedeme na kontejner, zru≈°√≠me zlatou u v≈°ech (aby se nep≈ôetloukaly s hoverem) */
        .star-rating-group:hover .star-btn {
            color: #4f545c; 
        }

        /* A teƒè to kouzlo: Obarvi tu, na kter√© je my≈°... A v≈°echny "n√°sleduj√≠c√≠" v DOMu (vizu√°lnƒõ p≈ôedchoz√≠) */
        .star-btn:hover,
        .star-btn:hover ~ .star-btn {
            color: #faa61a !important;
            transform: scale(1.3);
        }

        /* --- FIX PRO TOOLTIPY (Aby nebyly useknut√©) --- */
        /* P≈ôi najet√≠ na kartu ji vyt√°hneme "nad" ostatn√≠, aby tooltip nep≈ôekr√Ωval sousedn√≠ film */
        /* --- LIBRARY GRID DESIGN (Netflix Style) --- */
        .library-card {
            display: flex;
            flex-direction: column; /* Svisl√© uspo≈ô√°d√°n√≠: Ikona naho≈ôe, text dole */
            background: #2f3136;
            border-radius: 8px;
            overflow: visible; /* D≈Øle≈æit√© pro tooltipy! */
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            position: relative;
            height: 100%;
            border: 1px solid #202225;
        }

        /* Hover efekt cel√© karty */
        .library-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            background-color: #36393f;
            z-index: 50; /* Vyt√°hne kartu nad ostatn√≠, aby tooltipy byly vidƒõt */
            border-color: #5865F2;
        }

        /* Sekce s ikonou (Plak√°t) */
        .poster-area {
            height: 120px; /* Fixn√≠ v√Ω≈°ka pro ikonu */
            background: #202225;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem; /* Ob≈ô√≠ ikona */
            border-bottom: 1px solid #202225;
            border-radius: 8px 8px 0 0;
            transition: font-size 0.2s;
        }
        
        .library-card:hover .poster-area {
            font-size: 4.5rem; /* Ikona se p≈ôi najet√≠ m√≠rnƒõ zvƒõt≈°√≠ */
        }

        /* Sekce s obsahem */
        .content-area {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        /* Tlaƒç√≠tka pod filmem */
        .card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto; /* P≈ôilep√≠ tlaƒç√≠tka dol≈Ø */
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .card-actions button {
            color: #b9bbbe;
            transition: color 0.2s, transform 0.2s;
        }
        .card-actions button:hover {
            color: #fff;
            transform: scale(1.1);
        }
        
        /* Tooltip styly (jen uji≈°tƒõn√≠, ≈æe maj√≠ vysok√Ω z-index a nealamuj√≠ my≈°) */
        [data-tooltip]:hover::after, [data-tooltip]:hover::before {
            z-index: 9999;
            pointer-events: none;
        }

        /* --- MOBILE DATE PLANNER STYLES --- */
        /* Skryje scrollbar v seznamu kategori√≠, ale zachov√° posouv√°n√≠ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Detail panel jako "Bottom Sheet" na mobilu */
        /* --- MOBILE DATE PLANNER STYLES --- */
            /* --- MOBILE DATE PLANNER STYLES --- */
            @media (max-width: 768px) {
                .mobile-map-overlay {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    
                    /* --- FIN√ÅLN√ç NASTAVEN√ç --- */
                    height: 85vh !important; /* Panel je vysok√Ω 85% obrazovky */
                    display: flex;
                    flex-direction: column;
                    
                    background: #2f3136;
                    border-radius: 20px 20px 0 0;
                    box-shadow: 0 -10px 30px rgba(0,0,0,0.5); /* V√Ωraznƒõj≈°√≠ st√≠n */
                    z-index: 9999 !important;
                    
                    /* Pro plynulost na iPhonech */
                    will-change: transform; 
                    transform: translateY(100%); 
                    transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
                }
                
                #detail-content {
                    overscroll-behavior: contain; 
                }

                /* Na mobilu chceme m√≠sto dole kv≈Øli gest≈Øm */
                @media (max-width: 768px) {
                    #detail-content {
                        /* P≈Øvodnƒõ 80px, zmen≈°eno na minimum + rezerva pro iPhone ƒç√°rku */
                        padding-bottom: calc(20px + env(safe-area-inset-bottom)); 
                    }
                }

                /* Na PC chceme jen mal√© odsazen√≠ */
                @media (min-width: 769px) {
                    #detail-content {
                        padding-bottom: 10px; /* Mal√© odsazen√≠ na PC */
                    }
                }

                /* Seznam m√≠st na mobilu */
                .mobile-list-overlay {
                    position: absolute;
                    inset: 0;
                    background: #2f3136;
                    z-index: 900;
                    display: none; 
                }
                .mobile-list-overlay.active { display: flex; }
            }
        
            /* Styl pro panel, kter√Ω plat√≠ v≈ædy (i na desktopu) */
            .mobile-map-overlay {
                background: #2f3136; /* Barva pozad√≠ */
                border-radius: 20px 20px 0 0; /* Kulat√© rohy naho≈ôe */
                box-shadow: 0 -10px 30px rgba(0,0,0,0.5); /* St√≠n */
                display: flex;
                flex-direction: column;
                z-index: 999;
            }

            /* Na mobilu chceme fixn√≠ v√Ω≈°ku, na desktopu max-v√Ω≈°ku */
            @media (max-width: 768px) {
                .mobile-map-overlay {
                    height: 85vh !important;
                }
            }

        @media (min-width: 769px) {
            .mobile-map-overlay {
                height: auto !important; /* D≈ÆLE≈ΩIT√â: V√Ω≈°ka se p≈ôizp≈Øsob√≠ obsahu */
                max-height: 60vh;        /* Ale nep≈Øjde p≈ôes 60% obrazovky */
                bottom: 20px;            /* Odlep√≠me ho od spodn√≠ hrany (vypad√° to modernƒõji) */
                left: 20px;              /* Odlep√≠me zleva */
                right: 20px;             /* Odlep√≠me zprava (nebo m≈Ø≈æe≈° d√°t width: 500px a margin: 0 auto) */
                border-radius: 20px;     /* Zakulat√≠me v≈°echny rohy, nejen horn√≠ */
                box-shadow: 0 5px 30px rgba(0,0,0,0.8); /* Silnƒõj≈°√≠ st√≠n pro oddƒõlen√≠ od mapy */
            }
            
            /* Skryjeme "tah√°tko" (handle) na desktopu, tam ned√°v√° smysl */
            #sheet-handle {
                display: none !important;
            }
            
            /* Tlaƒç√≠tko zav≈ô√≠t posuneme, aby vypadalo l√©pe */
            .mobile-map-overlay .fa-times {
                top: 10px !important;
                right: 10px !important;
            }
        }

        /* --- MOBILE GESTURES CSS --- */
        
        /* Zabr√°n√≠ scrollov√°n√≠ str√°nky p≈ôi ta≈æen√≠ panelu */
        .touch-none { touch-action: none; }
        
        /* Vƒõt≈°√≠ plocha pro "chycen√≠" panelu naho≈ôe */
        /* Vƒõt≈°√≠ plocha pro "chycen√≠" panelu naho≈ôe */
        .sheet-handle-area {
            width: 100%;
            height: 40px; /* Zvƒõt≈°il jsem to z 30px, a≈• je v√≠c m√≠sta pro prst */
            
            /* --- ZMƒöNA ZDE: U≈æ ne absolute! --- */
            position: relative; 
            flex-shrink: 0; /* Aby se nezmen≈°oval, kdy≈æ je m√°lo m√≠sta */
            /* ---------------------------------- */
            
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            z-index: 50;
            background: transparent; 
        }

        /* Vizu√°ln√≠ ƒç√°rka (Handle) */
        .sheet-handle-bar {
            width: 40px;
            height: 5px;
            background-color: #4f545c;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .sheet-handle-area:active .sheet-handle-bar {
            background-color: #eb459e; /* Zr≈Ø≈æov√≠ p≈ôi ta≈æen√≠ */
        }

        /* Hladk√° animace jen kdy≈æ netah√°me prstem */
        .sheet-transition {
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row text-sm select-none transition-colors duration-300">

    <!-- ========== INITIAL SCREENS ========== -->
    
    <!-- Screen 1: Login -->
    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-[#36393f] flex-col">
        <div class="bg-[#2f3136] p-10 rounded-xl shadow-2xl w-full max-w-md text-center transform transition-all" id="login-box">
            <div class="mb-6">
                <div class="text-6xl mb-2">ü¶â‚ù§Ô∏èüêô</div>
                <div class="text-xs text-gray-400">Kiscord Auth System v1.0</div>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Server Autentifikace</h1>
            <p class="text-gray-400 mb-8">Pro vstup je vy≈æadov√°no ovƒõ≈ôen√≠ re√°ln√© polohy.</p>
            
            <button id="verify-btn" onclick="verifyLocation()" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-bold py-4 rounded-lg transition-all flex items-center justify-center gap-3 text-lg group shadow-lg">
                <i class="fas fa-satellite-dish group-hover:rotate-12 transition"></i>
                <span id="verify-text">Ovƒõ≈ôit polohu</span>
            </button>

            <div id="verify-status" class="mt-6 text-left hidden space-y-2 font-mono text-xs bg-[#202225] p-3 rounded">
                <div class="flex items-center gap-2 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin"></i> Skenov√°n√≠ satelit≈Ø...
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 2: Fact Checker Quiz (Hidden) -->
    <div id="quiz-screen" class="fixed inset-0 z-[60] hidden bg-[#36393f] flex-col items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-[#2f3136] rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-[#202225] p-6 border-b border-[#202225] flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2"><i class="fas fa-shield-alt text-[#5865F2]"></i> Bezpeƒçnostn√≠ Provƒõrka</h2>
                    <p class="text-xs text-gray-400 mt-1">Ovƒõ≈ôen√≠ kompatibility pamƒõ≈•ov√Ωch modul≈Ø</p>
                </div>
                <div class="text-right"><div class="text-2xl font-bold text-[#5865F2]" id="quiz-step-text">1/10</div></div>
            </div>
            <div class="w-full h-2 bg-[#202225]"><div id="quiz-progress" class="progress-bar-dynamic w-0"></div></div>
            <div class="p-8 flex-1 overflow-y-auto" id="quiz-container"></div>
            <div id="fun-fact-container" class="bg-[#202225] p-4 text-xs text-gray-400 border-t border-[#202225] hidden"><span class="font-bold text-[#5865F2]">üí° Fun Fact:</span> <span id="fun-fact-text"></span></div>
        </div>
    </div>

    <!-- Screen 3: Certificate (Hidden) -->
    <div id="certificate-screen" class="fixed inset-0 z-[60] hidden bg-[#36393f] flex-col items-center justify-center p-4">
        <div class="bg-[#2f3136] p-10 rounded-xl shadow-2xl text-center max-w-lg border-2 border-[#5865F2] relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-[#5865F2] to-[#eb459e]"></div>
            <div class="text-6xl mb-6">üèÜ</div>
            <h2 class="text-3xl font-extrabold text-white mb-2">CERTIFIK√ÅT OVƒö≈òEN√ç</h2>
            <p class="text-gray-400 mb-6">Udƒõleno u≈æivateli <span class="text-white font-bold">Kl√°rka</span></p>
            <div class="bg-[#202225] p-6 rounded-lg mb-8 text-left space-y-3">
                <div class="flex justify-between"><span class="text-gray-500">Hodnost:</span><span class="text-[#3ba55c] font-bold">Vrchn√≠ Fact-Checker</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Sk√≥re:</span><span class="text-[#faa61a] font-bold" id="quiz-score">100%</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Datum:</span><span class="text-white" id="cert-date"></span></div>
            </div>
            <button onclick="showMainApp()" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white font-bold py-4 rounded-lg transition-all shadow-lg animate-pulse">VSTOUPIT DO SERVERU</button>
        </div>
    </div>

    <!-- ========== MAIN APP ========== -->
    <div id="app-interface" class="flex w-full h-full hidden opacity-0 transition-opacity duration-1000">
        
        <!-- SERVER LIST -->
        <div id="sidebar-wrapper" class="fixed inset-y-0 left-0 z-50 flex h-full transition-transform duration-300 transform -translate-x-full md:relative md:translate-x-0 shadow-2xl md:shadow-none">
        
        <div class="bg-[var(--bg-tertiary)] w-[72px] flex flex-col items-center py-3 gap-2 flex-shrink-0 border-r border-[var(--bg-tertiary)]">
            <div class="w-12 h-12 bg-[var(--bg-primary)] rounded-full hover:rounded-2xl hover:bg-[var(--blurple)] transition-all cursor-pointer flex items-center justify-center text-[var(--text-normal)] hover:text-white mb-2">
                <i class="fab fa-discord text-xl"></i>
            </div>
            <div class="w-8 h-[2px] bg-[var(--bg-primary)] rounded mb-2"></div>
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-2xl cursor-pointer flex items-center justify-center overflow-hidden">
                <div class="w-12 h-12 rounded-2xl cursor-pointer flex items-center justify-center overflow-hidden shadow-lg group transition-all duration-200">
                    <img src="Czippel2_vanoce.png" alt="K&T Server" class="w-full h-full object-cover" loading="lazy">
                </div>
            </div>
        </div>

        <div class="bg-[var(--bg-secondary)] w-60 flex flex-col flex-shrink-0 border-r border-[var(--bg-tertiary)]">
            <div class="h-12 border-b border-[var(--bg-tertiary)] flex items-center justify-between px-4 font-bold text-[var(--text-header)] hover:bg-[#34373c] cursor-pointer transition">
                <span class="truncate">üéÅ V√°noƒçn√≠ D√°rek 2025</span>
                <i class="fas fa-chevron-down text-xs"></i>
            </div>
            <div class="flex-1 overflow-y-auto py-3 custom-scrollbar">
                <div id="channels-container"></div>
            </div>
            <div class="h-[52px] bg-[var(--bg-tertiary)] flex items-center px-2 w-full cursor-pointer hover:bg-[#34373c] transition select-none" onclick="toggleUserPopout()">
                <div class="relative w-8 h-8 mr-2 group">
                    <img src="klarka_profilovka.webp" alt="Kl√°rka" class="w-8 h-8 rounded-full object-cover" loading="lazy">
                    <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-[var(--green)] rounded-full border-2 border-[#292b2f]"></div>
                </div>
                <div class="flex-1 overflow-hidden">
                    <div class="text-[var(--text-header)] text-xs font-bold truncate">Kl√°rka</div>
                    <div class="text-[var(--interactive-normal)] text-[10px] truncate">#1337 ‚Ä¢ <span id="user-status">Online</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- MAIN CONTENT AREA -->
        <div class="bg-[var(--bg-primary)] flex-1 flex flex-col min-w-0 relative z-10 overflow-hidden h-screen md:h-auto">
            
            <div class="h-12 border-b border-[var(--bg-tertiary)] flex items-center px-4 shadow-sm z-20 bg-[var(--bg-primary)] flex-shrink-0">
                
                <button onclick="toggleMobileMenu()" class="md:hidden mr-4 text-[var(--interactive-normal)] hover:text-white focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <i id="channel-icon" class="fas fa-hashtag text-gray-500 text-xl mr-2"></i>
                <span id="channel-name" class="font-bold text-[var(--text-header)] mr-4 truncate">uv√≠t√°n√≠</span>
                <span id="channel-desc" class="text-xs text-[var(--interactive-normal)] truncate hidden md:block">Vesel√© V√°noce!</span>
                <div class="ml-auto flex items-center gap-4 text-[var(--interactive-normal)]">
                    <div class="bg-[var(--bg-tertiary)] px-2 py-1 rounded text-xs flex items-center gap-2 w-32 md:w-48">
                        <input type="text" placeholder="Hledat..." class="bg-transparent text-white focus:outline-none w-full" id="search-input">
                        <i class="fas fa-search text-xs"></i>
                    </div>
                </div>
            </div>
            
            <!-- Content Container -->
            <div id="messages-container" class="flex-1 overflow-y-auto px-0 py-0 custom-scrollbar flex flex-col bg-[#36393f] relative"></div>
        </div>

        <!-- MEMBER LIST -->
        <div class="w-60 bg-[var(--bg-secondary)] hidden lg:flex flex-col p-3 flex-shrink-0 border-l border-[var(--bg-tertiary)] z-20">
            <h3 class="text-xs font-bold text-[#8e9297] uppercase mb-2 px-2">ONLINE ‚Äî 2</h3>
            <div class="flex items-center gap-3 px-2 py-1.5 rounded hover:bg-[var(--bg-primary)] cursor-pointer group">
                <div class="relative">
                    <img src="discord_profilovka.jpg" alt="Jo≈æka" class="w-8 h-8 rounded-full object-cover">
                    <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-[var(--green)] rounded-full border-2 border-[#2f3136]"></div>
                </div>
                <div>
                    <div class="font-bold text-gray-200 text-sm">Jo≈æka</div>
                    <div class="text-xs text-gray-400">Hraje Tetris <span class="text-[var(--pink)]">üß©</span></div>
                </div>
            </div>
            <div class="flex items-center gap-3 px-2 py-1.5 rounded hover:bg-[var(--bg-primary)] cursor-pointer group mt-1">
                <div class="relative">
                    <img src="klarka_profilovka.webp" alt="Kl√°rka" class="w-8 h-8 rounded-full object-cover">
                    <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-[var(--green)] rounded-full border-2 border-[#2f3136]"></div>
                </div>
                <div>
                    <div class="font-bold text-gray-200 text-sm">Kl√°rka</div>
                    <div class="text-xs text-gray-400">Vrchn√≠ Fact-Checker</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODALS ========== -->
    
    <!-- Download Modal -->
    <div id="download-modal" class="fixed inset-0 z-[80] hidden modal-backdrop items-center justify-center p-4">
        <div class="bg-[#36393f] rounded-xl shadow-2xl w-full max-w-md border border-[#202225] overflow-hidden">
            <div class="p-6">
                <div class="text-5xl text-center mb-4">üß≤</div>
                <h3 class="font-bold text-white text-center text-xl mb-2">Stahov√°n√≠</h3>
                <p class="text-gray-300 text-center mb-6" id="download-message"></p>
                <div class="space-y-4">
                    <button onclick="openMagnetLink()" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white py-3 rounded-lg font-bold flex items-center justify-center gap-3">
                        <i class="fas fa-magnet"></i> Otev≈ô√≠t v qBittorrent
                    </button>
                    <button onclick="openGoogleDrive()" class="w-full bg-[#3ba55c] hover:bg-[#2d7d46] text-white py-3 rounded-lg font-bold flex items-center justify-center gap-3">
                        <i class="fab fa-google-drive"></i> Google Drive (z√°lo≈æn√≠)
                    </button>
                    <button onclick="closeModal('download-modal')" class="w-full bg-[#4f545c] hover:bg-[#5d6269] text-white py-3 rounded-lg">Zru≈°it</button>
                </div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 z-[90] hidden modal-backdrop items-center justify-center p-4">
        <div class="bg-[#36393f] rounded-xl shadow-2xl w-full max-w-sm border border-[#202225] overflow-hidden animate-fade-in">
            <div class="bg-[#2f3136] p-4 border-b border-[#202225] flex justify-between items-center">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <i class="fas fa-history text-[#eb459e]"></i> Den√≠ƒçek sledov√°n√≠
                </h3>
                <button onclick="closeModal('history-modal')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-5 space-y-4">
                <input type="hidden" id="history-item-id">

                <div>
                    <label class="block text-[#b9bbbe] text-xs font-bold uppercase mb-2">Stav</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setHistoryStatus('unseen')" id="status-unseen" class="status-btn p-2 rounded border border-gray-600 hover:bg-[#40444b] text-center transition opacity-50">
                            <div class="text-xl mb-1">‚ùå</div>
                            <div class="text-[10px] font-bold text-gray-300">Nevidƒõno</div>
                        </button>
                        <button onclick="setHistoryStatus('watching')" id="status-watching" class="status-btn p-2 rounded border border-gray-600 hover:bg-[#40444b] text-center transition opacity-50">
                            <div class="text-xl mb-1">üëÄ</div>
                            <div class="text-[10px] font-bold text-blue-300">Rozkouk√°no</div>
                        </button>
                        <button onclick="setHistoryStatus('seen')" id="status-seen" class="status-btn p-2 rounded border border-gray-600 hover:bg-[#40444b] text-center transition opacity-50">
                            <div class="text-xl mb-1">‚úÖ</div>
                            <div class="text-[10px] font-bold text-green-400">Vidƒõno</div>
                        </button>
                    </div>
                </div>

                <div id="history-date-wrapper" class="hidden transition-all">
                    <label class="block text-[#b9bbbe] text-xs font-bold uppercase mb-1">Kdy jsme to vidƒõli?</label>
                    <input type="date" id="history-date" class="w-full bg-[#202225] text-white p-2 rounded border border-[#202225] focus:border-[#eb459e] outline-none text-sm">
                </div>

                <div id="history-reaction-wrapper" class="hidden transition-all">
                    <label class="block text-[#b9bbbe] text-xs font-bold uppercase mb-1">Tvoje reakce</label>
                    <div class="flex gap-2 mb-2">
                        <button onclick="setReactionInput('‚ù§Ô∏è')" class="flex-1 bg-[#202225] hover:bg-[#2f3136] py-1 rounded text-lg">‚ù§Ô∏è</button>
                        <button onclick="setReactionInput('üòÇ')" class="flex-1 bg-[#202225] hover:bg-[#2f3136] py-1 rounded text-lg">üòÇ</button>
                        <button onclick="setReactionInput('üò≠')" class="flex-1 bg-[#202225] hover:bg-[#2f3136] py-1 rounded text-lg">üò≠</button>
                        <button onclick="setReactionInput('ü§Ø')" class="flex-1 bg-[#202225] hover:bg-[#2f3136] py-1 rounded text-lg">ü§Ø</button>
                        <button onclick="setReactionInput('üò¥')" class="flex-1 bg-[#202225] hover:bg-[#2f3136] py-1 rounded text-lg">üò¥</button>
                    </div>
                    <input type="text" id="history-reaction" placeholder="Nebo napi≈° vlastn√≠..." class="w-full bg-[#202225] text-white p-2 rounded border border-[#202225] focus:border-[#eb459e] outline-none text-sm">
                </div>

                <button onclick="saveHistory()" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white py-3 rounded font-bold mt-2 shadow-lg">Ulo≈æit z√°znam</button>
            </div>
        </div>
    </div>

    <div id="gallery-modal" class="fixed inset-0 z-[120] hidden bg-black/95 backdrop-blur-md flex-col items-center justify-center transition-opacity duration-300">
        <button onclick="closeGallery()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-50 p-2">
            <i class="fas fa-times text-3xl"></i>
        </button>

        <div class="relative w-full h-full flex items-center justify-center p-4 md:p-10">
            
            <button onclick="changeGalleryImage(-1)" class="absolute left-2 md:left-8 text-white hover:text-[#5865F2] transition p-4 z-50 bg-black/50 hover:bg-black/80 rounded-full">
                <i class="fas fa-chevron-left text-2xl md:text-4xl"></i>
            </button>

            <div class="max-w-5xl max-h-full flex flex-col items-center">
                <img id="gallery-image" src="" class="max-h-[80vh] max-w-full object-contain rounded-lg shadow-2xl border border-[#2f3136] animate-fade-in">
                <div class="mt-4 text-center">
                    <h3 id="gallery-title" class="text-white font-bold text-xl mb-1">N√°zev</h3>
                    <p id="gallery-counter" class="text-gray-400 text-sm">1 / 5</p>
                </div>
            </div>

            <button onclick="changeGalleryImage(1)" class="absolute right-2 md:right-8 text-white hover:text-[#5865F2] transition p-4 z-50 bg-black/50 hover:bg-black/80 rounded-full">
                <i class="fas fa-chevron-right text-2xl md:text-4xl"></i>
            </button>
        </div>
    </div>

    <!-- Confession Terminal -->
    <div id="confession-modal" class="fixed inset-0 z-[90] hidden items-center justify-center bg-transparent backdrop-blur-sm">
        <div class="cmd-window w-full max-w-3xl rounded-none border border-[#444] cursor-text" onclick="document.getElementById('hidden-input').focus()">
            <input type="text" id="hidden-input" class="opacity-0 absolute" style="top: -1000px">
            <div class="cmd-header">
                <div class="flex items-center gap-2"><i class="fas fa-terminal text-[10px]"></i><span>Administrator: C:\Windows\System32\cmd.exe</span></div>
                <div class="flex gap-2"><div class="w-3 h-3 bg-gray-400"></div><div class="w-3 h-3 bg-gray-400"></div><div class="w-3 h-3 bg-red-500 cursor-pointer" onclick="closeModal('confession-modal')"></div></div>
            </div>
            <div class="cmd-body" id="terminal-body"><div id="terminal-output"></div><div class="flex"><span id="prompt-text">C:\Kl√°rka\Heart&gt;</span><span id="typing-area" class="ml-2"></span><span id="cmd-cursor" class="cmd-cursor ml-1"></span></div></div>
        </div>
    </div>

    <!-- Final Confession UI -->
    <div id="final-confession-modal" class="fixed inset-0 z-[100] hidden modal-backdrop items-center justify-center p-4">
        <div class="bg-[#36393f] rounded-xl shadow-2xl w-full max-w-md border border-[#5865F2] overflow-hidden relative animate-fade-in" id="final-modal-box">
            <button onclick="closeModal('final-confession-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <div class="p-8 text-center" id="final-modal-content">
                <div id="typing-container" class="text-gray-300 mb-8 text-left space-y-4 leading-relaxed min-h-[200px] mt-8"></div>
                <div id="confession-buttons" class="space-y-3 hidden">
                    <button onclick="responseYes()" class="w-full bg-gradient-to-r from-[#eb459e] to-[#5865F2] hover:opacity-90 text-white py-4 rounded-lg font-bold text-lg transition shadow-lg">Ano, pojƒème to zkusit <i class="fas fa-heart ml-2"></i></button>
                    <button onclick="responseNo()" class="w-full bg-[#4f545c] hover:bg-[#5d6269] text-white py-3 rounded-lg transition">Z≈Østa≈àme kamar√°di</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Redirect Prompt Modal -->
    <div id="redirect-modal" class="fixed inset-0 z-[110] hidden modal-backdrop items-center justify-center p-4">
        <div class="bg-[#36393f] rounded-xl shadow-2xl w-full max-w-sm border border-[#202225] p-6 text-center">
            <div class="text-4xl mb-3 text-[#3ba55c]"><i class="fas fa-check-circle"></i></div>
            <h3 class="text-xl font-bold text-white mb-2">Pozv√°nka odesl√°na!</h3>
            <p class="text-gray-300 mb-6 text-sm">Syst√©m zaznamenal rande do kalend√°≈ôe. U≈æijte si to!</p>
            <button onclick="closeModal('redirect-modal')" class="bg-[#5865F2] hover:bg-[#4752c4] text-white py-2 px-6 rounded font-bold text-sm">Super!</button>
        </div>
    </div>

    <!-- Watchlist Modal -->
    <div id="watchlist-modal" class="fixed inset-0 z-[80] hidden modal-backdrop items-center justify-center p-4">
        <div class="bg-[#36393f] rounded-xl shadow-2xl w-full max-w-md border border-[#202225] overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-[#202225] flex justify-between items-center bg-[#2f3136]">
                <h3 class="font-bold text-white"><i class="fas fa-bookmark text-[var(--pink)] mr-2"></i> Tv≈Øj Watchlist (<span id="watchlist-total">0</span>)</h3>
                <button onclick="closeModal('watchlist-modal')" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="watchlist-items" class="p-4 overflow-y-auto flex-1 custom-scrollbar"></div>
            <div class="p-4 border-t border-[#202225] bg-[#2f3136] flex gap-2">
                <button onclick="exportWatchlist()" class="flex-1 bg-[#5865F2] hover:bg-[#4752c4] text-white py-2 rounded text-xs font-bold transition"><i class="fas fa-share-alt mr-1"></i> Export</button>
                <button onclick="clearWatchlist()" class="flex-1 bg-[#ed4245] hover:bg-[#c03537] text-white py-2 rounded text-xs font-bold transition"><i class="fas fa-trash mr-1"></i> Vyƒçistit</button>
            </div>
        </div>
    </div>

    <div id="user-popout" class="user-popout">
        <div class="popout-banner"></div>
        <img src="klarka_profilovka.webp" class="popout-avatar object-cover">
        <div class="popout-badges text-xl">üèÜ ü¶â</div>
        <div class="pt-12 pb-4 px-4">
            <h3 class="text-white font-bold text-lg">Kl√°rka</h3>
            <p class="text-gray-400 text-xs border-b border-gray-700 pb-3">#1337 ‚Ä¢ Vrchn√≠ Fact-Checker</p>
            
            <div class="mt-3">
                <h4 class="text-xs font-bold text-gray-300 uppercase mb-1">BIO</h4>
                    <p class="text-gray-400 text-sm">
                        üìç Vƒõ≈ô√≠, ≈æe Podol√≠ je skuteƒçn√© m√≠sto.<br>
                        ü¶â Spiritu√°ln√≠ zv√≠≈ôe: Sova (proto≈æe ponocuje).<br>
                        üî• P≈ôe≈æila se mnou Hody i po≈æ√°r v Pole≈°ovic√≠ch.<br>
                        <span class="text-[#eb459e] font-bold">Status:</span> Vrchn√≠ navig√°tor (obƒças).
                    </p>
            </div>
        </div>
    </div>

    <script>
        function triggerHaptic(type = 'light') {
            // Haptika funguje hlavnƒõ na Androidu v Chrome/Samsung Internet
            if (!navigator.vibrate) return;
            
            if (type === 'light') navigator.vibrate(5); // Jemn√© ≈•uknut√≠
            else if (type === 'medium') navigator.vibrate(15); // Potvrzen√≠
            else if (type === 'heavy') navigator.vibrate(30); // Chyba/D≈Øle≈æit√©
            else if (type === 'success') navigator.vibrate([10, 30, 10]); // Dvojit√©
        }

        // --- BOTTOM SHEET LOGIC (Snap Points) ---
        let sheetState = {
            startY: 0,
            currentY: 0,
            isDragging: false,
            panelHeight: 0,
            startTime: 0
        };

        function initBottomSheetGestures() {
            const panel = document.getElementById('detail-panel');
            const handle = document.getElementById('sheet-handle');
            
            if (!panel || !handle) return;

            // Dotyk zaƒçal
            handle.addEventListener('touchstart', (e) => {
                sheetState.isDragging = true;
                sheetState.startY = e.touches[0].clientY;
                // Z√≠sk√°me aktu√°ln√≠ transform hodnotu (pokud nƒõjak√° je)
                const style = window.getComputedStyle(panel);
                const matrix = new WebKitCSSMatrix(style.transform);
                sheetState.currentY = matrix.m42;
                sheetState.panelHeight = panel.offsetHeight;
                sheetState.startTime = Date.now();
                
                // Vypneme animace pro okam≈æitou reakci na prst
                panel.classList.remove('sheet-transition');
            }, { passive: false });

            // Dotyk se h√Ωbe
            document.addEventListener('touchmove', (e) => {
                if (!sheetState.isDragging) return;
                
                const deltaY = e.touches[0].clientY - sheetState.startY;
                let newY = sheetState.currentY + deltaY;

                // Omezen√≠ (nem≈Ø≈æeme t√°hnout v√Ω≈° ne≈æ top obrazovky)
                if (newY < 0) newY = 0; // Top stop

                panel.style.transform = `translateY(${newY}px)`;
                
                // Zabr√°n√≠me scrollov√°n√≠ str√°nky na pozad√≠
                if(e.cancelable) e.preventDefault();
            }, { passive: false });

            // Dotyk skonƒçil - Snap Logic
            document.addEventListener('touchend', (e) => {
                if (!sheetState.isDragging) return;
                sheetState.isDragging = false;
                
                // Zapneme zpƒõt animaci pro hladk√© dojet√≠
                panel.classList.add('sheet-transition');
                panel.style.transform = ''; // Vyƒçist√≠me inline style, pou≈æijeme t≈ô√≠dy nebo JS logiku

                const endY = e.changedTouches[0].clientY;
                const deltaY = endY - sheetState.startY;
                const time = Date.now() - sheetState.startTime;
                const velocity = Math.abs(deltaY / time);
                const windowHeight = window.innerHeight;

                // Kde se prst pustil? (Relativnƒõ k oknu)
                const releasePoint = endY;

                // --- SNAP POINT LOGIC ---
                // Definice bod≈Ø (v pixelech od shora)
                const pointFull = windowHeight * 0.1; // 90% v√Ω≈°ky panelu (10% odshora)
                const pointHalf = windowHeight * 0.5; // 50% v√Ω≈°ky
                const pointClosed = windowHeight;     // Zav≈ôeno

                // Rychl√Ω ≈°vih (Swipe)
                if (velocity > 0.5) {
                    if (deltaY > 0) {
                        // ≈†vih dol≈Ø -> Zav≈ô√≠t
                        closeDetailPanel();
                    } else {
                        // ≈†vih nahoru -> Fullscreen
                        setPanelPosition('full');
                    }
                } else {
                    // Pomal√© ta≈æen√≠ -> Naj√≠t nejbli≈æ≈°√≠ bod
                    if (releasePoint < windowHeight * 0.35) {
                        setPanelPosition('full');
                    } else if (releasePoint > windowHeight * 0.75) {
                        closeDetailPanel();
                    } else {
                        setPanelPosition('half');
                    }
                }
            });
        }

        function setPanelPosition(mode) {
            const panel = document.getElementById('detail-panel');
            const content = document.getElementById('detail-content'); // Obsahov√° ƒç√°st
            const handle = document.getElementById('sheet-handle');    // Horn√≠ li≈°ta pro ta≈æen√≠
            
            if(!panel || !content) return;
            
            // Zapneme animaci
            panel.style.transition = 'transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1)';
            
            // Z√≠sk√°me rozmƒõry
            const panelTotalHeight = panel.offsetHeight; // Celkov√° fyzick√° v√Ω≈°ka panelu (85vh)
            const windowH = window.innerHeight;

            if (mode === 'full') {
                // FULL: Panel vyjede √∫plnƒõ nahoru
                panel.style.transform = `translateY(0px)`;
                
            } else if (mode === 'half') {
                // --- UPRAVEN√Å LOGIKA (Desktop vs Mobil) ---
                
                // 1. DESKTOP (≈°√≠≈ôka nad 768px):
                // Na PC chceme panel zobrazit norm√°lnƒõ (translateY 0),
                // proto≈æe jsme v CSS nastavili 'height: auto', tak≈æe se v√Ω≈°ka p≈ôizp≈Øsob√≠ obsahu sama.
                if (window.innerWidth > 768) {
                    panel.style.transform = `translateY(0px)`;
                } 
                // 2. MOBIL:
                // Tady mus√≠me poƒç√≠tat posun (translateY), proto≈æe panel m√° fixn√≠ v√Ω≈°ku (85vh)
                // a my ho chceme vysunout jen kousek.
                else {
                    const handleHeight = handle ? handle.offsetHeight : 40;
                    const realContentHeight = content.scrollHeight + handleHeight + 20; // +20px rezerva
                    
                    // Stanov√≠me maxim√°ln√≠ povolenou v√Ω≈°ku (nap≈ô. 55 % obrazovky)
                    const maxAllowedHeight = windowH * 0.55;
                    
                    // Vybereme to men≈°√≠ ƒç√≠slo (buƒè podle obsahu, nebo max povolenou v√Ω≈°ku)
                    const targetVisibleHeight = Math.min(realContentHeight, maxAllowedHeight);
                    
                    // V√Ωpoƒçet posunu: Celkov√° v√Ω≈°ka panelu m√≠nus to, co chceme vidƒõt
                    let translation = panelTotalHeight - targetVisibleHeight;
                    
                    // Aplikace posunu
                    panel.style.transform = `translateY(${Math.max(0, translation)}px)`;
                }
                
            } else {
                // CLOSE: Schovat dol≈Ø
                panel.style.transform = `translateY(100%)`;
            }
            
            triggerHaptic('light');
        }
        
        // Upraven√° funkce selectLocation pro inicializaci na "Half" snap
        // Tuto funkci mus√≠≈° zavolat uvnit≈ô sv√© existuj√≠c√≠ selectLocation na konci
        function snapToHalf() {
             const panel = document.getElementById('detail-panel');
             if(panel) {
                 panel.classList.add('sheet-transition');
                 setPanelPosition('half');
             }
        }

        // --- SIDEBAR SWIPE GESTURES ---
        // --- GESTURES STATE FLAGS ---
        let isSidebarGesturesInit = false;
        // Pozn√°mka: BottomSheet se inicializuje poka≈æd√© znovu, proto≈æe jeho DOM se ma≈æe,
        // ale Sidebar je v DOMu trvale, ten nesm√≠me inicializovat v√≠ckr√°t!

        function initSidebarGestures() {
            if (isSidebarGesturesInit) return; // U≈Ω Bƒö≈Ω√ç -> STOP
            
            let touchStartX = 0;
            const triggerZone = 40; 
            
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });

            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const diff = touchEndX - touchStartX;
                const sidebar = document.getElementById('sidebar-wrapper');
                const overlay = document.getElementById('mobile-overlay');

                // Swipe Doprava
                if (diff > 80 && touchStartX < triggerZone) {
                    if (sidebar && sidebar.classList.contains('-translate-x-full')) {
                        sidebar.classList.remove('-translate-x-full');
                        if(overlay) overlay.classList.remove('hidden');
                        triggerHaptic('medium');
                    }
                }

                // Swipe Doleva
                if (diff < -80) {
                    if (sidebar && !sidebar.classList.contains('-translate-x-full')) {
                        sidebar.classList.add('-translate-x-full');
                        if(overlay) overlay.classList.add('hidden');
                        triggerHaptic('light');
                    }
                }
            });

            isSidebarGesturesInit = true; // Znaƒçka: Hotovo
            console.log("Sidebar gestures initialized.");
        }

        // Pomocn√° funkce na odstranƒõn√≠ diakritiky (aby "ƒçaj" na≈°el "caj")
        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        // --- SMART SEARCH LOGIC ---
        
        function expandSearchQuery(query) {
            const normQuery = normalizeText(query);
            let terms = [normQuery];
            
            // Projdi synonyma a pokud najde≈° shodu, p≈ôidej kl√≠ƒçovou kategorii
            for (const [category, words] of Object.entries(searchSynonyms)) {
                if (words.some(w => normalizeText(w).includes(normQuery)) || category.includes(normQuery)) {
                    terms.push(category);
                }
            }
            return terms;
        }

        function highlightText(text, query) {
            if (!query) return text;
            const normText = normalizeText(text);
            const normQuery = normalizeText(query);
            
            // Jednoduch√Ω highlight - najde index a obal√≠ origin√°ln√≠ text
            const index = normText.indexOf(normQuery);
            if (index >= 0) {
                const originalPart = text.substring(index, index + query.length);
                return text.substring(0, index) + 
                       `<span class="bg-[#faa61a] text-black font-bold px-0.5 rounded">${originalPart}</span>` + 
                       text.substring(index + query.length);
            }
            return text;
        }

        function renderGlobalSearch(rawValue) {
            const container = document.getElementById('messages-container');
            const query = rawValue.trim();
            
            if (!query) {
                // Pokud sma≈æe≈° hled√°n√≠, vra≈• se na aktu√°ln√≠ kan√°l
                switchChannel(state.currentChannel); 
                return;
            }

            const terms = expandSearchQuery(query); // Roz≈°√≠≈ô√≠me o synonyma
            const searchRegex = new RegExp(terms.join('|'), 'i'); // Regex pro hled√°n√≠
            const normalize = (str) => normalizeText(str || '');

            // 1. HLED√ÅN√ç V KAN√ÅLECH
            const channels = [
                { id: 'welcome', name: 'Uv√≠t√°n√≠', icon: 'fa-door-open' },
                { id: 'timeline', name: 'Timeline', icon: 'fa-history' },
                { id: 'dateplanner', name: 'Pl√°novaƒç rande', icon: 'fa-map-marked-alt' },
                { id: 'movies', name: 'Filmy', icon: 'fa-film' },
                { id: 'series', name: 'Seri√°ly', icon: 'fa-tv' },
                { id: 'games', name: 'Hry', icon: 'fa-gamepad' }
            ];
            const foundChannels = channels.filter(c => terms.some(t => normalize(c.name).includes(t)));

            // 2. HLED√ÅN√ç V KNIHOVNƒö (Filmy, Hry...)
            let foundLibrary = [];
            Object.keys(library).forEach(cat => {
                library[cat].forEach(item => {
                    // Hled√°me v n√°zvu, kategorii a synonymech kategorie
                    if (terms.some(t => normalize(item.title).includes(t) || normalize(item.cat).includes(t))) {
                        foundLibrary.push({ ...item, type: cat }); // P≈ôid√°me typ pro rozli≈°en√≠
                    }
                });
            });

            // 3. HLED√ÅN√ç V M√çSTECH (Date Planner)
            const foundPlaces = dateLocations.filter(loc => 
                terms.some(t => normalize(loc.name).includes(t) || normalize(loc.desc).includes(t) || normalize(loc.cat).includes(t))
            );


            // --- VYKRESLEN√ç V√ùSLEDK≈Æ ---
            let html = `<div class="p-6 max-w-5xl mx-auto space-y-8 animate-fade-in">`;
            
            html += `<h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">
                        üîç V√Ωsledky pro: <span class="text-[#5865F2]">"${query}"</span>
                     </h2>`;

            if (foundChannels.length === 0 && foundLibrary.length === 0 && foundPlaces.length === 0) {
                html += `<div class="text-center text-gray-500 py-10 text-lg">Nic jsme nena≈°li... zkus jin√© slovo (t≈ôeba "hlad" nebo "les") ü§∑‚Äç‚ôÇÔ∏è</div>`;
            }

            // A) KAN√ÅLY
            if (foundChannels.length > 0) {
                html += `<div><h3 class="text-gray-400 font-bold uppercase text-xs mb-3">Kan√°ly</h3><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">`;
                foundChannels.forEach(c => {
                    html += `
                        <div onclick="switchChannel('${c.id}')" class="bg-[#2f3136] p-3 rounded flex items-center gap-3 cursor-pointer hover:bg-[#40444b] border border-[#202225] hover:border-[#5865F2] transition">
                            <div class="w-8 h-8 rounded-full bg-[#202225] flex items-center justify-center text-[#b9bbbe]"><i class="fas ${c.icon}"></i></div>
                            <span class="font-bold text-gray-200">${highlightText(c.name, query)}</span>
                        </div>`;
                });
                html += `</div></div>`;
            }

            // B) M√çSTA (DATE PLANNER)
            if (foundPlaces.length > 0) {
                html += `<div><h3 class="text-gray-400 font-bold uppercase text-xs mb-3">M√≠sta na rande</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">`;
                foundPlaces.forEach(loc => {
                    // Trik: switchChannel na planner a pak selectLocation
                    html += `
                        <div onclick="switchChannel('dateplanner'); setTimeout(() => selectLocation(${loc.id}), 100);" class="bg-[#2f3136] p-3 rounded flex gap-3 cursor-pointer hover:bg-[#40444b] border border-[#202225] hover:border-[#3ba55c] transition group">
                            <div class="text-2xl pt-1">${loc.cat === 'food' ? 'üçî' : (loc.cat === 'view' ? 'üî≠' : 'üìç')}</div>
                            <div>
                                <div class="font-bold text-white group-hover:underline">${highlightText(loc.name, query)}</div>
                                <div class="text-xs text-gray-400">${highlightText(loc.desc, query)}</div>
                            </div>
                        </div>`;
                });
                html += `</div></div>`;
            }

            // C) KNIHOVNA (FILMY, HRY)
            if (foundLibrary.length > 0) {
                html += `<div><h3 class="text-gray-400 font-bold uppercase text-xs mb-3">Knihovna</h3><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">`;
                foundLibrary.forEach(item => {
                    html += `
                        <div onclick="switchChannel('${item.type === 'games' ? 'games' : (item.type === 'series' ? 'series' : 'movies')}')" class="bg-[#2f3136] rounded p-2 hover:bg-[#40444b] transition cursor-pointer border border-[#202225] hover:border-[#faa61a] flex flex-col items-center text-center">
                            <div class="text-4xl mb-2">${item.icon}</div>
                            <div class="font-bold text-white text-xs">${highlightText(item.title, query)}</div>
                            <div class="text-[10px] text-gray-500 mt-1">${item.cat}</div>
                        </div>`;
                });
                html += `</div></div>`;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        function triggerConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

            function randomInOut(min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                
                // Konfety padaj√≠ n√°hodnƒõ ze dvou stran
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
            
            showNotification("üéâ L√ÅSKA DETEKOV√ÅNA! üéâ", "success");
        }


        // --- GLOBAL STATE ---
        const state = {
            currentChannel: 'welcome',
            currentDownload: null,
            dateFilter: 'all',
            mapInstance: null, 
            quizAnswers: JSON.parse(localStorage.getItem('klarka_quiz')) || { score: 0, completed: false },
            watchlist: JSON.parse(localStorage.getItem('klarka_watchlist')) || [],
            route: [],
            ratings: JSON.parse(localStorage.getItem('klarka_ratings')) || {},
            dateRatings: JSON.parse(localStorage.getItem('klarka_date_ratings')) || {},
            watchHistory: JSON.parse(localStorage.getItem('klarka_watch_history')) || {}
        };

        const GLOBAL_DRIVE_LINK = "https://drive.google.com/drive/folders/19KnBcai5wHxwlryX_keLO9zPs8Qvj48l?usp=sharing";

        // DATA
        const quizQuestions = [
            { question: "Jsem certifikovan√Ω skaut, kter√Ω bezpeƒçnƒõ pozn√° v≈°echny hvƒõzdy na obloze.", correct: false, explanation: "M√ùTUS! ‚ùå Pozn√°m jen 'vrtuln√≠ky'. Sirius si to bude pamatovat nav≈ædy." },
            { question: "Kdy≈æ se uƒç√≠me matematiku, jsem to j√°, kdo vysvƒõtluje integr√°ly tobƒõ.", correct: false, explanation: "M√ùTUS! ‚ùå Jsem ztracen√Ω p≈ô√≠pad. D√≠ky za tvou nekoneƒçnou trpƒõlivost." },
            { question: "Nejlep≈°√≠ investice tv√©ho ≈æivota byla Casio kalkulaƒçka.", correct: true, explanation: "FAKT! ‚úÖ Proto m√°≈° teƒè i tu ply≈°ovou verzi." },
            { question: "Tv√© zranƒõn√≠ nohy vzniklo p≈ôi extr√©mn√≠m sportu zvan√©m 'sezen√≠ u poƒç√≠taƒçe'.", correct: true, explanation: "FAKT! ‚úÖ A sprcha tomu dala korunu. Nebezpeƒçn√Ω ≈æivot geeka." },
            { question: "Podol√≠ je samostatn√°, hrd√° metropole, kter√° nem√° s Kunovicemi nic spoleƒçn√©ho.", correct: false, explanation: "M√ùTUS! ‚ùå Je to jen p≈ôedmƒõst√≠, smi≈ô se s t√≠m. üòâ" },
            { question: "M≈Øj orientaƒçn√≠ smysl v Geoguessru je na √∫rovni profesion√°ln√≠ho kartografa.", correct: false, explanation: "M√ùTUS! ‚ùå V≈°echno je pro mƒõ Braz√≠lie nebo Rusko." },
            { question: "Kdy≈æ ≈ô√≠d√≠≈°, vypad√°≈° podle mƒõ jako bys jela 'opil√° a bez svƒõtel'.", correct: true, explanation: "FAKT! ‚úÖ Ale je to jen vtip! (Vƒõt≈°inou). V≈ædycky dojedeme." },
            { question: "Pes, kter√©ho jsme potkali na v√Ωletƒõ, byl vycviƒçen√Ω z√°chran√°≈ô.", correct: false, explanation: "M√ùTUS! ‚ùå Byl to vycviƒçen√Ω zlodƒõj ≈°pek√°ƒçk≈Ø." },
            { question: "Chobotnice je tv√© spiritu√°ln√≠ zv√≠≈ôe.", correct: true, explanation: "FAKT! ‚úÖ Nebo sova. Oboj√≠ sed√≠ perfektnƒõ na tv≈Øj multitasking a ponocov√°n√≠." },
            { question: "Popcorn je n√°stroj ƒè√°bla urƒçen√Ω k niƒçen√≠ zub≈Ø.", correct: true, explanation: "FAKT! ‚úÖ Gum√≠dci jsou superior snack." },
            { question: "Nero hr√°l na lyru, kdy≈æ ho≈ôel ≈ò√≠m.", correct: false, explanation: "M√ùTUS! ‚ùå D√≠ky za lekci dƒõjepisu, pan√≠ uƒçitelko. U≈æ si to pamatuju." }
        ];

        // --- DATA: ZAJ√çMAVOSTI O SOV√ÅCH A CHOBOTNIC√çCH ---
        const animalFacts = [
            // CHOBOTNICE üêô
            { icon: "üêô", text: "Chobotnice maj√≠ t≈ôi srdce: dvƒõ ≈æabern√≠ pumpuj√≠ krev p≈ôes ≈æ√°bry k okysliƒçen√≠ a jedno hlavn√≠ ji rozv√°d√≠ do zbytku tƒõla." },
            { icon: "üêô", text: "Krev chobotnice je modr√°, proto≈æe obsahuje hemocyanin zalo≈æen√Ω na mƒõdi, kter√Ω je v chladn√Ωch vod√°ch efektivnƒõj≈°√≠ ne≈æ ≈æelezo." },
            { icon: "üêô", text: "Chobotnice maj√≠ jeden centr√°ln√≠ mozek, ale dvƒõ t≈ôetiny v≈°ech neuron≈Ø jsou rozm√≠stƒõny v chapadlech, tak≈æe ka≈æd√© rameno m√° ƒç√°steƒçnƒõ vlastn√≠ ‚Äûmysl‚Äú." },
            { icon: "üêô", text: "Chobotnice nemaj√≠ kosti, jedinou pevnou ƒç√°st√≠ je zob√°k z keratinu, tak≈æe se prot√°hnou jak√Ωmkoliv otvorem, kter√Ωm projde tento zob√°k." },
            { icon: "üêô", text: "Ka≈æd√© z osmi ramen chobotnice m√° a≈æ 240 p≈ô√≠savek s chemoreceptory, d√≠ky kter√Ωm chobotnice ‚Äûochutn√°v√°‚Äú v≈°e, ƒçeho se dotkne." },
            { icon: "üêô", text: "Oƒçi chobotnice jsou velmi podobn√© lidsk√Ωm, ale jsou barvoslep√©; paradoxnƒõ v≈°ak k≈Ø≈æe chobotnice obsahuje svƒõtlocitliv√© proteiny a dok√°≈æe ‚Äûvidƒõt‚Äú svƒõtlo." },
            { icon: "üêô", text: "Chobotnice d√Ωchaj√≠ ≈æ√°brami, ale dok√°≈æou kr√°tce p≈ôe≈æ√≠t na sou≈°i d√≠ky absorpci kysl√≠ku vlhkou k≈Ø≈æ√≠." },
            { icon: "üêô", text: "Kdy≈æ chobotnice plave pomoc√≠ reaktivn√≠ho pohonu, jej√≠ hlavn√≠ srdce se zastav√≠, co≈æ ji vyƒçerp√°v√°, a proto se radƒõji plaz√≠ po dnƒõ." },
            { icon: "üêô", text: "Chobotnice maj√≠ vysoce vyvinut√Ω smysl pro polohu vlastn√≠ho tƒõla (propriocepci), aƒçkoliv je tƒõlo chobotnice mƒõkk√© a flexibiln√≠." },
            { icon: "üêô", text: "Chobotnice jsou pova≈æov√°ny za nejinteligentnƒõj≈°√≠ bezobratl√© ≈æivoƒçichy na Zemi." },
            { icon: "üêô", text: "Chobotnice kokosov√° byla pozorov√°na, jak nos√≠ sko≈ô√°pky kokosov√Ωch o≈ôech≈Ø a pou≈æ√≠v√° je jako mobiln√≠ √∫kryt." },
            { icon: "üêô", text: "Chobotnice dok√°≈æou ≈ôe≈°it slo≈æit√© probl√©my, jako je otev≈ôen√≠ ≈°roubovac√≠ sklenice zevnit≈ô nebo pr≈Øchod bludi≈°tƒõm." },
            { icon: "üêô", text: "Chobotnice maj√≠ schopnost uƒçen√≠ se pozorov√°n√≠m a disponuj√≠ kr√°tkodobou i dlouhodobou pamƒõt√≠." },
            { icon: "üêô", text: "U chobotnic bylo pozorov√°no chov√°n√≠ p≈ôipom√≠naj√≠c√≠ hru, nap≈ô√≠klad opakovan√© pos√≠l√°n√≠ p≈ôedmƒõt≈Ø proudem vody." },
            { icon: "üêô", text: "V zajet√≠ dok√°≈æou chobotnice rozeznat lidsk√© tv√°≈ôe a k r≈Øzn√Ωm o≈°et≈ôovatel≈Øm se chovaj√≠ odli≈°nƒõ." },
            { icon: "üêô", text: "Chobotnice jsou mistrynƒõmi √∫niku, dok√°≈æou vyl√©zt z akv√°ria, proj√≠t potrub√≠m nebo se p≈ôesunout po zemi do jin√© n√°dr≈æe pro potravu." },
            { icon: "üêô", text: "Nƒõkter√© druhy chobotnic p≈ôi lovu st≈ô√≠kaj√≠ vodu na kraby na sou≈°i, aby je spl√°chly do mo≈ôe." },
            { icon: "üêô", text: "Chobotnice dok√°≈æou editovat svou vlastn√≠ RNA, co≈æ jim umo≈æ≈àuje p≈ôepisovat genetick√© instrukce a rychle se adaptovat nap≈ô√≠klad na zmƒõnu teploty." },
            { icon: "üêô", text: "Chobotnice zvl√°dnou zmƒõnu barvy cel√©ho tƒõla za m√©nƒõ ne≈æ 0,3 sekundy." },
            { icon: "üêô", text: "K maskov√°n√≠ vyu≈æ√≠vaj√≠ chobotnice t≈ôi vrstvy bunƒõk: chromatofory (barva), iridofory (odlesky) a leukofory (b√≠l√Ω podklad)." },
            { icon: "üêô", text: "Pomoc√≠ sval≈Ø v k≈Ø≈æi dok√°≈æou chobotnice zmƒõnit texturu sv√©ho tƒõla z hladk√© na ostnatou, aby splynuly s okol√≠m." },
            { icon: "üêô", text: "Chobotnice maskovan√° (Thaumoctopus mimicus) dok√°≈æe tvarem i pohybem napodobit jin√© ≈æivoƒçichy, jako jsou perut√Ωni nebo mo≈ô≈°t√≠ hadi." },
            { icon: "üêô", text: "V ohro≈æen√≠ vypou≈°tƒõj√≠ chobotnice inkoust, kter√Ω vytvo≈ô√≠ clonu a z√°rove≈à otup√≠ ƒçich pred√°tora." },
            { icon: "üêô", text: "Zmƒõny barev slou≈æ√≠ chobotnic√≠m i ke komunikaci ‚Äì tmav√° barva ƒçasto znaƒç√≠ agresi, svƒõtl√° strach." },
            { icon: "üêô", text: "V p≈ô√≠padƒõ nouze mohou chobotnice odvrhnout chapadlo, kter√© se d√°l h√Ωbe a l√°k√° pred√°tora; chapadlo chobotnici pozdƒõji doroste." },
            { icon: "üêô", text: "Vƒõt≈°ina druh≈Ø chobotnic ≈æije velmi kr√°tce, obvykle jen 1 a≈æ 2 roky, ob≈ô√≠ druhy maxim√°lnƒõ 5 let." },
            { icon: "üêô", text: "Samci chobotnic maj√≠ speci√°ln√≠ rameno zvan√© hectocotylus, kter√Ωm p≈ôed√°vaj√≠ sperma; u nƒõkter√Ωch druh≈Ø ho samici ‚Äûodevzdaj√≠‚Äú a odplavou." },
            { icon: "üêô", text: "Rozmno≈æov√°n√≠ je pro chobotnice smrteln√© ‚Äì samci um√≠raj√≠ brzy po p√°≈ôen√≠, samice po vyl√≠hnut√≠ vaj√≠ƒçek." },
            { icon: "üêô", text: "Samice chobotnice po nakladen√≠ vaj√≠ƒçek p≈ôestane j√≠st a po celou dobu inkubace je chr√°n√≠ a ov√≠v√°, nakonec um√≠r√° vyƒçerp√°n√≠m." },
            { icon: "üêô", text: "Ml√°ƒèata chobotnic rostou extr√©mnƒõ rychle, nƒõkter√© druhy mohou zv√Ω≈°it svou v√°hu o 5 % ka≈æd√Ω den." },
            { icon: "üêô", text: "Nejvƒõt≈°√≠ chobotnice velk√° m≈Ø≈æe m√≠t rozpƒõt√≠ ramen a≈æ 9 metr≈Ø a v√°≈æit p≈ôes 270 kg." },
            { icon: "üêô", text: "Nejmen≈°√≠ druh chobotnice Octopus wolfi mƒõ≈ô√≠ jen asi 2,5 cm a v√°≈æ√≠ m√©nƒõ ne≈æ gram." },
            { icon: "üêô", text: "V≈°echny chobotnice jsou jedovat√©, ale pro ƒçlovƒõka je nebezpeƒçn√° jen jedna skupina." },
            { icon: "üêô", text: "Mal√° chobotnice krou≈ækovan√° nese dostatek jedu tetrodotoxinu k usmrcen√≠ 26 dospƒõl√Ωch lid√≠ a neexistuje na nƒõj protijed." },
            { icon: "üêô", text: "Chobotnice Dumbo ≈æije v hloubk√°ch a≈æ 4 000 metr≈Ø a m√° ploutve p≈ôipom√≠naj√≠c√≠ slon√≠ u≈°i." },
            { icon: "üêô", text: "Samice chobotnic rodu Argonauta si vytv√°≈ôej√≠ vlastn√≠ v√°pencovou schr√°nku pro ochranu vaj√≠ƒçek." },
            { icon: "üêô", text: "Chobotnice jsou na Zemi d√©le ne≈æ dinosau≈ôi, nejstar≈°√≠ fosilie p≈ôedka chobotnice je star√° asi 296 milion≈Ø let." },
            { icon: "üêô", text: "V roce 2010 se proslavila chobotnice Paul, kter√° √∫dajnƒõ √∫spƒõ≈°nƒõ p≈ôedpov√≠dala v√Ωsledky fotbalov√©ho mistrovstv√≠ svƒõta." },
            { icon: "üêô", text: "V mytologii a kultu≈ôe jsou chobotnice ƒçasto zobrazov√°ny jako monstra, nap≈ô√≠klad Kraken." },
            { icon: "üêô", text: "Ve stresov√Ωch situac√≠ch nebo p≈ôi p≈ôemno≈æen√≠ se chobotnice mohou uchylovat ke kanibalismu." },
            { icon: "üêô", text: "Genom chobotnice je velmi slo≈æit√Ω a obsahuje unik√°tn√≠ genov√© rodiny, kter√© se u jin√Ωch ≈æivoƒçich≈Ø nevyskytuj√≠." },

            // SOVY ü¶â
            { icon: "ü¶â", text: "Sovy nemaj√≠ klasick√© oƒçn√≠ bulvy, ale prot√°hl√© oƒçn√≠ trubice pevnƒõ ukotven√© v lebce, tak≈æe nemohou h√Ωbat oƒçima." },
            { icon: "ü¶â", text: "Kv≈Øli nepohybliv√Ωm oƒç√≠m musej√≠ sovy ot√°ƒçet celou hlavou, co≈æ zvl√°dnou a≈æ o 270 stup≈à≈Ø." },
            { icon: "ü¶â", text: "Krk sovy obsahuje 14 krƒçn√≠ch obratl≈Ø, co≈æ je dvakr√°t v√≠ce, ne≈æ maj√≠ lid√©, a umo≈æ≈àuje to extr√©mn√≠ rotaci hlavy." },
            { icon: "ü¶â", text: "Sovy maj√≠ speci√°ln√≠ syst√©m krevn√≠ho z√°soben√≠, kter√Ω zabra≈àuje p≈ôeru≈°en√≠ toku krve do mozku p≈ôi ot√°ƒçen√≠ hlavy." },
            { icon: "ü¶â", text: "Sluch sovy je tak dokonal√Ω, ≈æe nƒõkter√© druhy dok√°≈æou lokalizovat ko≈ôist v naprost√© tmƒõ pouze podle zvuku." },
            { icon: "ü¶â", text: "Nƒõkter√© sovy, jako kalous u≈°at√Ω, maj√≠ asymetrick√© u≈°n√≠ otvory (jeden v√Ω≈° ne≈æ druh√Ω), co≈æ jim pom√°h√° p≈ôesnƒõ zamƒõ≈ôit zdroj zvuku." },
            { icon: "ü¶â", text: "Obliƒçejov√Ω z√°voj sovy, tvo≈ôen√Ω pe≈ô√≠m, funguje jako parabola, kter√° zachycuje zvuky a smƒõruje je p≈ô√≠mo do u≈°√≠." },
            { icon: "ü¶â", text: "Sovy jsou dalekozrak√© a na bl√≠zko vid√≠ ≈°patnƒõ, proto si p≈ôi krmen√≠ pom√°haj√≠ hmatov√Ωmi ≈°tƒõtinami kolem zob√°ku." },
            { icon: "ü¶â", text: "Oƒçi sovy jsou chr√°nƒõny t≈ôemi v√≠ƒçky: jedn√≠m na mrk√°n√≠, jedn√≠m na span√≠ a t≈ôet√≠m (m≈æurkou) na ƒçi≈°tƒõn√≠ oka." },
            { icon: "ü¶â", text: "Nohy sovy jsou zygodaktyln√≠, co≈æ znamen√°, ≈æe dva prsty smƒõ≈ôuj√≠ dop≈ôedu a dva dozadu, p≈ôiƒçem≈æ jeden zadn√≠ prst se m≈Ø≈æe otoƒçit dop≈ôedu." },
            { icon: "ü¶â", text: "Let sovy je t√©mƒõ≈ô nesly≈°n√Ω d√≠ky speci√°ln√≠mu h≈ôeb√≠nku na okraji letek, kter√Ω rozb√≠j√≠ proudƒõn√≠ vzduchu." },
            { icon: "ü¶â", text: "Tich√Ω let umo≈æ≈àuje sovƒõ p≈ôekvapit ko≈ôist, kter√° ji nesly≈°√≠ p≈ôil√©tat ani v naprost√©m tichu noci." },
            { icon: "ü¶â", text: "Sovy jsou v√Ωhradnƒõ maso≈ærav√≠ dravci a ≈æiv√≠ se pestrou stravou od hmyzu p≈ôes ryby a≈æ po mal√© savce." },
            { icon: "ü¶â", text: "Proto≈æe sovy nemaj√≠ zuby, polykaj√≠ men≈°√≠ ko≈ôist vcelku." },
            { icon: "ü¶â", text: "Na rozd√≠l od jin√Ωch pt√°k≈Ø sovy nemaj√≠ vole, tak≈æe potrava putuje p≈ô√≠mo do ≈æaludku." },
            { icon: "ü¶â", text: "Nestraviteln√© zbytky, jako jsou kosti a srst, sovy vyvrhuj√≠ ve formƒõ ≈°i≈°at√Ωch v√Ωvr≈æk≈Ø." },
            { icon: "ü¶â", text: "Rozborem v√Ωvr≈æk≈Ø sovy mohou vƒõdci p≈ôesnƒõ urƒçit, ƒç√≠m se dan√° sova v posledn√≠ dobƒõ ≈æivila." },
            { icon: "ü¶â", text: "Nƒõkter√© sovy, nap≈ô√≠klad asijsk√© ketupy, jsou specializovan√© na lov ryb a nohy maj√≠ pokryt√© ostr√Ωmi ≈°upinami, aby jim kluzk√° ko≈ôist nevyklouzla." },
            { icon: "ü¶â", text: "Sova p√°len√° m√° dr√°py se zoubkovan√Ωm okrajem, co≈æ j√≠ pom√°h√° l√©pe uchopit drobn√© hlodavce." },
            { icon: "ü¶â", text: "V√Ωr velk√Ω je jednou z nejsilnƒõj≈°√≠ch sov a troufne si ulovit i li≈°ku nebo srnƒçe." },
            { icon: "ü¶â", text: "Stisk pa≈ô√°t≈Ø sovy je extr√©mnƒõ siln√Ω; nap≈ô√≠klad pu≈°t√≠k obecn√Ω vyvine tlak a≈æ 13 kg na centimetr ƒçtvereƒçn√≠." },
            { icon: "ü¶â", text: "Aƒçkoliv jsou sovy zn√°m√© jako noƒçn√≠ tvorov√©, nƒõkter√© druhy, jako sovice snƒõ≈æn√≠, lov√≠ i ve dne." },
            { icon: "ü¶â", text: "Ne v≈°echny sovy houkaj√≠; nap≈ô√≠klad s√Ωƒçek se oz√Ωv√° pronikav√Ωm p√≠sk√°n√≠m a sova p√°len√° sp√≠≈°e syƒç√≠ a chr√°pe." },
            { icon: "ü¶â", text: "Ml√°ƒèata sov v ohro≈æen√≠ syƒç√≠, ƒç√≠m≈æ se sna≈æ√≠ napodobit zvuk hada a odstra≈°it pred√°tora." },
            { icon: "ü¶â", text: "Sovy komunikuj√≠ tak√© ≈ôeƒç√≠ tƒõla, klap√°n√≠m zob√°ku nebo tlesk√°n√≠m k≈ô√≠dly." },
            { icon: "ü¶â", text: "Vƒõt≈°ina sov ≈æije samot√°≈ôsky, ale sova p√°len√° nƒõkdy tvo≈ô√≠ voln√° spoleƒçenstva na jednom nocovi≈°ti." },
            { icon: "ü¶â", text: "Sovy jsou silnƒõ teritori√°ln√≠ pt√°ci a sv√© √∫zem√≠ si h√°j√≠ hlasit√Ωm vol√°n√≠m." },
            { icon: "ü¶â", text: "Vƒõt≈°ina druh≈Ø sov tvo≈ô√≠ monogamn√≠ p√°ry, kter√© spolu ƒçasto z≈Øst√°vaj√≠ cel√Ω ≈æivot." },
            { icon: "ü¶â", text: "Sovy si nestav√≠ vlastn√≠ hn√≠zda, ale obsazuj√≠ dutiny strom≈Ø, skaln√≠ ≈ô√≠msy nebo star√° hn√≠zda dravc≈Ø." },
            { icon: "ü¶â", text: "S√Ωƒçek kr√°liƒç√≠ je netypick√° sova, kter√° hn√≠zd√≠ v podzemn√≠ch nor√°ch vyhraban√Ωch jin√Ωmi zv√≠≈ôaty." },
            { icon: "ü¶â", text: "Vejce sovy jsou kulat√° a b√≠l√° a zah≈ô√≠v√° je v√Ωhradnƒõ samice, kterou samec krm√≠." },
            { icon: "ü¶â", text: "Proto≈æe sova zaƒç√≠n√° sedƒõt na vejc√≠ch hned po snesen√≠ prvn√≠ho, ml√°ƒèata se l√≠hnou postupnƒõ a jsou r≈Øznƒõ velk√°." },
            { icon: "ü¶â", text: "V dob√°ch nedostatku potravy p≈ôe≈æij√≠ jen nejsilnƒõj≈°√≠ ml√°ƒèata sovy a ƒçasto doch√°z√≠ k sourozeneck√©mu kanibalismu." },
            { icon: "ü¶â", text: "Poƒçet vajec, kter√° sova snese, ƒçasto z√°vis√≠ na mno≈æstv√≠ potravy v dan√©m roce; v dob√°ch p≈ôemno≈æen√≠ hrabo≈°≈Ø to m≈Ø≈æe b√Ωt a≈æ 14 vajec." },
            { icon: "ü¶â", text: "Ml√°ƒèata sovy se rod√≠ slep√° a pokryt√° b√≠l√Ωm prachov√Ωm pe≈ô√≠m." },
            { icon: "ü¶â", text: "Vƒõt≈°ina sov nemigruje, ale sovice snƒõ≈æn√≠ se p≈ôi nedostatku potravy v Arktidƒõ vyd√°v√° na dlouh√© cesty a≈æ do st≈ôedn√≠ Evropy." },
            { icon: "ü¶â", text: "Nejvƒõt≈°√≠ sovou svƒõta je v√Ωr Blakiston≈Øv, kter√Ω m≈Ø≈æe m√≠t rozpƒõt√≠ k≈ô√≠del a≈æ dva metry." },
            { icon: "ü¶â", text: "Jednou z nejmen≈°√≠ch sov je kul√≠≈°ek trpasliƒç√≠, kter√Ω v√°≈æ√≠ m√©nƒõ ne≈æ golfov√Ω m√≠ƒçek." },
            { icon: "ü¶â", text: "Sovice snƒõ≈æn√≠ m√° pe≈ô√≠ b√≠l√© barvy, kter√© j√≠ umo≈æ≈àuje dokonale splynout s arktick√Ωm snƒõhem." },
            { icon: "ü¶â", text: "Sova p√°len√° m√° obliƒçejov√Ω z√°voj ve tvaru srdce, co≈æ je pro tento druh typick√©." },
            { icon: "ü¶â", text: "Pu≈°t√≠k vousat√Ω je velk√° sova, kter√© se d√≠ky jej√≠mu tich√©mu letu p≈ôezd√≠v√° ‚Äûp≈ô√≠zraƒçn√Ω l√©taj√≠c√≠ medvƒõd‚Äú." },
            { icon: "ü¶â", text: "Sovy se vyskytuj√≠ na v≈°ech kontinentech svƒõta s v√Ωjimkou Antarktidy." },
            { icon: "ü¶â", text: "V ≈ôeck√© mytologii byla sova posv√°tn√Ωm pt√°kem bohynƒõ Ath√©ny a symbolem moudrosti." },
            { icon: "ü¶â", text: "Ve star√©m ≈ò√≠mƒõ bylo houk√°n√≠ sovy pova≈æov√°no za p≈ôedzvƒõst smrti nebo ne≈°tƒõst√≠." },
            { icon: "ü¶â", text: "V mnoha kultur√°ch jsou sovy spojov√°ny s magi√≠, ƒçarodƒõjnictv√≠m a svƒõtem duch≈Ø." },
            { icon: "ü¶â", text: "V s√©rii Harry Potter slou≈æ√≠ sovy jako po≈°tovn√≠ doruƒçovatel√©, p≈ôiƒçem≈æ nejslavnƒõj≈°√≠ je sova snƒõ≈æn√° jm√©nem Hedvika." },
            { icon: "ü¶â", text: "Sova je obl√≠ben√Ωm motivem v heraldice a ƒçasto se objevuje v mƒõstsk√Ωch znac√≠ch." },
            { icon: "ü¶â", text: "Aƒçkoliv m√° sova povƒõst moudr√©ho zv√≠≈ôete, jej√≠ mozek je pomƒõrnƒõ mal√Ω a v inteligenci ji p≈ôedƒç√≠ krkavcovit√≠ pt√°ci." },
            { icon: "ü¶â", text: "Sovy maj√≠ velmi slab√Ω ƒçich, tak≈æe jim nevad√≠ lovit nap≈ô√≠klad skunky." },
            { icon: "ü¶â", text: "P≈ô√≠tomnost sovy v krajinƒõ je znakem zdrav√©ho ekosyst√©mu." },
            { icon: "ü¶â", text: "S√Ωƒçek obecn√Ω, d≈ô√≠ve bƒõ≈æn√° sova ƒçesk√©ho venkova, je dnes kriticky ohro≈æen√Ω kv≈Øli zmƒõn√°m v zemƒõdƒõlstv√≠." },
            { icon: "ü¶â", text: "Pro ochranu sov ornitologov√© ƒçasto vyvƒõ≈°uj√≠ speci√°ln√≠ budky, kter√© nahrazuj√≠ dut√© stromy." },
            { icon: "ü¶â", text: "Sovy v zajet√≠ se mohou do≈æ√≠t a≈æ 60 let, zat√≠mco v divoƒçinƒõ je jejich ≈æivot v√Ωraznƒõ krat≈°√≠." },
            { icon: "ü¶â", text: "Pe≈ô√≠ sovy ƒçasto p≈ôipom√≠n√° k≈Øru strom≈Ø, co≈æ j√≠ poskytuje dokonal√© maskov√°n√≠ bƒõhem denn√≠ho odpoƒçinku." },
            { icon: "ü¶â", text: "Skupina sov se v angliƒçtinƒõ poeticky naz√Ωv√° ‚Äûparlament‚Äú." },
            { icon: "ü¶â", text: "Aƒçkoliv to nedƒõlaj√≠ r√°dy, sovy dok√°≈æou v p≈ô√≠padƒõ nouze plavat pomoc√≠ k≈ô√≠del." }
        ];

        const funFacts = [
            "Chobotnice maj√≠ t≈ôi srdce a modrou krev.",
            "Sovy mohou otoƒçit hlavu a≈æ o 270 stup≈à≈Ø.",
            "Prvn√≠ verze Tetrisu vznikla v roce 1984 v Moskvƒõ.",
            "Vesm√≠r von√≠ jako sp√°len√Ω steak, st≈ôeln√Ω prach a maliny.",
            "Sirius je nejjasnƒõj≈°√≠ hvƒõzda noƒçn√≠ oblohy (a nen√≠ to vrtuln√≠k).",
            "C√≠sa≈ô Nero pr√Ω p≈ôi po≈æ√°ru ≈ò√≠ma v≈Øbec nebyl ve mƒõstƒõ.",
            "Lid√© sd√≠l√≠ 50 % DNA s ban√°ny (nƒõkdy to tak i vypad√°).",
            "VUT FIT m√° ve znaku sovu (nebo nƒõco, co ji p≈ôipom√≠n√°)."
        ];

        const timelineEvents = [
            {
                title: "Kde to v≈°echno zaƒçalo ‚Äì Clash Royale",
                icon: "fa-shield-alt",
                color: "#5865F2", // Modr√°
                desc: "Zeptal jsem se tƒõ, jestli ned√°me 1v1 (samoz≈ôejmƒõ jsem vyhr√°l). <br>(P.S. Ten deck si fakt u≈æ zmƒõ≈à, a≈• m√°≈° aspo≈à teoretickou ≈°anci.)",
                images: [] // P≈ô√≠klad: ["fotky/clash1.jpg", "fotky/clash2.png"]
            },
            {
                title: "Nekoneƒçn√Ω Scroll & Teorie",
                icon: "fa-mobile-alt",
                color: "#3ba55c", // Zelen√°
                desc: "≈†est mili√≥n≈Ø poslan√Ωch Reels a hodiny konverzac√≠ o ≈æivotƒõ. Jsi jedin√Ω ƒçlovƒõk s dostateƒçn√Ωm procesorov√Ωm v√Ωkonem na to, aby pobral moje teorie.",
                images: ["img/dzus.jpg"] 
            },
            {
                title: "Discord Maratony",
                icon: "fa-graduation-cap",
                color: "#faa61a", // ≈Ωlut√°
                desc: "271k+ hodin vol√°n√≠. Od tv√© nekoneƒçn√© trpƒõlivosti a obƒõtavosti p≈ôi douƒçov√°n√≠ m√©ho autistick√©ho ADHD mozku a≈æ po na≈°e bitvy ve hr√°ch.",
                images: ["img/matika_dis.png"] 
            },
            {
                title: "Oh√Ωnek u Vlƒçnovsk√Ωch b√∫d",
                icon: "fa-fire",
                color: "#eb459e", // R≈Ø≈æov√°
                desc: "J√° sehnal d≈ôevo, ty jsi ≈ô√≠dila. Pes n√°m se≈æral veƒçe≈ôi, potkali jsme n√°hodn√©ho Holanƒèana a j√° n√°s hrdinnƒõ br√°nil sekerou proti d≈ôevƒõn√© so≈°e.",
                images: [] // Zde dopl≈à fotky z op√©kaƒçky!
            },
            {
                title: "Hody Ma≈ôatice",
                icon: "fa-wine-glass",
                color: "#ed4245", // ƒåerven√°
                desc: "Veƒçer, kdy jsi mi zachr√°nila prdel. Dot√°hla jsi mƒõ do auta a vyslechla si moje opileck√© uji≈°≈•ov√°n√≠.",
                images: ["img/maratice_tomac.jpg", "img/auto_rotor.jpg"] 
            },
            {
                title: "Pole≈°ovice & Po≈æ√°r",
                icon: "fa-star",
                color: "#5865F2", 
                desc: "Navigace, hasiƒçi, v√Ωhled na po≈æ√°r. Tady jsi mƒõ poprv√© fact-checknula s Nerem a od t√© doby vƒõ≈ô√≠m m√Ωt≈Øm.",
                images: [] 
            },
            {
                title: "Basketbal, Modr√° a Velehrad",
                icon: "fa-basketball-ball",
                color: "#faa61a",
                desc: "M√°lem n√°s sejmul autobus, zlomen√° noha na basketu, mlha na rozhlednƒõ a yappov√°n√≠ v alt√°nku u rybn√≠ka.",
                images: ["img/rozhledna_modra.jpg", "img/rozhledna_modra_2.jpg"] 
            },
            {
                title: "Tento d√°rek",
                icon: "fa-gift",
                color: "gradient", // Speci√°ln√≠ flag
                desc: "V≈°echny na≈°e vzpom√≠nky na jednom m√≠stƒõ. Diddyblud kalkulator a 5 metr≈Ø HDMI kabelu.",
                images: [] 
            },
            {
                title: "Prvn√≠ rande",
                icon: "fa-heart",
                color: "#ed4245", // ƒåerven√°
                desc: "Stezka lovc≈Ø mamut≈Ø v Bor≈°ic√≠ch, vƒõtrn√Ω ml√Ωn v Jalub√≠, proch√°zka kolem rybn√≠ka, chill na chatƒõ s oh√Ωnkem.",
                images: [] 
            },
            {
                title: "Star√© Hutƒõ a Buchlovsk√Ω k√°men",
                icon: "fa-tree",
                color: "darkgreen",
                desc: "Navigov√°n√≠ se ve Star√Ωch Hut√≠ch, trasa p≈ôes les, zaƒçalo snƒõ≈æit, potom n√°m sv√≠tilo slunko pro par√°dn√≠ v√Ωhled u Buchlovsk√©ho kamene. Nakonec je≈°tƒõ n√°kup pro Silvestrovskou chatu (kter√° nebyla), √∫klid a spravov√°n√≠ st≈ôechy na chatƒõ.",
                images: ["img/bk_1.jpg", "img/bk_2.jpg", "img/bk_3.jpg", "img/bk_4.jpg", "img/bk_5.jpg", "img/bk_6.jpg"] 
            },
            {
                title: "Proch√°zka Kunovice, Sady, Rybn√≠k",
                icon: "fa-snowflake",
                color: "LightSkyBlue",
                desc: "Proch√°zka kolem Ol≈°avy, kolotoƒç, Kostel v Sadech (h≈ôbitov) (highlight divn√© p√≠smo na hrobƒõ??), p≈ôes v√Ωchod zp√°tky do Kunovic a tam si sednout k rybn√≠ku",
                images: [] 
            }
        ];

        // --- LIBRARY DATA ---
        const library = {
            movies: [
                {id:103,title:"Angry Birds",icon:"üê¶",cat:"Anim√°ky & Poh√°dky",magnet:"magnet:?xt=urn:btih:3cfd78366ccfe2f5ce6d0f7d17f6e6abdc46cabd&dn=Angry.Birds.ve.filmu.2016.1080p.BluRay.CZ.SK.AC3.x264-Mr.MUX&xl=2196742337",gdrive:GLOBAL_DRIVE_LINK},
                {id:116,title:"Shrek",icon:"üßÖ",cat:"Anim√°ky & Poh√°dky",magnet:"magnet:?xt=urn:btih:ab2acd192c6bb60d5445c3216cacf72f609e21e1&dn=Shrek.Complete.Collection.1080p.CZ.EN.MixeD.x265-R.i.H&xl=24813754031",gdrive:GLOBAL_DRIVE_LINK},
                {id:128,title:"Za plotem",icon:"ü¶ù",cat:"Anim√°ky & Poh√°dky",magnet:"magnet:?xt=urn:btih:a4078b0b3e7b1e12f51855ca313eac8ea1231b2c&dn=Za%20plotem%20%28Over%20the%20Hedge%29.2006.CZ.WebRip.1080p.10b.HEVC.C4U.mkv&xl=1903318064",gdrive:GLOBAL_DRIVE_LINK},
                {id:127,title:"√ö≈æas≈à√°kovi",icon:"ü¶∏",cat:"Anim√°ky & Poh√°dky",magnet:"magnet:?xt=urn:btih:2df5d449cf518fe2b9c1b1314b7735194c3b45e6&dn=%C3%9A%C5%BEas%C5%88%C3%A1kovi.avi&xl=1793605632",gdrive:GLOBAL_DRIVE_LINK},
                {id:113,title:"Rango",icon:"ü¶é",cat:"Anim√°ky & Poh√°dky",magnet:"magnet:?xt=urn:btih:bf1e9444f0ec40cae01e818de909e0456eedb541&dn=Rango.2011.Blu-ray.1080p.Extended.Cut.x264-CZ.SK.EN&xl=7072763782",gdrive:GLOBAL_DRIVE_LINK},
                {id:5,title:"Klaus",icon:"üéÖ",cat:"Anim√°ky & Poh√°dky",magnet:"magnet:?xt=urn:btih:1de24ef937f587ab64e284025582c27cf41246d9&dn=Klaus.2019.HDR.2160p.WEBRip.x265.CZ-iNTENSO&xl=5919259882",gdrive:GLOBAL_DRIVE_LINK},
                {id:101,title:"21 Jump Street",icon:"üëÆ",cat:"Komedie",magnet:"magnet:?xt=urn:btih:a7420cc60bde351b57d2f8c031d74a3177b05f65&dn=21%2C22%20Jump%20Street%202012%2C2014%201080p%20%28Multi%29%20WEB-DL%20HEVC%20x265%205.1%20BONE&xl=4540117518",gdrive:GLOBAL_DRIVE_LINK},
                {id:102,title:"22 Jump Street",icon:"üöî",cat:"Komedie",magnet:"magnet:?xt=urn:btih:a7420cc60bde351b57d2f8c031d74a3177b05f65&dn=21%2C22%20Jump%20Street%202012%2C2014%201080p%20%28Multi%29%20WEB-DL%20HEVC%20x265%205.1%20BONE&xl=4540117518",gdrive:GLOBAL_DRIVE_LINK},
                {id:122,title:"Borat",icon:"üëç",cat:"Komedie",magnet:"magnet:?xt=urn:btih:4a80c302f3443fb48374ee2fd74a0fc7b637ffe2&dn=Borat%20%282006%29%20FHD%20cz%20en.mkv&xl=2050976063",gdrive:"https://drive.google.com/file/d/1yTGPSkYW4KskCqjXb9PlSeNYSsuoOqoG/view?usp=sharing"},
                {id:118,title:"The Hangover",icon:"üòµ",cat:"Komedie",magnet:"magnet:?xt=urn:btih:bf4512d9861586190359e6c4552e3f9427a930e3&dn=The%20Hangover%20Trilogy%202009%2C2011%2C2013%2C%201080p%20BluRay%20HEVC%20x265%205.1%20BONE&xl=4674467377",gdrive:GLOBAL_DRIVE_LINK},
                {id:124,title:"Dr≈æ hubu!",icon:"ü§ê",cat:"Komedie",magnet:"magnet:?xt=urn:btih:df7c4d2dcd42597e96068bf8d366dd452e9489f8&dn=Dr%C5%BE%20hubu%21%20%282003%29%20FHD%20cz%20fr.mkv&xl=2143250882",gdrive:GLOBAL_DRIVE_LINK},
                {id:123,title:"Dƒõdictv√≠",icon:"üöú",cat:"Komedie",magnet:"magnet:?xt=urn:btih:ca95eb295f94086eecc166c6f0c245db7c4882eb&dn=Dedictvi%20aneb%20kurvahosigutntag%20%281992%29%20%5BCZ%5D%5BBDRip%5D%5B1080p%5D%5BHEVC%5D.mkv&xl=2867771371",gdrive:GLOBAL_DRIVE_LINK},
                {id:115,title:"Scary Movie 1-5",icon:"üëª",cat:"Komedie",magnet:"magnet:?xt=urn:btih:d9f7d0a6308a77b53bc1f04ced920c0c614e1cb7&dn=Scary%20Movie%201-5%20Collection%202000-2013%201080p%20BluRay%20HEVC%20x265%205.1%20BONE&xl=6644413780",gdrive:GLOBAL_DRIVE_LINK},
                {id:2,title:"The Dark Knight",icon:"ü¶á",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:a4ea09adf3c9a51fe719b0358aa37cbe7545f63f&dn=The.Dark.Knight.2008.1080p.BluRay.DDP5.1.x265.10bit-GalaxyRG265%5BTGx%5D&xl=4315567522",gdrive:GLOBAL_DRIVE_LINK},
                {id:7,title:"The Matrix",icon:"üíä",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:db63243fdcc154dfd1034d9ae6f939be563f7973&dn=The%20Matrix%20%281999%29%202160p%20H265%2010%20bit%20DV%20HDR10%2B%20ita%20eg%20AC3%205.1%20sub%20ita%20eng%20Licdom.mkv&xl=4291914323",gdrive:GLOBAL_DRIVE_LINK},
                {id:105,title:"Deadpool",icon:"‚öîÔ∏è",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:19ec5948aa22e430ceef97c559a685d81018fc87&dn=Deadpool.2016.1080p.BluRay.DDP5.1.x265.10bit-GalaxyRG265%5BTGx%5D&xl=2749846096",gdrive:GLOBAL_DRIVE_LINK},
                {id:110,title:"Logan",icon:"üê∫",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:0480637222dd5a1a2e7a199c56cce0b00c35b51c&dn=Logan%20%282017%29%20%5B1080p%5D%20%5BYTS.AG%5D&xl=2248685741",gdrive:GLOBAL_DRIVE_LINK},
                {id:107,title:"Guardians of the Galaxy",icon:"üåå",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:2479bc7abfbca9921eb61318e567ad2c40971c95&dn=Guardians.of.the.Galaxy.2014.IMAX.1080p.BluRay.DDP5.1.x265.10bit-GalaxyRG265%5BTGx%5D&xl=2737487733",gdrive:GLOBAL_DRIVE_LINK},
                {id:114,title:"Ready Player One",icon:"üï∂Ô∏è",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:0b2a8eac63a94cedf31118400f3f4bcb08b72d1a&dn=Ready%20Player%20One%20%282018%29%20%5BBluRay%5D%20%5B1080p%5D%20%5BYTS.AM%5D&xl=2415181864",gdrive:GLOBAL_DRIVE_LINK},
                {id:121,title:"Alien",icon:"üëΩ",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:dffbfb159af59bd3eb8cf720b8fa99b6ac72ba78&dn=Alien%201979%20DC%20REMASTERED%201080p%20BluRay%20HEVC%20x265%205.1%20BONE.mkv&xl=2075161124",gdrive:GLOBAL_DRIVE_LINK},
                {id:111,title:"Mad Max: Fury Road",icon:"üî•",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:dbac9177cdbb06dfcb0ced506170b47b6f5e9796&dn=Mad.Max.Fury.Road.2015.1080p.BluRay.DDP5.1.x265.10bit-GalaxyRG265%5BTGx%5D&xl=3959350923",gdrive:GLOBAL_DRIVE_LINK},
                {id:119,title:"LOTR Trilogie",icon:"üíç",cat:"Akƒçn√≠ & Sci-Fi",magnet:"magnet:?xt=urn:btih:c8216c593a3bc4e660b9b12d49bb91b5857ae7bc&dn=The.Lord.Of.The.Rings.Trilogy.Extended.Remastered.1080p.BluRay.x265%20-88&xl=12166339629",gdrive:GLOBAL_DRIVE_LINK},
                {id:1,title:"The Shawshank Redemption",icon:"üîì",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:e79a5b4ac27a9e66adf91689a98deb0d3ba7674b&dn=The.Shawshank.Redemption.1994.1080p.BluRay.x265.AAC.5.1%20-88&xl=2384290903",gdrive:GLOBAL_DRIVE_LINK},
                {id:4,title:"Pulp Fiction",icon:"üçî",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:2516dd0343be41e7292b40441fcd84646c156d96&dn=Pulp%20Fiction%20Historky%20z%20podsveti%201994&xl=3066884151",gdrive:GLOBAL_DRIVE_LINK},
                {id:6,title:"Fight Club",icon:"üëä",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:70981326246aaea630c288c2429e683aa2690603&dn=Fight.Club.1999.REMASTERED.1080p.BluRay.DDP5.1.x265.10bit-GalaxyRG265%5BTGx%5D&xl=4301531029",gdrive:GLOBAL_DRIVE_LINK},
                {id:8,title:"Whiplash",icon:"ü•Å",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:419dc46785809c0a9760be3046fb8cb880cf8493&dn=Whiplash%20%282014%29%20%2B%20Extras%20%281080p%20BluRay%20x265%20HEVC%2010bit%20AAC%207.1%20afm72%29&xl=4633276114",gdrive:GLOBAL_DRIVE_LINK},
                {id:106,title:"Donnie Darko",icon:"üê∞",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:8ecc1f141602919fc05d36eb88e6f1dca295019a&dn=Donnie.Darko.2001.REMASTERED.DC.1080p.BluRay.H264.AAC%20%5B88%5D&xl=2740960879",gdrive:GLOBAL_DRIVE_LINK},
                {id:112,title:"Prisoners",icon:"üî¶",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:e778030429d87438eb4f4a3b8197e5996c79f0e7&dn=Prisoners.2013.1080p.BluRay.DDP5.1.x265.10bit-GalaxyRG265%5BTGx%5D&xl=2681606834",gdrive:GLOBAL_DRIVE_LINK},
                {id:125,title:"Seven",icon:"üì¶",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:61d09d1a63b8a630a8825307f87a9c14b268e382&dn=Seven%20-%20Se7en%20%281995%29%202160p%20H265%2010%20bit%20DV%20ita%20eng%20AC3%205.1%20sub%20ita%20eng%20NUita%20NUeng-Licdom.mkv&xl=3885400010",gdrive:GLOBAL_DRIVE_LINK},
                {id:126,title:"The Social Network",icon:"üëç",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:5c918fd1b8e6c2316463617d3727a2cfe1b24d4e&dn=The.Social.Network.2010.iTA.ENG.AC3.SUB.iTA.ENG.BluRay.HEVC.1080p.x265.jeddak-MIRCrew.mkv&xl=2946953369",gdrive:GLOBAL_DRIVE_LINK},
                {id:109,title:"Le Mans 66",icon:"üèéÔ∏è",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:84e8d7aba68140f12a4789ced23e0b7a1b278aa6&dn=Le%20Mans%2066%20Ford%20v%20Ferrari%20BluRay%201080xH264%20Ita%20Eng%20AC3%205.1%20Sub%20Ita%20Eng&xl=3828506737",gdrive:GLOBAL_DRIVE_LINK},
                {id:117,title:"The Gentlemen",icon:"ü•É",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:8896eea0fcf5ab67b547f980a53141217cded510&dn=The%20Gentlemen%20%282019%29%20%281080p%20BluRay%20x265%20HEVC%2010bit%20AAC%207.1%20Vyndros%29&xl=4387443401",gdrive:GLOBAL_DRIVE_LINK},
                {id:120,title:"The Thing",icon:"‚ùÑÔ∏è",cat:"Drama & Thriller",magnet:"magnet:?xt=urn:btih:4823e1956eba859311db0621ca9ea7d5bb4a66ca&dn=The.Thing.1982.REMASTERED.1080p.BluRay.x264.AAC5.0-ShAaNiG&xl=2142451662",gdrive:GLOBAL_DRIVE_LINK}
            ],
            series: [
                {id:9,title:"Breaking Bad",icon:"üß™",cat:"Seri√°ly",magnet:"magnet:?xt=urn:btih:7118a27453275949493ab3d77b709456404e0ef6&dn=Breaking%20Bad%20%282008%29%20Season%201-5%20S01-S05%20%281080p%20BluRay%20x265%20HEVC%2010bit%20AAC%205.1%20Silence%29&xl=150389060754",gdrive:GLOBAL_DRIVE_LINK},
                {id:11,title:"Mr. Robot",icon:"üíª",cat:"Seri√°ly",magnet:"magnet:?xt=urn:btih:704122faa6db389c8e2eff2dbd12e5aa8712fe63&dn=Mr.Robot.COMPLETE.1080p.BluRay.AV1.DDP.5.1-dAV1nci&xl=30529111722",gdrive:GLOBAL_DRIVE_LINK},
                {id:12,title:"True Detective S1",icon:"üïµÔ∏è",cat:"Seri√°ly",magnet:"magnet:?xt=urn:btih:6f6fe19e361b14dc74c4a1dae8e51e802ef65ae7&dn=True%20Detective%20Season%201%20%20%281080p%20BD%20x265%2010bit%20FS84%20Joy%29&xl=5543662591",gdrive:GLOBAL_DRIVE_LINK}
            ],
            games: [
                {id:13,title:"Tetris Effect",icon:"üß©",cat:"Hry",magnet:"magnet:?xt=urn:btih:e38087a21f8acab8e6f7120cd0622af10eaeb280&dn=Tetris.Effect.Connected.v2.0.2.rar&xl=3216489007",gdrive:GLOBAL_DRIVE_LINK},
                {id:14,title:"Hades",icon:"‚ö°",cat:"Hry",magnet:"magnet:?xt=urn:btih:70947d6b874a01385511d50166cb2d23855facb1&dn=Hades.v1.38100.zip&xl=11582699763",gdrive:GLOBAL_DRIVE_LINK},
                {id:15,title:"Dead Cells",icon:"üíÄ",cat:"Hry",magnet:"magnet:?xt=urn:btih:3fed513b1d4172969a0239c0b0730e5c5a18894b&dn=Dead%20Cells%20%5BFitGirl%20Repack%5D&xl=2472856355",gdrive:GLOBAL_DRIVE_LINK},
                {id:301,title:"Balatro",icon:"üÉè",cat:"Hry",magnet:"magnet:?xt=urn:btih:8823764e16d978e6e0f9b46bf8a66416dad2f505&dn=Balatro.v1.0.1N&xl=66744928",gdrive:GLOBAL_DRIVE_LINK},
                {id:302,title:"Brotato",icon:"ü•î",cat:"Hry",magnet:"magnet:?xt=urn:btih:364d8768cc4628a3ad59a44644c34f324624fbea&dn=Brotato.v1.1.13.0&xl=308392977",gdrive:GLOBAL_DRIVE_LINK},
                {id:303,title:"Kingdom: Two Crowns",icon:"üëë",cat:"Hry",magnet:"magnet:?xt=urn:btih:05c33ad86589f64f0b26b51902e2edde80603f29&dn=Kingdom.Two.Crowns.v2.3&xl=4656710442",gdrive:GLOBAL_DRIVE_LINK},
                {id:304,title:"Mafia II: DE",icon:"üî´",cat:"Hry",magnet:"magnet:?xt=urn:btih:4ed851ea6c87126480d2049f7b4d47fbb2d9e28f&dn=Mafia%20II%20-%20Definitive%20Edition%20%5BFitGirl%20Repack%5D&xl=13314267858",gdrive:GLOBAL_DRIVE_LINK},
                {id:305,title:"Papa's Freezeria",icon:"üç¶",cat:"Hry",magnet:"magnet:?xt=urn:btih:9c56c4604c305af0f51d908dc7930b7da48f8e77&dn=Papas.Freezeria.Deluxe&xl=63577281",gdrive:GLOBAL_DRIVE_LINK},
                {id:306,title:"Stackflow",icon:"üíª",cat:"Hry",magnet:"magnet:?xt=urn:btih:16e4c04d877d0fc94fa1d0fee3763d5fb3fbc0be&dn=Stackflow.v0.9&xl=129021781",gdrive:GLOBAL_DRIVE_LINK},
                {id:307,title:"Enter the Gungeon",icon:"üî´",cat:"Hry",magnet:"magnet:?xt=urn:btih:d83d3e3e9f40a1d0ae2b5aacf2360fb2ddcb7abb&dn=Enter.the.Gungeon.v2.1.3.zip&xl=670706499",gdrive:GLOBAL_DRIVE_LINK},
                {id:308,title:"Hades II",icon:"üåô",cat:"Hry",magnet:"magnet:?xt=urn:btih:3fb5b6737355f1d93e77969d7638fee90806b9d8&dn=Hades.II.v1.133066.rar&xl=9079366716",gdrive:GLOBAL_DRIVE_LINK},
                {id:309,title:"Jump King",icon:"üëë",cat:"Hry",magnet:"magnet:?xt=urn:btih:ee670e09061d5e5694ea356a8029a280766739e5&dn=Jump.King.v1.06.rar&xl=1313998599",gdrive:GLOBAL_DRIVE_LINK}
            ]
        };

        // --- DATE PLANNER DATA ---
        const dateLocations = [
            // --- 100+: PROCH√ÅZKY - Parky, Voda & M√≠sta (D≈ô√≠ve 300+) ---
            { id: 101, name: "Kunovsk√Ω les", cat: "walk", lat: 49.053913, lng: 17.449622, desc: "Proch√°zka po rovinƒõ, ide√°ln√≠ na pokec." },
            { id: 102, name: "Smetanovy sady (UH)", cat: "walk", lat: 49.066836, lng: 17.468690, desc: "Park v centru UH, kousek od Slov√°ck√© b√∫dy." },
            { id: 103, name: "Z√°meck√Ω park Buchlovice", cat: "walk", lat: 49.083800, lng: 17.336900, desc: "N√°dhern√Ω park, p√°vi a pohoda." },
            { id: 104, name: "Rybn√≠k Kunovice", cat: "walk", lat: 49.041773, lng: 17.478465, desc: "Hezk√° proch√°zka po Kunovic√≠ch kolem rybn√≠ku." },
            { id: 105, name: "≈†tƒõrkop√≠skov√° jezera", cat: "walk", lat: 49.018258, lng: 17.426915, desc: "Alfr√©dov. ƒåist√° voda, v l√©tƒõ na koup√°n√≠, v zimƒõ na otu≈æov√°n√≠." },
            { id: 106, name: "Luhaƒçovick√° p≈ôehrada", cat: "walk", lat: 49.123999, lng: 17.778854, desc: "Proch√°zka kolem p≈ôehrady, koupali≈°tƒõ." },
            { id: 107, name: "P≈ôehrada Luƒçina", cat: "walk", lat: 48.862398, lng: 17.392934, desc: "Jezero s mo≈ænost√≠ koup√°n√≠ a proch√°zka za Radƒõjovem." },
            { id: 108, name: "Star√© Hutƒõ", cat: "walk", lat: 49.129433, lng: 17.277701, desc: "Kr√°sn√° proch√°zka v √∫dol√≠ pod Buchlovem." },
            { id: 109, name: "Bunƒç", cat: "walk", lat: 49.177000, lng: 17.351500, desc: "Turistick√© centrum Ch≈ôib≈Ø, kousek na Brdo." },
            { id: 110, name: "Z√°meƒçek Pepƒç√≠n", cat: "walk", lat: 49.026573, lng: 17.586872, desc: "Ruiny z√°meƒçku u Drslavic, tajemn√© m√≠sto." },
            { id: 111, name: "Vlƒçnovsk√© b√∫dy", cat: "walk", lat: 49.019280, lng: 17.591636, desc: "M√≠sto ƒçinu (ohni≈°tƒõ, pes, sekerka)." },
            { id: 112, name: "Podol√≠", cat: "walk", lat: 49.038929, lng: 17.532952, desc: "Expedice do neexistuj√≠c√≠ obce." },

            // --- 200+: V√ùHLEDY - Rozhledny, Kopce & Pam√°tky (D≈ô√≠ve 100+) ---
            { id: 201, name: "Rozhledna Sala≈°", cat: "view", lat: 49.142871, lng: 17.352267, desc: "Designov√° rozhledna ve tvaru sedmiƒçek. Super v√Ωhled na Ch≈ôiby." },
            { id: 202, name: "Rozhledna Rovnina", cat: "view", lat: 49.071519, lng: 17.513178, desc: "Klasika nad Jaro≈°ovem. Kousek pƒõ≈°ky, hezk√Ω v√Ωhled na Hradi≈°tƒõ." },
            { id: 203, name: "Flori√°nka", cat: "view", lat: 49.037799, lng: 17.326382, desc: "Kousek od Pole≈°ovic. V√≠me, ≈æe tam fouk√°, ale v√Ωhled na vinohrady top." },
            { id: 204, name: "Maj√°k ≈†rot√≠k", cat: "view", lat: 49.073950, lng: 17.426840, desc: "Ve Star√°ku v Kovozoo. Trochu biz√°r, ale vtipn√Ω." },
            { id: 205, name: "Velk√Ω Lopen√≠k", cat: "view", lat: 48.940368, lng: 17.779172, desc: "T√∫ra na hranice. D≈ôevƒõn√° rozhledna, po≈ô√°dn√Ω v√Ω≈°lap." },
            { id: 206, name: "Rozhledna Modr√°", cat: "view", lat: 49.119035, lng: 17.403316, desc: "Mal√° d≈ôevƒõn√° rozhledna v tƒõch sadech nad Modrou." },
            { id: 207, name: "Rozhledna Brdo", cat: "view", lat: 49.186500, lng: 17.308500, desc: "Nejvy≈°≈°√≠ kamenn√° rozhledna v Ch≈ôibech." },
            { id: 208, name: "Vƒõtrn√Ω ml√Ωn Jalub√≠", cat: "view", lat: 49.124389, lng: 17.431000, desc: "Novƒõ postaven√Ω ml√Ωn. Kr√°tk√° proch√°zka a super fotky." },
            { id: 209, name: "Rozhledna Doub√≠", cat: "view", lat: 49.039200, lng: 17.303600, desc: "Men≈°√≠ rozhledna v pol√≠ch, v√Ωhled na Ch≈ôiby a B√≠l√© Karpaty." },
            { id: 210, name: "Bukovansk√Ω ml√Ωn", cat: "view", lat: 49.036979, lng: 17.091398, desc: "Rozhledna, minigolf a restaurace kousek od Kyjova. Kr√°sn√Ω v√Ωlet." },
            { id: 211, name: "Rozhledna Rado≈°ov", cat: "view", lat: 48.924786, lng: 17.427983, desc: "Pƒõkn√° rozhledna za Vesel√≠m n. M." },
            { id: 212, name: "Rozhledna Traviƒçn√°", cat: "view", lat: 48.860205, lng: 17.365718, desc: "Pƒõkn√° rozhledna za Radƒõjovem." },
            { id: 213, name: "Velk√° Javo≈ôina", cat: "view", lat: 48.858500, lng: 17.671000, desc: "Nejvy≈°≈°√≠ hora B√≠l√Ωch Karpat, vys√≠laƒç a dalek√© v√Ωhledy." },
            { id: 230, name: "Hrad Buchlov", cat: "view", lat: 49.107481, lng: 17.310858, desc: "Klasika. Vyhl√≠dka z vƒõ≈æe je povinnost." },
            { id: 231, name: "Kaple svat√© Barbory", cat: "view", lat: 49.108641, lng: 17.318941, desc: "Modlivka. Nejlep≈°√≠ m√≠sto na z√°pad slunce pod Buchlovem." },
            { id: 232, name: "Z≈ô√≠cenina Cimburk", cat: "view", lat: 49.103700, lng: 17.216200, desc: "Romantick√° z≈ô√≠cenina u Koryƒçan. M√°lo lid√≠, hodnƒõ klidu." },
            { id: 233, name: "Hradisko sv. Klimenta", cat: "view", lat: 49.085400, lng: 17.217700, desc: "Hradisko v les√≠ch. Klid, historie a Gorazd." },
            { id: 234, name: "Z≈ô√≠cenina St≈ô√≠lky", cat: "view", lat: 49.135000, lng: 17.220500, desc: "Z≈ô√≠cenina s kr√°sn√Ωm v√Ωhledem, kousek od St≈ô√≠lek." },
            { id: 235, name: "Kaple svat√©ho Rocha", cat: "view", lat: 49.076822, lng: 17.494639, desc: "Je≈°tƒõ kousek nad skanzenem. Kr√°sn√Ω v√Ωhled na z√°pad slunce nad UH." },
            { id: 236, name: "Z√°mek Milotice", cat: "view", lat: 48.959258, lng: 17.138092, desc: "Barokn√≠ perla. Ty zahrady jsou na proch√°zku jak dƒõlan√©." },
            { id: 237, name: "Hrad Malenovice", cat: "view", lat: 49.203480, lng: 17.599559, desc: "Zaj√≠mav√Ω hrad/z√°mek, proch√°zka v lese." },
            { id: 238, name: "Velehrad (Bazilika)", cat: "view", lat: 49.103500, lng: 17.395800, desc: "Je to tam hezk√©, i kdy≈æ nejsme vƒõ≈ô√≠c√≠. Zmrzlina u cesty." },
            { id: 239, name: "Kostel Panny Marie (Sady)", cat: "view", lat: 49.052542, lng: 17.481772, desc: "V√Ω≈°ina sv. Metodƒõje, archeologick√© nalezi≈°tƒõ a v√Ωhled." },
            { id: 250, name: "Kazatelna", cat: "view", lat: 49.095453, lng: 17.226237, desc: "Skaln√≠ √∫tvar v Ch≈ôibech. Pr√Ω se odtud k√°zalo." },
            { id: 251, name: "Kozel", cat: "view", lat: 49.097599, lng: 17.216784, desc: "Sk√°la v Ch≈ôibech, co vypad√°... no jako kozel. Kousek od Kazatelny." },
            { id: 252, name: "Buchlovsk√Ω k√°men", cat: "view", lat: 49.117200, lng: 17.288900, desc: "Osamƒõl√Ω p√≠skovcov√Ω skaln√≠ √∫tvar v Ch≈ôibech." },
            { id: 253, name: "B≈ôesteck√° Sk√°la", cat: "view", lat: 49.111593, lng: 17.335545, desc: "P√≠skovcov√© sk√°ly v Ch≈ôibech, kousek od B≈ôestku." },

            // --- 300+: Z√ÅBAVA - Sport, Zv√≠≈ôata & Akce (D≈ô√≠ve 200+) ---
            { id: 301, name: "Kovozoo Star√© Mƒõsto", cat: "fun", lat: 49.073950, lng: 17.426840, desc: "Zv√≠≈ôata ze ≈°rotu. Projdeme se, d√°me fotku s gepardem." },
            { id: 302, name: "ZOO Le≈°n√°", cat: "fun", lat: 49.274700, lng: 17.713600, desc: "Nejhezƒç√≠ ZOO v okol√≠. Rejnoci a z√°mek." },
            { id: 303, name: "Staromƒõstsk√° Minizoo", cat: "fun", lat: 49.076500, lng: 17.436500, desc: "Mal√° zoo ve Star√°ku (Rybn√≠ƒçek)." },
            { id: 304, name: "≈Ωiv√° Voda Modr√°", cat: "fun", lat: 49.103295, lng: 17.406936, desc: "Ten podvodn√≠ tunel s vy≈æran√Ωma kaprama. A prury." },
            { id: 305, name: "Archeoskanzen Modr√°", cat: "fun", lat: 49.105611, lng: 17.409365, desc: "Historie, Velk√° Morava a tak. Hned vedle ≈Ωiv√© vody." },
            { id: 306, name: "Skanzen Rochus", cat: "fun", lat: 49.071833, lng: 17.489000, desc: "Proch√°zka mezi star√Ωma bar√°kama nad Ma≈ôaticama." },
            { id: 307, name: "Skanzen Str√°≈ænice", cat: "fun", lat: 48.904117, lng: 17.312200, desc: "Velk√Ω skanzen s vinohrady." },
            { id: 308, name: "Stezka Lovc≈Ø Mamut≈Ø", cat: "fun", lat: 49.054580, lng: 17.349503, desc: "Nauƒçn√° stezka s d≈ôevƒõn√Ωmi zv√≠≈ôaty u Bor≈°ic." },
            { id: 309, name: "Leteck√© muzeum Kunovice", cat: "fun", lat: 49.034854, lng: 17.458005, desc: "Nagansk√Ω expres a st√≠haƒçky. Povinnost." },
            { id: 310, name: "Slov√°ck√© muzeum", cat: "fun", lat: 49.056575, lng: 17.360344, desc: "Muzeum v parku, historie Slov√°cka." },
            { id: 320, name: "Kino Hvƒõzda UH", cat: "fun", lat: 49.067479, lng: 17.468837, desc: "Popcorn (i kdy≈æ leze do zub≈Ø) a nƒõjak√Ω film z watchlistu." },
            { id: 321, name: "Aquapark UH", cat: "fun", lat: 49.067042, lng: 17.472961, desc: "Tobog√°ny nebo wellness? Sp√≠≈° ten wellness." },
            { id: 322, name: "Laser Game UH", cat: "fun", lat: 49.063000, lng: 17.470000, desc: "A≈• vid√≠me, kdo m√° lep≈°√≠ mu≈°ku (j√°)." },
            { id: 323, name: "Motok√°ry Star√© Mƒõsto", cat: "fun", lat: 49.072239, lng: 17.420460, desc: "Trocha adrenalinu na parkovi≈°ti (Rec Group)." },
            { id: 324, name: "Bowling Ma≈ôatice", cat: "fun", lat: 49.061068, lng: 17.481452, desc: "Klasika, kdy≈æ pr≈°√≠. Pivo a koule." },
            { id: 325, name: "Sport Centrum Morava", cat: "fun", lat: 49.068200, lng: 17.485600, desc: "Bowling a pizza v Ma≈ôatic√≠ch." },
            { id: 326, name: "Discgolf Kunovsk√Ω les", cat: "fun", lat: 49.054300, lng: 17.448500, desc: "H√°zen√≠ tal√≠≈ôem na ko≈°e. Je to sranda a je to v lese." },
            { id: 327, name: "Minigolf Horn√≠ Nƒõmƒç√≠", cat: "fun", lat: 48.927500, lng: 17.625500, desc: "Fajn minigolf trochu d√°l, ale v p≈ô√≠rodƒõ." },
            { id: 328, name: "Slov√°ck√Ω dv≈Ør", cat: "fun", lat: 49.011805, lng: 17.440694, desc: "Adventure golf a koup√°n√≠ v Ostro≈æsk√©." },
            { id: 329, name: "Baloncentrum B≈ôestek", cat: "fun", lat: 49.094338, lng: 17.355034, desc: "Koukat jak startuj√≠ bal√≥ny a d√°t si limon√°du." },
            { id: 330, name: "Amf√≠k Bukovina", cat: "fun", lat: 49.061544, lng: 17.516969, desc: "Kdy≈æ bude nƒõjak√° akce nebo letn√≠ kino. Pƒõkn√Ω are√°l." },
            { id: 331, name: "Basketbal Kunovice", cat: "fun", lat: 49.044594, lng: 17.470963, desc: "Basketbal U P√°lenice." },

            // --- 400+: J√çDLO & K√ÅVA (Z≈Øst√°v√°) ---
            { id: 401, name: "Kafec U Kom√≠na", cat: "food", lat: 49.072781, lng: 17.455032, desc: "Nejlep≈°√≠ vafle a kafe v UH." },
            { id: 402, name: "Za≈°√≠v√°rna U Osla", cat: "food", lat: 49.062827, lng: 17.423105, desc: "Skvƒõl√° atmosf√©ra a dobr√© pit√≠." },
            { id: 403, name: "Hosp≈Ødka na Haldƒõ", cat: "food", lat: 49.056575, lng: 17.360344, desc: "Ryby a pohoda v Bor≈°ic√≠ch." }
        ];

        // --- SMART SEARCH DATA ---
        const searchSynonyms = {
            'walk': ['proch√°zka', 'les', 'p≈ô√≠roda', 'v√Ω≈°lap', 'hory', 'üå≤', 'venku', 'vzduch'],
            'food': ['j√≠dlo', 'restaurace', 'kafe', 'obƒõd', 'veƒçe≈ôe', 'burger', 'pizza', 'üçî', '‚òï', 'hlad'],
            'view': ['v√Ωhled', 'rozhledna', 'kopec', 'vyhl√≠dka', 'üëÄ', 'panorama', 'z√°pad slunce'],
            'fun':  ['z√°bava', 'hra', 'sport', 'kino', 'akce', 'üéâ', 'bowling', 'laser'],
            'movie': ['film', 'kouk√°n√≠', 'kino', 'üé¨', 'sleduj', 'poh√°dka'],
            'game': ['hra', 'pa≈ôba', 'üéÆ', 'play', 'sk√≥re'],
            'love': ['l√°ska', 'rande', '‚ù§Ô∏è', 'spolu', 'miluju']
        };

        let selectedDateLocation = null;


        let availableFacts = [...funFacts];

        // --- CORE FUNCTIONS ---
        function getUniqueFunFact() {
            if (availableFacts.length === 0) availableFacts = [...funFacts];
            return availableFacts.splice(Math.floor(Math.random() * availableFacts.length), 1)[0];
        }

        // --- MOBILE MENU LOGIC ---
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar-wrapper');
            const overlay = document.getElementById('mobile-overlay');
            
            // Zkontrolujeme, jestli je menu skryt√©
            const isClosed = sidebar.classList.contains('-translate-x-full');
            
            if (isClosed) {
                // Otev≈ô√≠t (odstran√≠me posunut√≠ mimo obrazovku)
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                // Zav≈ô√≠t (vr√°t√≠me posunut√≠ mimo obrazovku)
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function toggleUserPopout() {
            const popout = document.getElementById('user-popout');
            popout.classList.toggle('active');
            
            if (popout.classList.contains('active')) {
                // P≈ôid√°me listener s mal√Ωm zpo≈ædƒõn√≠m, aby se nezav≈ôel hned t√≠m sam√Ωm kliknut√≠m
                setTimeout(() => {
                    document.addEventListener('click', closePopoutOutside);
                }, 100);
            }
        }

        function closePopoutOutside(e) {
            const popout = document.getElementById('user-popout');
            // Pokud kliknut√≠ nebylo uvnit≈ô popoutu a ani na spodn√≠ li≈°tƒõ
            if (!e.target.closest('.user-popout') && !e.target.closest('.h-\\[52px\\]')) {
                popout.classList.remove('active');
                document.removeEventListener('click', closePopoutOutside);
            }
        }

        function verifyLocation() {
            const btn = document.getElementById('verify-btn');
            const status = document.getElementById('verify-status');
            const text = document.getElementById('verify-text');
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            text.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Ovƒõ≈ôov√°n√≠...';
            status.classList.remove('hidden');
            const steps = ["üì° P≈ôipojov√°n√≠ k satelitu...", "üìç Triangulace pozice...", "‚ùå Podol√≠... 404 Not Found", "‚úÖ Kunovice... NALEZENO"];
            let i = 0;
            const interval = setInterval(() => {
                if (i < steps.length) {
                    const div = document.createElement('div');
                    div.className = i === 2 ? 'text-red-400' : (i === 3 ? 'text-green-400 font-bold' : 'text-gray-400');
                    div.innerHTML = steps[i];
                    status.appendChild(div);
                    i++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('login-screen').style.display = 'none';
                        showQuiz();
                    }, 1000);
                }
            }, 800);
        }

        function changeTheme(theme) {
            const root = document.documentElement;
            // Clear inline styles first (font-family, font-size from Tetris)
            document.body.style.fontFamily = '';
            document.body.style.fontSize = '';
            
            if (theme === 'christmas') { 
                root.style.setProperty('--bg-tertiary', '#420d0d'); 
                root.style.setProperty('--bg-secondary', '#5c1414'); 
                root.style.setProperty('--bg-primary', '#240a0a'); 
                root.style.setProperty('--blurple', '#c92a2a'); // Red
                root.style.setProperty('--green', '#ffd700'); // Gold
                root.style.setProperty('--text-header', '#ffffff');
                root.style.setProperty('--interactive-active', '#ffffff');
                root.style.setProperty('--interactive-normal', '#e8e8e8'); // Lighter text
                root.style.setProperty('--text-normal', '#f0f0f0');
            } 
            else if (theme === 'tetris') {
                root.style.setProperty('--bg-tertiary', '#0d0e15');
                root.style.setProperty('--bg-secondary', '#151620');
                root.style.setProperty('--bg-primary', '#1c1d29');
                root.style.setProperty('--blurple', '#00e5ff'); 
                root.style.setProperty('--green', '#69f0ae'); 
                root.style.setProperty('--red', '#ff5252'); 
                root.style.setProperty('--yellow', '#ffd740'); 
                root.style.setProperty('--pink', '#e040fb'); 
                root.style.setProperty('--text-normal', '#33ff00');
                root.style.setProperty('--interactive-normal', '#33ff00');
                document.body.style.fontFamily = "'Press Start 2P', cursive"; 
                document.body.style.fontSize = "0.8rem";
            }
            else { // default
                root.style.setProperty('--bg-tertiary', '#202225'); root.style.setProperty('--bg-secondary', '#2f3136'); root.style.setProperty('--bg-primary', '#36393f'); 
                root.style.setProperty('--blurple', '#5865F2');
                root.style.setProperty('--green', '#3ba55c');
                root.style.setProperty('--red', '#ed4245');
                root.style.setProperty('--yellow', '#faa61a');
                root.style.setProperty('--pink', '#eb459e');
                root.style.setProperty('--text-normal', '#dcddde');
                root.style.setProperty('--interactive-normal', '#b9bbbe');
            }
            showNotification(`T√©ma zmƒõnƒõno: ${theme}`, 'success');
        }

        // --- QUIZ ---
        function showQuiz() {
            document.getElementById('quiz-screen').style.display = 'flex';
            loadQuizQuestion(0);
        }
        function loadQuizQuestion(index) {
            const container = document.getElementById('quiz-container');
            const progress = ((index) / quizQuestions.length) * 100;
            document.getElementById('quiz-progress').style.width = `${progress}%`;
            document.getElementById('quiz-step-text').innerText = `${index + 1}/${quizQuestions.length}`;
            if (index >= quizQuestions.length) { finishQuiz(); return; }
            const q = quizQuestions[index];
            container.innerHTML = `<div class="mb-10 text-center"><h3 class="text-white font-extrabold text-2xl leading-relaxed">${q.question}</h3></div><div id="quiz-options" class="flex flex-col gap-4"><button onclick="answerQuiz(${index}, true)" class="w-full bg-[#2f3136] hover:bg-[#3ba55c] text-left px-4 py-4 rounded border border-[#202225] hover:border-[#3ba55c] transition flex items-center group"><div class="w-6 h-6 rounded-full border-2 border-gray-500 group-hover:border-white mr-3 flex items-center justify-center"></div><span class="text-gray-300 group-hover:text-white font-medium text-lg">FAKT</span></button><button onclick="answerQuiz(${index}, false)" class="w-full bg-[#2f3136] hover:bg-[#ed4245] text-left px-4 py-4 rounded border border-[#202225] hover:border-[#ed4245] transition flex items-center group"><div class="w-6 h-6 rounded-full border-2 border-gray-500 group-hover:border-white mr-3 flex items-center justify-center"></div><span class="text-gray-300 group-hover:text-white font-medium text-lg">M√ùTUS</span></button></div><div id="quiz-result-feedback" class="hidden mt-4 pt-4 border-t border-[#36393f]"></div>`;
            document.getElementById('fun-fact-container').style.display = 'block';
            document.getElementById('fun-fact-text').innerText = getUniqueFunFact();
        }
        function answerQuiz(index, answer) {
            const q = quizQuestions[index];
            const correct = (answer === q.correct);
            if (!state.quizAnswers.completed && correct) state.quizAnswers.score += 10;
            document.getElementById('quiz-options').style.display = 'none';
            const feedback = document.getElementById('quiz-result-feedback');
            feedback.innerHTML = `
                <div class="mb-6 p-4 bg-[#202225] rounded-lg border-l-4 ${correct ? 'border-green-500' : 'border-red-500'}">
                    <h4 class="${correct?'text-green-400':'text-red-400'} font-bold text-xl mb-2 flex items-center">
                        <i class="fas ${correct?'fa-check-circle':'fa-times-circle'} mr-2"></i>
                        ${correct?'Spr√°vnƒõ!':'Ups!'}
                    </h4>
                    <p class="text-white text-lg leading-relaxed mt-2">${q.explanation}</p>
                </div>
                <button onclick="loadQuizQuestion(${index + 1})" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white py-4 rounded-lg font-bold text-xl shadow-md transition transform hover:scale-[1.02]">
                    ${index + 1 < quizQuestions.length ? 'Dal≈°√≠ ot√°zka ‚ûú' : 'Dokonƒçit üéâ'}
                </button>
            `;
            feedback.classList.remove('hidden');
        }
        function finishQuiz() {
            state.quizAnswers.completed = true;
            localStorage.setItem('klarka_quiz', JSON.stringify(state.quizAnswers));
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('quiz-score').textContent = `${state.quizAnswers.score}%`;
            document.getElementById('cert-date').textContent = new Date().toLocaleDateString('cs-CZ');
            document.getElementById('certificate-screen').style.display = 'flex';
        }

        // --- APP NAVIGATION ---
        function showMainApp() {
            document.getElementById('certificate-screen').style.display = 'none';
            const app = document.getElementById('app-interface');
            app.classList.remove('hidden');
            setTimeout(() => app.classList.remove('opacity-0'), 10);
            renderChannels();
            switchChannel('welcome');
            
            // Wait for DOM update before accessing elements
            setTimeout(updateBookmarkCounter, 0);
            initSidebarGestures();
        }
        function renderChannels() {
            const container = document.getElementById('channels-container');
            container.innerHTML = `
                <div class="px-2 mb-4"><div class="flex justify-between px-2 text-xs font-bold text-[var(--interactive-normal)] uppercase mb-1">Informace</div><div onclick="switchChannel('welcome')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-door-open text-gray-500"></i> uv√≠t√°n√≠</div><div onclick="triggerHaptic('light'); switchChannel('timeline')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-history text-gray-500"></i> timeline</div><div onclick="switchChannel('dateplanner')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-map-marked-alt text-[var(--pink)]"></i> pl√°novaƒç</div></div>
                <div class="px-2 mb-4"><div class="flex justify-between px-2 text-xs font-bold text-[var(--interactive-normal)] uppercase mb-1">Knihovna</div><div onclick="switchChannel('manual')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-book text-[var(--green)]"></i> n√°vod</div><div onclick="switchChannel('movies')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-film text-[var(--yellow)]"></i> filmy</div><div onclick="switchChannel('series')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-tv text-[#5865F2]"></i> seri√°ly</div><div onclick="switchChannel('games')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-gamepad text-[var(--green)]"></i> hry</div><div onclick="switchChannel('music')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-gray-300 hover:bg-[#393c43] flex items-center gap-2 cursor-pointer"><i class="fas fa-music text-[#1DB954]"></i> music-bot</div><div onclick="showWatchlist()" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-[var(--pink)] hover:bg-[#393c43] flex items-center gap-2 cursor-pointer relative"><i class="fas fa-bookmark text-[var(--pink)]"></i> tv≈Øj-watchlist<div id="bookmark-counter" class="absolute right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full hidden items-center justify-center h-4 min-w-[16px]"><span id="bookmark-count">0</span></div></div></div>
                <div class="px-2 mb-4"><div class="flex justify-between px-2 text-xs font-bold text-[var(--interactive-normal)] uppercase mb-1">D≈Øle≈æit√©</div><div onclick="switchChannel('upgrade')" class="channel-item px-2 py-1.5 rounded mx-2 mb-1 text-[var(--yellow)] hover:bg-[#faa61a] hover:text-black flex items-center gap-2 cursor-pointer pulse-glow"><i class="fas fa-file-alt text-[var(--yellow)]"></i> README.md</div></div>
            `;
        }
        
        function switchChannel(channel) {
            // --- MOBILN√ç FIX: Zav≈ô√≠t menu ---
            const sidebar = document.getElementById('sidebar-wrapper');
            const overlay = document.getElementById('mobile-overlay');
            if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }

            // --- CLEANUP MAP (Vylep≈°eno) ---
            // Pokud odch√°z√≠me z pl√°novaƒçe, mus√≠me mapu okam≈æitƒõ zniƒçit
            if (state.currentChannel === 'dateplanner' && channel !== 'dateplanner') {
                if (state.mapInstance) {
                    state.mapInstance.off(); // Vypne listenery mapy
                    state.mapInstance.remove(); // Zniƒç√≠ DOM elementy mapy
                    state.mapInstance = null; // Vyma≈æe referenci
                }
            }
            
            // --- FIX SCROLLOV√ÅN√ç (Reset kontejneru) ---
            const container = document.getElementById('messages-container');
            // Tady je ta oprava: V≈ædy resetujeme t≈ô√≠dy na "scrollovateln√©" nastaven√≠ (overflow-y-auto)
            // Funkce renderWelcome() si to pak p≈ô√≠padnƒõ sama p≈ôep√≠≈°e na hidden, pokud bude pot≈ôeba.
            container.className = "flex-1 overflow-y-auto px-0 py-0 custom-scrollbar flex flex-col bg-[#36393f] relative";
            container.innerHTML = '';
            
            // Podbarven√≠ aktivn√≠ho kan√°lu v menu
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('bg-[#393c43]', 'text-white'));
            const clicked = Array.from(document.querySelectorAll('.channel-item')).find(el => el.getAttribute('onclick').includes(channel));
            if(clicked) clicked.classList.add('bg-[#393c43]', 'text-white');
            state.currentChannel = channel;
            
            // Nastaven√≠ hlaviƒçky a ikon
            const titles = {'welcome':'uv√≠t√°n√≠','manual':'n√°vod','timeline':'timeline','movies':'filmy','series':'seri√°ly','games':'hry','upgrade':'README.md', 'dateplanner':'pl√°novaƒç', 'music':'music-bot'};
            const icons = {'welcome':'fa-door-open','manual':'fa-book','timeline':'fa-history','movies':'fa-film','series':'fa-tv','games':'fa-gamepad','upgrade':'fa-file-alt', 'dateplanner':'fa-map-marked-alt', 'music':'fa-music'};
            
            const titleText = titles[channel] || channel;
            const iconClass = icons[channel] || 'fa-hashtag';

            document.getElementById('channel-name').textContent = titleText;
            document.getElementById('channel-icon').className = `fas ${iconClass} text-gray-500 text-xl mr-2`;
            document.getElementById('user-status').textContent = channel === 'upgrade' ? 'P≈ôem√Ω≈°l√≠ o upgradu' : 'Online';
            
            // Vykreslen√≠ obsahu
            if(channel === 'welcome') renderWelcome(); 
            else if (channel === 'manual') renderManual();
            else if (channel === 'timeline') renderTimeline();
            else if (channel === 'dateplanner') renderDatePlanner();
            else if (['movies','series','games'].includes(channel)) renderLibrary(channel);
            else if (channel === 'music') renderMusic();
            else if (channel === 'upgrade') renderUpgrade();
            
            // Scroll to top pro scrollovac√≠ str√°nky (aby u≈æivatel nezaƒç√≠nal dole)
            if (['movies', 'series', 'games', 'manual', 'timeline', 'dateplanner', 'music'].includes(channel)) {
                container.scrollTop = 0;
            }
        }

        function renderWelcome() {
            const container = document.getElementById('messages-container');
            
            // Nastav√≠me kontejneru flex, aby se input dr≈æel dole
            container.className = "flex-1 flex flex-col bg-[#36393f] relative overflow-hidden";

            container.innerHTML = `
                <div class="flex-1 overflow-y-auto px-4 py-4 custom-scrollbar space-y-6" id="chat-scroller">
                    
                    <div class="message-group animate-fade-in group hover:bg-black/5 -mx-4 px-4 py-1">
                        <div class="flex gap-4 items-start">
                            <div class="w-10 h-10 rounded-full bg-[#5865F2] flex items-center justify-center text-white text-sm font-bold mt-1 shadow-lg cursor-pointer hover:opacity-80 transition flex-shrink-0">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-baseline gap-2">
                                    <span class="font-bold text-[var(--text-header)] cursor-pointer hover:underline">System Bot</span>
                                    <span class="text-[10px] bg-[#5865F2] text-white px-1 rounded uppercase font-bold flex-shrink-0">BOT</span>
                                    <span class="text-xs text-[var(--interactive-normal)]">Dnes v ${new Date().getHours()}:${String(new Date().getMinutes()).padStart(2, '0')}</span>
                                </div>
                                
                                <div class="text-[var(--text-normal)] mt-1">
                                    <p class="font-bold text-white text-lg">V√≠tej zpƒõt, Kl√°rko! üëã</p>
                                    <p class="text-gray-300 text-sm">Server byl √∫spƒõ≈°nƒõ aktualizov√°n na verzi <code class="bg-[#202225] p-1 rounded text-xs">v2.5 - The Love Update</code>.</p>
                                </div>

                                <div class="mt-3 border-l-4 border-[#faa61a] bg-[#2f3136] rounded p-4 max-w-2xl shadow-sm">
                                    <h3 class="text-white font-bold text-sm mb-3 flex items-center gap-2">
                                        <i class="fas fa-sparkles text-[#faa61a]"></i> Co je nov√©ho?
                                    </h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="flex gap-3">
                                            <div class="text-2xl">üå¶Ô∏è</div>
                                            <div>
                                                <div class="font-bold text-gray-200 text-xs uppercase">Live Poƒças√≠</div>
                                                <p class="text-xs text-gray-400">Pl√°novaƒç rande nyn√≠ ukazuje aktu√°ln√≠ poƒças√≠ v re√°ln√©m ƒçase. U≈æ ≈æ√°dn√© zmoknut√≠!</p>
                                            </div>
                                        </div>

                                        <div class="flex gap-3">
                                            <div class="text-2xl">üì∏</div>
                                            <div>
                                                <div class="font-bold text-gray-200 text-xs uppercase">Vzpom√≠nky v Timeline</div>
                                                <p class="text-xs text-gray-400">U na≈°ich z√°≈æitk≈Ø v Timeline nyn√≠ najde≈° tlaƒç√≠tko "Zobrazit vzpom√≠nky".</p>
                                            </div>
                                        </div>

                                        <div class="flex gap-3">
                                            <div class="text-2xl">üß†</div>
                                            <div>
                                                <div class="font-bold text-gray-200 text-xs uppercase">Smart Search</div>
                                                <p class="text-xs text-gray-400">Naho≈ôe v li≈°tƒõ m≈Ø≈æe≈° hledat cokoliv. Zkus napsat "hlad", "les" nebo "film".</p>
                                            </div>
                                        </div>

                                        <div class="flex gap-3">
                                            <div class="text-2xl">‚≠ê</div>
                                            <div>
                                                <div class="font-bold text-gray-200 text-xs uppercase">Hodnocen√≠ & Den√≠ƒçek</div>
                                                <p class="text-xs text-gray-400">M≈Ø≈æe≈° hodnotit rande i filmy a v√©st si den√≠ƒçek, co jsme u≈æ vidƒõli.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 pt-3 border-t border-[#3f4147] flex justify-between items-center">
                                        <div class="text-[10px] text-gray-400">Patch ID: #ILOVEYOU-3000</div>
                                        <button onclick="switchChannel('dateplanner')" class="bg-[#5865F2] hover:bg-[#4752c4] text-white px-3 py-1 rounded text-xs font-bold transition">
                                            Vyzkou≈°et hned
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="message-group animate-fade-in group hover:bg-black/5 -mx-4 px-4 py-1" style="animation-delay: 0.1s">
                         <div class="flex gap-4 items-start">
                            <div class="w-10 h-10 rounded-full bg-[#faa61a] flex items-center justify-center text-white text-lg font-bold mt-1 shadow-lg cursor-pointer hover:opacity-80 transition flex-shrink-0">
                                ü¶â
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-baseline gap-2">
                                    <span class="font-bold text-[var(--text-header)] cursor-pointer hover:underline">Owl of Wisdom</span>
                                    <span class="text-[10px] bg-[#5865F2] text-white px-1 rounded uppercase font-bold flex-shrink-0">BOT</span>
                                    <span class="text-xs text-[var(--interactive-normal)]">Pr√°vƒõ teƒè</span>
                                </div>
                                <div class="text-[var(--text-normal)] mt-1">
                                    <p class="text-sm">Klikni n√≠≈æe a z√≠skej n√°hodn√Ω fakt pro dne≈°n√≠ den. üëá</p>
                                    
                                    <div id="fact-display" class="mt-2 text-gray-300 italic transition-all duration-300 min-h-[20px]"></div>
                                    
                                    <button onclick="showNextFact()" class="mt-2 border border-[#4f545c] text-xs text-gray-300 hover:bg-[#4f545c] hover:text-white px-3 py-1 rounded transition flex items-center gap-2">
                                        <i class="fas fa-dice"></i> N√°hodn√° zaj√≠mavost
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="message-group animate-fade-in group hover:bg-black/5 -mx-4 px-4 py-1" style="animation-delay: 0.2s">
                        <div class="flex gap-4 items-start">
                            <img src="discord_profilovka.jpg" alt="Jo≈æka" class="w-10 h-10 rounded-full object-cover mt-1 shadow-md cursor-pointer hover:opacity-80 transition flex-shrink-0" loading="lazy">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-baseline gap-2">
                                    <span class="font-bold text-[var(--text-header)] hover:underline cursor-pointer">Jo≈æka</span>
                                    <span class="text-xs text-[var(--interactive-normal)]">Pr√°vƒõ teƒè</span>
                                </div>
                                <div class="text-[var(--text-normal)] mt-1">
                                    <p>Dal≈°√≠ verze Kiscordu. P≈ôidal jsem p√°r secret command≈Ø. Zkus napsat dol≈Ø do chatu t≈ôeba <code>/miluju</code> nebo <code>/sova</code>. üòâ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="new-messages-area"></div>
                    <div class="h-4"></div> </div>

                <div class="px-4 pb-6 pt-2 bg-[#36393f] flex-shrink-0 z-10">
                    <div class="bg-[#40444b] rounded-lg flex items-center p-2.5 px-4 shadow-sm relative">
                        <div class="flex items-center gap-3 mr-4 text-[#b9bbbe]">
                            <button class="hover:text-gray-200 transition bg-gray-600 rounded-full w-5 h-5 flex items-center justify-center text-[10px]"><i class="fas fa-plus"></i></button>
                        </div>
                        
                        <input type="text" id="welcome-chat-input" autocomplete="off" placeholder="Poslat zpr√°vu do #uv√≠t√°n√≠" 
                            class="bg-transparent text-gray-200 placeholder-[#72767d] w-full outline-none font-light text-sm">
                        
                        <div class="flex items-center gap-3 ml-4 text-[#b9bbbe]">
                            <button class="hover:text-yellow-400 transition" title="D√°rek"><i class="fas fa-gift"></i></button>
                            <button class="hover:text-gray-200 transition font-bold text-[10px] bg-[#b9bbbe] text-[#40444b] px-1 rounded-sm">GIF</button>
                            <button class="hover:text-yellow-400 transition"><i class="far fa-smile"></i></button>
                        </div>
                    </div>
                    
                    <div id="typing-indicator" class="absolute bottom-1 left-4 text-[10px] text-gray-400 font-bold hidden flex items-center gap-1">
                        <span class="animate-bounce">‚óè</span><span class="animate-bounce" style="animation-delay:0.1s">‚óè</span><span class="animate-bounce" style="animation-delay:0.2s">‚óè</span> System Bot p√≠≈°e...
                    </div>
                </div>
            `;
            
            // P≈ôipojen√≠ logiky k inputu
            setTimeout(() => {
                const input = document.getElementById('welcome-chat-input');
                if(input) {
                    input.addEventListener('keypress', handleWelcomeChat);
                    input.focus();
                }
            }, 100);
        }

        // --- FUNKCE PRO ZPRACOV√ÅN√ç CHATU ---
        function handleWelcomeChat(e) {
            if (e.key === 'Enter') {
                const text = e.target.value.trim();
                if (!text) return;
                
                // 1. P≈ôidat zpr√°vu u≈æivatele (Kl√°rky)
                addMessageToChat('Kl√°rka', 'klarka_profilovka.webp', text);
                e.target.value = ''; // Vyƒçistit input

                // 2. Zpracovat p≈ô√≠kazy (Easter Eggs)
                processCommand(text);
            }
        }

        function addMessageToChat(name, avatar, text, isBot = false) {
            const container = document.getElementById('new-messages-area');
            const scroller = document.getElementById('chat-scroller');
            
            const div = document.createElement('div');
            div.className = "message-group animate-fade-in group hover:bg-black/5 -mx-4 px-4 py-1 mt-1";
            
            const badge = isBot ? `<span class="text-[10px] bg-[#5865F2] text-white px-1 rounded uppercase font-bold flex-shrink-0 ml-1">BOT</span>` : '';
            const colorClass = isBot ? "text-[#5865F2]" : "text-white";

            div.innerHTML = `
                <div class="flex gap-4 items-start">
                    <img src="${avatar}" class="w-10 h-10 rounded-full object-cover mt-1 shadow-md flex-shrink-0" loading="lazy">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline gap-2">
                            <span class="font-bold text-[var(--text-header)] hover:underline cursor-pointer">${name}</span>
                            ${badge}
                            <span class="text-xs text-[var(--interactive-normal)]">Pr√°vƒõ teƒè</span>
                        </div>
                        <div class="text-[var(--text-normal)] mt-1 ${colorClass}">
                            <p>${text}</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            // Automaticky skrolovat dol≈Ø
            scroller.scrollTop = scroller.scrollHeight;
        }

        function processCommand(text) {
            const lower = text.toLowerCase();
            const indicator = document.getElementById('typing-indicator');
            
            // Funkce pro simulaci psan√≠ bota
            const botReply = (msg, delay = 1000) => {
                if(indicator) indicator.style.display = 'flex'; // Zobrazit "System Bot p√≠≈°e..."
                setTimeout(() => {
                    if(indicator) indicator.style.display = 'none';
                    addMessageToChat('System Bot', 'czippel2_kytka-modified.png', msg, true); // Pou≈æijeme tv√© logo nebo random
                }, delay);
            };

            // --- LOGIKA P≈ò√çKAZ≈Æ (UPDATED) ---
            
            // 1. L√ÅSKA & ROMANTIKA
            if (lower.startsWith('/miluju') || lower.includes('laska') || lower.includes('l√°ska')) {
                botReply("‚ù§Ô∏è Alert: Hladina l√°sky p≈ôekroƒçila kritickou mez! Syst√©m se rozt√©k√°... ‚ù§Ô∏è", 1000);
                if (typeof triggerConfetti === "function") triggerConfetti();
            } 
            
            // 2. ZV√ç≈òATA (Sovy & Chobotnice)
            else if (lower.includes('sova') || lower.includes('sovy') || lower.includes('hou')) {
                // N√°hodn√° odpovƒõƒè pro sovu
                const owlFacts = [
                    "ü¶â H√∫√∫√∫! Vƒõdƒõla jsi, ≈æe sovy nemaj√≠ oƒçn√≠ bulvy, ale oƒçn√≠ v√°lce?",
                    "ü¶â Sova otoƒç√≠ hlavu o 270¬∞. J√° se otoƒç√≠m jen za tebou.",
                    "ü¶â Spirit animal detected: Ponocov√°n√≠ aktivov√°no."
                ];
                botReply(owlFacts[Math.floor(Math.random() * owlFacts.length)], 1000);
            }
            else if (lower.includes('chobotnice') || lower.includes('octopus')) {
                botReply("üêô Chobotnice m√° 3 srdce a modrou krev! (P≈ôesnƒõ tolik srdc√≠ pot≈ôebuju, abych pojal v≈°echnu tu l√°sku k tobƒõ.)", 1000);
            }

            // 3. GAMING (Tetris, Clash, Geoguessr)
            else if (lower.includes('tetris')) {
                botReply("üß© Pad√° to tam! Jsi p≈ôipravena na dal≈°√≠ 1v1? (Jsem ve formƒõ!)", 1000);
            }
            else if (lower.includes('clash') || lower.includes('royale')) {
                botReply("‚öîÔ∏è Ten deck si fakt u≈æ zmƒõ≈à... ale stejnƒõ si d√°me 1v1? üëë", 1000);
            }
            else if (lower.includes('geo') || lower.includes('guessr') || lower.includes('mapa')) {
                botReply("üåç To je na 100% Braz√≠lie. Nebo Rusko. Nebo to k≈ôov√≠ za bar√°kem. Jsem ztracen bez tv√© navigace!", 1500);
            }

            // 4. INSIDE JOKES (Podol√≠, Casio, Nero)
            else if (lower.includes('podol√≠') || lower.includes('podoli')) {
                botReply("üìç Error 404: Location 'Podol√≠' not found. Did you mean: 'Kunovice - P≈ôedmƒõst√≠'?", 1000);
            }
            else if (lower.includes('casio') || lower.includes('kalkulaƒçka')) {
                botReply("üßÆ Nejlep≈°√≠ investice ≈æivota! Ply≈°ov√° kalkulaƒçka > Bitcoin.", 1000);
            }
            else if (lower.includes('nero') || lower.includes('po≈æ√°r') || lower.includes('ohe≈à')) {
                botReply("üî• J√° v√≠m, j√° v√≠m... Nero v ≈ò√≠mƒõ nebyl a na lyru nehr√°l. D√≠ky za fact-check, pan√≠ uƒçitelko! ü§ì", 1200);
            }
            
            // 5. J√çDLO (Vafle, Popcorn)
            else if (lower.includes('hlad') || lower.includes('j√≠dlo') || lower.includes('jidlo')) {
                botReply("üçî Co takhle Kafec u Kom√≠na? Nebo pizzu v Ma≈ôatic√≠ch? Mrkni do Pl√°novaƒçe!", 1000);
                setTimeout(() => switchChannel('dateplanner'), 2500); // P≈ôepne ji to tam
            }
            else if (lower.includes('popcorn') || lower.includes('zuby')) {
                botReply("üçø Popcorn je n√°stroj ƒè√°bla na niƒçen√≠ zub≈Ø! Gum√≠dci jsou superior snack. üêª", 1000);
            }

            // 6. SYST√âMOV√â VƒöCI
            else if (lower.includes('heslo') || lower.includes('password')) {
                botReply("üîê Tajn√© heslo je: 'Podol√≠ neexistuje'. (Ale p≈°≈°t!)", 1000);
            }
            else if (lower.startsWith('/help') || lower.includes('pomoc') || lower.includes('p≈ô√≠kazy')) {
                botReply("ü§ñ **Dostupn√© p≈ô√≠kazy:**\n`/miluju` - Vyzn√°n√≠ l√°sky\n`/sova` - Moudrost\n`/chobotnice` - Biology fact\n`podol√≠` - Reality check\n`tetris` - V√Ωzva\n`nero` - Historick√© ok√©nko\n`hlad` - Pomoc s v√Ωbƒõrem", 500);
            }
            
            // 7. DEFAULT
            else if (lower.startsWith('/')) {
                botReply("‚ùå Nezn√°m√Ω p≈ô√≠kaz. Zkus napsat `/help` pro seznam tajn√Ωch k√≥d≈Ø.", 800);
            }
            else {
                // Pokud nap√≠≈°e jen bƒõ≈æn√Ω text, obƒças m≈Ø≈æe bot zareagovat obecnƒõ (voliteln√©)
                // botReply("üëÄ Zapisuji do den√≠ku...", 2000);
            }
        }
        
        // Jednoduch√° funkce pro konfety (pokud ji nem√°≈°, p≈ôidej si ji nebo ji ignoruj)
        function triggerConfetti() {
             showNotification("üéâ L√ÅSKA DETEKOV√ÅNA! üéâ", "success");
        }

        function showNextFact() {
            const display = document.getElementById('fact-display');
            
            // Efekt zmizen√≠
            display.style.opacity = '0';
            display.style.transform = 'translateY(5px)';
            
            setTimeout(() => {
                // Vybrat n√°hodn√Ω fakt
                const randomFact = animalFacts[Math.floor(Math.random() * animalFacts.length)];
                
                display.innerHTML = `
                    <div class="text-center">
                        <div class="text-3xl mb-2">${randomFact.icon}</div>
                        <span>${randomFact.text}</span>
                    </div>
                `;
                
                // Efekt zobrazen√≠
                display.style.opacity = '1';
                display.style.transform = 'translateY(0)';
            }, 300);
        }

        function renderManual() {
            const container = document.getElementById('messages-container');
            container.innerHTML = `
                <div class="flex gap-4 items-start"><img src="discord_profilovka.jpg" 
                 alt="Jo≈æka" 
                 class="w-10 h-10 rounded-full object-cover mt-1 shadow-md"><div class="flex-1"><div class="flex items-baseline gap-2"><span class="font-bold text-[var(--text-header)]">Jo≈æka</span><span class="text-xs text-[var(--interactive-normal)]">Pinned</span></div><div class="bg-gradient-to-br from-[#2f3136] to-[#202225] border-l-4 border-[#faa61a] p-4 rounded-r-lg mt-3"><h3 class="font-bold text-white text-lg mb-3 flex items-center gap-2"><i class="fas fa-graduation-cap text-[#faa61a]"></i> N√°vod na stahov√°n√≠</h3><div class="space-y-4"><div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-[#5865F2] flex items-center justify-center text-white flex-shrink-0">1</div><div><p class="font-bold text-white">Instalace qBittorrent</p><p class="text-[var(--text-normal)] text-sm">St√°hni si z <a href="https://www.qbittorrent.org/download.php" target="_blank" class="text-[#5865F2] hover:underline font-bold">qbittorrent.org/download</a>. Neboj, nen√≠ to virus.</p></div></div><div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-[#5865F2] flex items-center justify-center text-white flex-shrink-0">2</div><div><p class="font-bold text-white">Magnet Link üß≤</p><p class="text-[var(--text-normal)] text-sm">V knihovnƒõ klikni na ikonu stahov√°n√≠ u polo≈æky. Otev≈ôe se ti to p≈ô√≠mo v klientovi.</p></div></div><div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-[#5865F2] flex items-center justify-center text-white flex-shrink-0">3</div><div><p class="font-bold text-white">HDMI kabel (ten 5m)</p><p class="text-[var(--text-normal)] text-sm">P≈ôipoj notebook k TV, zm√°ƒçkni <code class="bg-black px-1 rounded text-white">Win + P</code> a vyber "Duplicate" nebo "Extend".</p></div></div></div></div></div></div>`;
        }
        
        // --- TIMELINE DATA & GALLERY LOGIC ---
        
        // --- GALERIE STATE ---
        let currentGalleryImages = [];
        let currentImageIndex = 0;
        let currentGalleryTitle = "";

        function openGallery(eventIndex) {
            const event = timelineEvents[eventIndex];
            if (!event.images || event.images.length === 0) return;

            currentGalleryImages = event.images;
            currentImageIndex = 0;
            currentGalleryTitle = event.title;

            updateGalleryUI();
            document.getElementById('gallery-modal').style.display = 'flex';
            
            // Kl√°vesov√© zkratky
            document.addEventListener('keydown', handleGalleryKeys);

            // --- NOV√â: Aktivace swipe gest ---
            initGalleryGestures();
        }

        function closeGallery() {
            document.getElementById('gallery-modal').style.display = 'none';
            document.removeEventListener('keydown', handleGalleryKeys);
        }

        function changeGalleryImage(direction) {
            currentImageIndex += direction;
            // Cyklov√°n√≠ (kdy≈æ dojde na konec, skoƒç√≠ na zaƒç√°tek)
            if (currentImageIndex >= currentGalleryImages.length) currentImageIndex = 0;
            if (currentImageIndex < 0) currentImageIndex = currentGalleryImages.length - 1;
            
            updateGalleryUI();
        }

        function updateGalleryUI() {
            const img = document.getElementById('gallery-image');
            const title = document.getElementById('gallery-title');
            const counter = document.getElementById('gallery-counter');

            // Reset animace pro efekt p≈ôechodu
            img.classList.remove('animate-fade-in');
            void img.offsetWidth; // Trigger reflow
            img.classList.add('animate-fade-in');

            img.src = currentGalleryImages[currentImageIndex];
            title.textContent = currentGalleryTitle;
            counter.textContent = `${currentImageIndex + 1} z ${currentGalleryImages.length}`;
        }

        function handleGalleryKeys(e) {
            if (e.key === 'Escape') closeGallery();
            if (e.key === 'ArrowRight') changeGalleryImage(1);
            if (e.key === 'ArrowLeft') changeGalleryImage(-1);
        }

        // --- OPRAVA: SWIPE GESTA PRO GALERII (S ochranou proti v√≠cen√°sobn√©mu spu≈°tƒõn√≠) ---
        let galleryTouchStartX = 0;
        let galleryTouchEndX = 0;
        let isGalleryGesturesInit = false; // Nov√° pojistka

        function initGalleryGestures() {
            // Pokud u≈æ jsou gesta zapnut√°, ukonƒç√≠me funkci, abychom je nep≈ôidali znovu
            if (isGalleryGesturesInit) return;

            const modal = document.getElementById('gallery-modal');
            
            // Zachyt√≠me zaƒç√°tek dotyku
            modal.addEventListener('touchstart', (e) => {
                galleryTouchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            // Zachyt√≠me konec dotyku a vyhodnot√≠me smƒõr
            modal.addEventListener('touchend', (e) => {
                galleryTouchEndX = e.changedTouches[0].screenX;
                handleGallerySwipe();
            }, { passive: true });

            // Nastav√≠me pojistku na TRUE -> p≈ô√≠≈°tƒõ u≈æ se tento k√≥d neprovede
            isGalleryGesturesInit = true;
            console.log("Gallery gestures initialized.");
        }

        function handleGallerySwipe() {
            const threshold = 50; // Minim√°ln√≠ vzd√°lenost v px pro swipe
            const diff = galleryTouchStartX - galleryTouchEndX;

            if (Math.abs(diff) > threshold) {
                if (diff > 0) {
                    // Swipe DOLEVA (prst jde doleva -> chceme DAL≈†√ç fotku)
                    changeGalleryImage(1);
                } else {
                    // Swipe DOPRAVA (prst jde doprava -> chceme P≈òEDCHOZ√ç fotku)
                    changeGalleryImage(-1);
                }
            }
        }
        
        function renderTimeline() {
            const container = document.getElementById('messages-container');
            
            let html = `
                <div class="p-4 md:p-8 max-w-4xl mx-auto">
                    <h3 class="text-white font-bold text-2xl mb-8 pl-4 border-l-4 border-[#5865F2] animate-fade-in">
                        Na≈°e Spoleƒçn√° Cesta
                    </h3>
                    <div class="relative pl-8 sm:pl-12 border-l-2 border-[#2f3136] ml-2 md:ml-0 space-y-12 pb-10">
            `;

            timelineEvents.forEach((event, index) => {
                // Rozli≈°en√≠ styl≈Ø pro barvy vs gradient
                const isGradient = event.color === 'gradient';
                const circleBg = isGradient ? 'bg-gradient-to-r from-[#5865F2] to-[#eb459e]' : `bg-[${event.color}]`;
                // Pro Tailwind mus√≠me pou≈æ√≠t inline style pro dynamick√© barvy, pokud nejsou v safelistu, 
                // ale zde pou≈æijeme radƒõji inline style pro jistotu.
                const circleStyle = isGradient ? '' : `background-color: ${event.color}`;
                
                // Tlaƒç√≠tko galerie (zobraz√≠ se jen pokud jsou fotky)
                let galleryBtn = '';
                if (event.images && event.images.length > 0) {
                    galleryBtn = `
                        <button onclick="openGallery(${index})" class="mt-3 flex items-center gap-2 bg-[#202225] hover:bg-[#292b2f] text-gray-300 hover:text-white px-3 py-2 rounded transition border border-gray-700 hover:border-gray-500 group/btn">
                            <i class="fas fa-images text-[#5865F2] group-hover/btn:scale-110 transition-transform"></i>
                            <span class="text-xs font-bold uppercase tracking-wide">Zobrazit vzpom√≠nky (${event.images.length})</span>
                        </button>
                    `;
                }

                html += `
                    <div class="relative group animate-fade-in" style="animation-delay: ${index * 100}ms">
                        <div class="absolute -left-[45px] sm:-left-[61px] top-0 w-10 h-10 rounded-full flex items-center justify-center z-10 border-4 border-[#36393f] shadow-lg transition transform group-hover:scale-110" style="${circleStyle}" class="${isGradient ? 'bg-gradient-to-r from-[#5865F2] to-[#eb459e]' : ''}">
                            <i class="fas ${event.icon} text-white text-sm"></i>
                        </div>

                        <div class="bg-[#2f3136] p-5 rounded-lg border border-[#202225] hover:border-[#5865F2]/50 transition shadow-md hover:shadow-xl relative overflow-hidden">
                            ${isGradient ? '<div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#5865F2] to-[#eb459e]"></div>' : ''}
                            
                            <h4 class="font-bold text-white text-lg mb-2 flex items-center gap-2">
                                ${event.title}
                            </h4>
                            <p class="text-gray-300 text-sm leading-relaxed opacity-90">
                                ${event.desc}
                            </p>
                            
                            ${galleryBtn}
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderLibrary(type) {
            const container = document.getElementById('messages-container');
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            let items = library[type].filter(item => item.title.toLowerCase().includes(searchTerm));
            
            // ≈òAZEN√ç:
            // 1. Watchlist
            // 2. Rozkoukan√© (watching)
            // 3. Hodnocen√≠ / Vidƒõno
            items.sort((a, b) => {
                const aWatch = state.watchlist.some(w => w.id === a.id) ? 1 : 0;
                const bWatch = state.watchlist.some(w => w.id === b.id) ? 1 : 0;
                if (aWatch !== bWatch) return bWatch - aWatch;

                // Priorita pro "Rozkouk√°no"
                const aHist = state.watchHistory[a.id] || { status: 'unseen' };
                const bHist = state.watchHistory[b.id] || { status: 'unseen' };
                if (aHist.status === 'watching' && bHist.status !== 'watching') return -1;
                if (bHist.status === 'watching' && aHist.status !== 'watching') return 1;

                const aRate = state.ratings[a.id] || 0;
                const bRate = state.ratings[b.id] || 0;
                return bRate - aRate;
            });

            // Seskupen√≠
            const grouped = items.reduce((acc, item) => {
                const cat = item.cat || 'Ostatn√≠';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(item);
                return acc;
            }, {});

            let html = `<div class="p-4 space-y-8">`;
            const categoryOrder = ["Anim√°ky & Poh√°dky", "Komedie", "Akƒçn√≠ & Sci-Fi", "Drama & Thriller", "Seri√°ly", "Hry", "Ostatn√≠"];
            const sortedCategories = Object.keys(grouped).sort((a, b) => categoryOrder.indexOf(a) - categoryOrder.indexOf(b));

            if (items.length === 0) {
                html += `<div class="text-gray-400 italic text-center mt-10">Nic nenalezeno... :(</div>`;
            } else {
                sortedCategories.forEach(cat => {
                    if (grouped[cat]) {
                        html += `
                            <div>
                                <h3 class="text-[var(--text-header)] font-bold mb-3 uppercase text-xs tracking-wide opacity-80 border-b border-[#2f3136] pb-1 ml-1 flex items-center gap-2">
                                    <i class="fas fa-layer-group"></i> ${cat}
                                </h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                        `;
                        grouped[cat].forEach(item => {
                            const isBookmarked = state.watchlist.some(w => w.id === item.id);
                            const userRating = state.ratings[item.id] || 0;
                            const history = state.watchHistory[item.id] || { status: 'unseen' };
                            
                            // --- Status Badge & Info ---
                            let statusBadge = '';
                            let historyInfo = '';
                            let cardBorderClass = 'border-[#202225]'; // Default border

                            if (history.status === 'seen') {
                                statusBadge = `<div class="absolute top-2 left-2 bg-green-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-md z-10">‚úÖ VIDƒöNO</div>`;
                                // Form√°tov√°n√≠ data (jen den a mƒõs√≠c pro √∫sporu m√≠sta)
                                let dateStr = '';
                                if(history.date) {
                                    const d = new Date(history.date);
                                    dateStr = `${d.getDate()}.${d.getMonth()+1}.`;
                                }
                                historyInfo = `<div class="text-[10px] text-gray-400 mb-1 flex items-center gap-1"><i class="far fa-calendar-alt"></i> ${dateStr} <span class="text-white ml-1">${history.reaction || ''}</span></div>`;
                            } else if (history.status === 'watching') {
                                statusBadge = `<div class="absolute top-2 left-2 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-md z-10 animate-pulse">üëÄ ROZKOUK√ÅNO</div>`;
                                cardBorderClass = 'border-blue-500'; // Zv√Ωraznƒõn√≠ karty
                            }

                            // --- Hvƒõzdiƒçky ---
                            let starsHtml = `<div class="star-rating-group justify-start">`; 
                            for (let i = 5; i >= 1; i--) {
                                const activeClass = i <= userRating ? 'active' : '';
                                starsHtml += `<button onclick="rateItem(${item.id}, ${i})" class="star-btn ${activeClass} text-sm">‚òÖ</button>`;
                            }
                            starsHtml += `</div>`;
                            
                            // --- Kl√°rka Rating Badge ---
                            let ratingBadge = '';
                            if (userRating > 0) {
                                const starsStr = '‚≠ê'.repeat(userRating);
                                ratingBadge = `
                                    <div class="text-[10px] text-[#eb459e] font-bold mt-1 mb-1 flex items-center gap-1 bg-[#202225] w-fit px-2 py-0.5 rounded-full border border-[#eb459e]/30">
                                        <img src="klarka_profilovka.webp" class="w-3 h-3 rounded-full object-cover" loading="lazy">
                                        <span>${starsStr}</span>
                                    </div>
                                `;
                            } else {
                                ratingBadge = `<div class="h-[22px] mt-1 mb-1"></div>`; 
                            }

                            html += `
                                <div class="library-card group ${cardBorderClass}">
                                    <div class="poster-area relative">
                                        ${item.icon}
                                        ${statusBadge}
                                        ${isBookmarked ? `<div class="absolute top-2 right-2 text-[#eb459e] drop-shadow-md text-lg"><i class="fas fa-bookmark"></i></div>` : ''}
                                        ${userRating === 5 ? `<div class="absolute bottom-2 right-2 text-[#faa61a] drop-shadow-md text-lg animate-bounce" title="Masterpiece">üèÜ</div>` : ''}
                                    </div>
                                    
                                    <div class="content-area">
                                        <div class="font-bold text-[var(--text-header)] text-sm truncate" title="${item.title}">${item.title}</div>
                                        
                                        ${historyInfo}
                                        ${ratingBadge}

                                        <div class="flex items-center h-5">
                                            ${starsHtml}
                                        </div>

                                        <div class="card-actions">
                                            <button onclick="openHistoryModal(${item.id})" class="${history.status !== 'unseen' ? 'text-[#3ba55c]' : ''}" data-tooltip="Stav sledov√°n√≠">
                                                <i class="fas ${history.status === 'seen' ? 'fa-check-circle' : (history.status === 'watching' ? 'fa-eye' : 'fa-history')}"></i>
                                            </button>

                                            <button onclick="playTrailer('${item.title}')" data-tooltip="Trailer">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            
                                            <button onclick="toggleBookmark(${item.id}, '${type}')" class="${isBookmarked ? 'text-[#eb459e]' : ''}" data-tooltip="${isBookmarked ? 'Odebrat' : 'Watchlist'}">
                                                <i class="${isBookmarked ? 'fas' : 'far'} fa-bookmark"></i>
                                            </button>
                                            
                                            <button onclick="initiateDownload(${item.id})" class="hover:text-[var(--green)]" data-tooltip="St√°hnout">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                });
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- NOV√â FUNKCE PRO HODNOCEN√ç A TRAILER ---

        function rateItem(id, rating) {
            // Pokud klikne znovu na stejn√© hodnocen√≠, zru≈°√≠ ho (na 0)
            triggerHaptic('medium');
            if (state.ratings[id] === rating) {
                delete state.ratings[id];
            } else {
                state.ratings[id] = rating;
            }
            
            // Ulo≈æit do localStorage
            localStorage.setItem('klarka_ratings', JSON.stringify(state.ratings));
            
            // P≈ôekreslit, aby se zmƒõna hned projevila
            renderLibrary(state.currentChannel);
        }

        // --- WATCH HISTORY LOGIC ---
        let currentHistoryStatus = 'unseen';

        function openHistoryModal(id) {
            const item = state.watchHistory[id] || { status: 'unseen', date: '', reaction: '' };
            
            document.getElementById('history-item-id').value = id;
            document.getElementById('history-modal').style.display = 'flex';
            
            // Nastavit ulo≈æen√© hodnoty
            if(item.date) document.getElementById('history-date').value = item.date;
            else document.getElementById('history-date').valueAsDate = new Date(); // Default dne≈°ek
            
            document.getElementById('history-reaction').value = item.reaction || '';
            
            setHistoryStatus(item.status);
        }

        function setHistoryStatus(status) {
            currentHistoryStatus = status;
            
            // Visual update tlaƒç√≠tek
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.add('opacity-50', 'border-gray-600');
                btn.classList.remove('opacity-100', 'border-[#eb459e]', 'bg-[#2f3136]');
            });
            
            const activeBtn = document.getElementById(`status-${status}`);
            if(activeBtn) {
                activeBtn.classList.remove('opacity-50', 'border-gray-600');
                activeBtn.classList.add('opacity-100', 'border-[#eb459e]', 'bg-[#2f3136]');
            }

            // Show/Hide inputs based on status
            const dateWrapper = document.getElementById('history-date-wrapper');
            const reactionWrapper = document.getElementById('history-reaction-wrapper');

            if (status === 'unseen') {
                dateWrapper.classList.add('hidden');
                reactionWrapper.classList.add('hidden');
            } else if (status === 'watching') {
                dateWrapper.classList.remove('hidden');
                reactionWrapper.classList.add('hidden');
            } else if (status === 'seen') {
                dateWrapper.classList.remove('hidden');
                reactionWrapper.classList.remove('hidden');
            }
        }

        function setReactionInput(emoji) {
            const input = document.getElementById('history-reaction');
            input.value = emoji;
        }

        function saveHistory() {
            const id = document.getElementById('history-item-id').value;
            const date = document.getElementById('history-date').value;
            const reaction = document.getElementById('history-reaction').value;

            // Pokud je unseen, sma≈æeme data, jinak ulo≈æ√≠me
            if (currentHistoryStatus === 'unseen') {
                delete state.watchHistory[id];
            } else {
                state.watchHistory[id] = {
                    status: currentHistoryStatus,
                    date: date,
                    reaction: reaction
                };
            }

            localStorage.setItem('klarka_watch_history', JSON.stringify(state.watchHistory));
            closeModal('history-modal');
            showNotification('Den√≠ƒçek aktualizov√°n! üìù', 'success');
            
            // P≈ôekreslit knihovnu
            renderLibrary(state.currentChannel);
        }

        function rateDate(id, rating) {
            triggerHaptic('medium');
            // Logika: Kliknut√≠ na stejn√© ƒç√≠slo hodnocen√≠ zru≈°√≠
            if (state.dateRatings[id] === rating) {
                delete state.dateRatings[id];
                showNotification("Hodnocen√≠ rande zru≈°eno", "info");
            } else {
                state.dateRatings[id] = rating;
                showNotification("Rande ohodnoceno! ‚ù§Ô∏è", "success");
            }
            
            // Ulo≈æit do localStorage
            localStorage.setItem('klarka_date_ratings', JSON.stringify(state.dateRatings));
            
            // P≈ôekreslit seznam i markery, aby se hvƒõzdy hned uk√°zaly
            // Zjist√≠me aktu√°ln√≠ filtr, abychom ho udr≈æeli
            const currentFilter = document.querySelector('.filter-btn.bg-\\[\\#5865F2\\]')?.dataset.filter || 'all';
            
            // Re-render seznamu
            const searchVal = document.getElementById('planner-search-desktop')?.value || '';
            if(searchVal) searchLocations(searchVal);
            else filterMap(currentFilter);

            // Re-render detailu (aby se aktualizovaly barvy hvƒõzd v panelu)
            selectLocation(id);
        }

        function playTrailer(title) {
            // Otev≈ôe YouTube vyhled√°v√°n√≠ v nov√©m oknƒõ
            const query = encodeURIComponent(`${title} trailer`);
            const url = `https://www.youtube.com/results?search_query=${query}`;
            window.open(url, '_blank');
        }

        function renderUpgrade() {
            const container = document.getElementById('messages-container');
            container.innerHTML = `
            <div class="message-group">
                <div class="message-actions">
                    <i class="fas fa-download text-gray-400 hover:text-white cursor-pointer p-1" data-tooltip="Rychl√© sta≈æen√≠"></i>
                </div>
                <div class="flex gap-4 items-start">
                    <img src="discord_profilovka.jpg" alt="Jo≈æka" class="w-10 h-10 rounded-full object-cover mt-1 shadow-md" loading="lazy">
                    <div class="flex-1">
                        <div class="flex items-baseline gap-2">
                            <span class="font-bold text-[var(--text-header)]">Jo≈æka</span>
                            <span class="text-xs text-[var(--interactive-normal)]">Pinned</span>
                        </div>
                        <div onclick="startConfession()" class="mt-4 bg-[#2f3136] border border-[#292b2f] rounded p-3 flex items-center gap-3 w-full max-w-sm cursor-pointer hover:bg-[#36393f] transition group">
                            <div class="file-icon-wrapper w-10 h-10 flex items-center justify-center text-4xl text-[#5865F2]">
                                <i class="fas fa-file-code"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-[#5865F2] font-medium truncate group-hover:underline text-sm">system_patch_v2.0.exe</div>
                                <div class="text-xs text-[#b9bbbe]">1.2 MB ‚Ä¢ Executable</div>
                            </div>
                            <div class="text-[#b9bbbe] hover:text-white transition text-lg">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderDatePlanner() {
            const container = document.getElementById('messages-container');
            
            // HTML struktura
            container.innerHTML = `
                <div class="relative w-full h-full flex flex-col md:flex-row overflow-hidden bg-[#36393f]">
                    
                    <div class="md:hidden absolute top-4 left-4 right-4 z-[1000] flex gap-2">
                        <div class="flex-1 bg-[#202225]/90 backdrop-blur shadow-lg rounded-lg flex items-center px-3 py-2 border border-gray-700">
                            <i class="fas fa-search text-gray-400 mr-2"></i>
                            <input type="text" id="planner-search-mobile" oninput="searchLocations(this.value)" placeholder="Kam vyraz√≠me?" class="bg-transparent text-white text-sm w-full outline-none placeholder-gray-500">
                        </div>
                        
                        <button onclick="pickRandomLocation()" class="bg-[#eb459e] text-white w-10 h-10 rounded-lg shadow-lg flex items-center justify-center flex-shrink-0 active:scale-95 transition" title="Zkusit ≈°tƒõst√≠">
                            <i class="fas fa-dice"></i>
                        </button>

                        <button onclick="toggleMobileList()" class="bg-[#5865F2] text-white w-10 h-10 rounded-lg shadow-lg flex items-center justify-center flex-shrink-0 active:scale-95 transition">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>

                    <div class="md:hidden absolute top-16 left-0 right-0 z-[1000] px-1 overflow-x-auto hide-scrollbar flex gap-1 pb-2 justify-center">
                         <button onclick="filterMap('all')" data-filter="all" class="filter-btn px-2.5 py-1.5 bg-[#202225]/90 backdrop-blur text-gray-300 rounded-full text-xs shadow-md border border-gray-700 whitespace-nowrap transition-all duration-200">V≈°e</button>
                         <button onclick="filterMap('walk')" data-filter="walk" class="filter-btn px-2.5 py-1.5 bg-[#202225]/90 backdrop-blur text-gray-300 rounded-full text-xs shadow-md border border-gray-700 whitespace-nowrap transition-all duration-200"><i class="fas fa-tree mr-1"></i> Proch√°zky</button>
                         <button onclick="triggerHaptic('light');filterMap('view')" data-filter="view" class="filter-btn px-2.5 py-1.5 bg-[#202225]/90 backdrop-blur text-gray-300 rounded-full text-xs shadow-md border border-gray-700 whitespace-nowrap transition-all duration-200"><i class="fas fa-binoculars mr-1"></i> V√Ωhledy</button>
                         <button onclick="filterMap('fun')" data-filter="fun" class="filter-btn px-2.5 py-1.5 bg-[#202225]/90 backdrop-blur text-gray-300 rounded-full text-xs shadow-md border border-gray-700 whitespace-nowrap transition-all duration-200"><i class="fas fa-bolt mr-1"></i> Z√°bava</button>
                         <button onclick="filterMap('food')" data-filter="food" class="filter-btn px-2.5 py-1.5 bg-[#202225]/90 backdrop-blur text-gray-300 rounded-full text-xs shadow-md border border-gray-700 whitespace-nowrap transition-all duration-200"><i class="fas fa-utensils mr-1"></i> J√≠dlo</button>
                    </div>

                    <div id="planner-sidebar" class="w-full md:w-80 bg-[#2f3136] border-r border-[#202225] flex-col flex-shrink-0 z-30 shadow-lg mobile-list-overlay md:flex md:relative pt-[120px] md:pt-0">
                        
                        <div class="hidden md:block p-4 border-b border-[#202225] bg-[#2f3136]">
                            <h2 class="text-white font-bold flex items-center gap-2 mb-3 w-full">
                                <span class="flex items-center gap-2"><i class="fas fa-map-marked-alt text-[#eb459e]"></i> Kam vyraz√≠me?</span>
                                
                                <button onclick="pickRandomLocation()" class="ml-auto text-xs bg-[#202225] hover:bg-[#eb459e] border border-gray-600 hover:border-[#eb459e] text-gray-300 hover:text-white px-2 py-1 rounded transition flex items-center gap-1 group">
                                    <i class="fas fa-dice group-hover:rotate-180 transition-transform duration-500"></i>
                                    <span>Zkusit ≈°tƒõst√≠</span>
                                </button>
                            </h2>
                            <div class="flex gap-1 overflow-x-auto custom-scrollbar pb-2 mb-2">
                                <button onclick="filterMap('all')" data-filter="all" class="filter-btn px-3 py-1 bg-[#202225] text-gray-300 rounded text-xs whitespace-nowrap hover:bg-[#40444b] transition-colors">V≈°e</button>
                                <button onclick="filterMap('walk')" data-filter="walk" class="filter-btn px-3 py-1 bg-[#202225] text-gray-300 rounded text-xs whitespace-nowrap hover:bg-[#40444b] transition-colors">Proch√°zky</button>
                                <button onclick="triggerHaptic('light');filterMap('view')" data-filter="view" class="filter-btn px-3 py-1 bg-[#202225] text-gray-300 rounded text-xs whitespace-nowrap hover:bg-[#40444b] transition-colors">V√Ωhledy</button>
                                <button onclick="filterMap('fun')" data-filter="fun" class="filter-btn px-3 py-1 bg-[#202225] text-gray-300 rounded text-xs whitespace-nowrap hover:bg-[#40444b] transition-colors">Z√°bava</button>
                                <button onclick="filterMap('food')" data-filter="food" class="filter-btn px-3 py-1 bg-[#202225] text-gray-300 rounded text-xs whitespace-nowrap hover:bg-[#40444b] transition-colors">J√≠dlo</button>
                            </div>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-500"></i></div>
                                <input type="text" id="planner-search-desktop" oninput="searchLocations(this.value)" placeholder="Hledat m√≠sto..." class="w-full bg-[#202225] text-white text-xs rounded pl-8 pr-2 py-2 border border-[#202225] focus:border-[#5865F2] focus:outline-none transition">
                            </div>
                        </div>

                        <div class="px-4 py-3 bg-[#292b2f] border-b border-[#202225] flex-shrink-0">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-[var(--pink)] font-bold text-xs uppercase tracking-wide">üó∫Ô∏è Trasa (<span id="route-count">0</span>)</h3>
                                <button onclick="toggleMobileList()" class="md:hidden text-gray-400"><i class="fas fa-times"></i></button>
                                <button onclick="clearRoute()" class="hidden md:block text-[10px] text-gray-400 hover:text-white underline">Smazat</button>
                            </div>
                            <div id="route-list" class="space-y-1 mb-2 text-gray-400 text-xs italic max-h-20 overflow-y-auto">Zat√≠m ≈æ√°dn√© zast√°vky...</div>
                            <button onclick="openRouteInGoogle()" id="open-route-btn" class="w-full bg-[#202225] text-gray-500 py-2 rounded text-xs font-bold cursor-not-allowed transition" disabled>Otev≈ô√≠t v Google Maps</button>
                        </div>
                        
                        <div id="location-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1 pb-20 md:pb-2"></div>
                    </div>

                    <div class="flex-1 flex flex-col relative bg-[#36393f] w-full h-full">
                        <div id="map-container" class="absolute inset-0 z-0">
                            <div id="leaflet-map"></div>
                        </div>

                        <div id="detail-panel" class="absolute bottom-0 left-0 right-0 p-0 transition-transform duration-300 z-[500] transform translate-y-full mobile-map-overlay">                            
                            
                            <div id="sheet-handle" class="sheet-handle-area touch-none bg-[#2f3136] rounded-t-2xl border-b border-[#202225] flex-shrink-0 cursor-grab active:cursor-grabbing py-3">
                                <div class="sheet-handle-bar bg-gray-600 w-12 h-1.5 rounded-full mx-auto"></div>
                            </div>

                            <button onclick="closeDetailPanel()" class="absolute top-3 right-4 text-gray-400 p-2 hover:text-white z-50 bg-[#2f3136]/50 rounded-full"><i class="fas fa-times"></i></button>

                            <div id="detail-content" class="flex-1 overflow-y-auto p-4 pt-2 bg-[#2f3136]">
                                    <div>
                                        <h3 class="text-xl font-bold text-white flex items-center gap-2 flex-wrap">
                                            <span id="detail-title">N√°zev</span>
                                            <span id="detail-cat" class="text-[10px] px-2 py-0.5 rounded bg-[#5865F2] text-white uppercase tracking-wider">KAT</span>
                                            <span id="detail-weather-badge"></span> </h3>
                                        <p id="detail-desc" class="text-gray-400 text-sm mt-1">Popis...</p>
                                        <div id="detail-rating-container"></div> 
                                    </div>
                                    
                                    <div class="flex gap-2 mb-4 mt-4">
                                        <button id="add-to-route-btn" onclick="triggerHaptic('success'); addToRoute()" class="flex-1 text-xs bg-[#5865F2] hover:bg-[#4752c4] text-white px-3 py-3 rounded transition font-bold shadow-md">
                                            <i class="fas fa-plus"></i> P≈ôidat
                                        </button>
                                        <a id="detail-google" href="#" target="_blank" class="flex-1 text-center text-xs bg-[#202225] hover:bg-[#eb459e] text-gray-300 hover:text-white px-3 py-3 rounded transition font-bold border border-gray-600">
                                            <i class="fas fa-external-link-alt"></i> Mapa
                                        </a>
                                    </div>

                                    <div class="grid grid-cols-1 gap-3 bg-[#202225] p-3 rounded-lg border border-[#202225]">
                                        <div>
                                            <label class="block text-[#b9bbbe] text-[10px] font-bold uppercase mb-1">Kdy to vid√≠≈°?</label>
                                            <input type="datetime-local" id="date-input" class="w-full bg-[#2f3136] text-white p-2 rounded border border-[#40444b] outline-none text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-[#b9bbbe] text-[10px] font-bold uppercase mb-1">Pozn√°mka</label>
                                            <div class="flex gap-2">
                                                <input type="text" id="note-input" placeholder="D√°me pak kafe?" class="flex-1 bg-[#2f3136] text-white p-2 rounded border border-[#40444b] outline-none text-sm">
                                                <button onclick="copyDateInvite()" class="bg-[#3ba55c] hover:bg-[#2d7d46] text-white px-3 rounded font-bold transition flex items-center gap-2 text-sm">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            filterMap('all'); // Initialize
            updateRouteUI(); 
            
            setTimeout(() => {
                initMap();
                // Inicializace gest panelu
                setTimeout(() => {
                    initBottomSheetGestures();
                }, 500); // Mal√° prodleva, aby se DOM stihl vykreslit
                if(state.mapInstance) state.mapInstance.invalidateSize();
            }, 100);
        }

        // --- WEATHER UTILS ---
        function getWeatherInfo(code) {
            // WMO Weather interpretation codes (WW)
            const map = {
                0: { icon: '‚òÄÔ∏è', text: 'Jasno' },
                1: { icon: 'üå§Ô∏è', text: 'Skoro jasno' },
                2: { icon: '‚õÖ', text: 'Polojasno' },
                3: { icon: '‚òÅÔ∏è', text: 'Zata≈æeno' },
                45: { icon: 'üå´Ô∏è', text: 'Mlha' },
                48: { icon: 'üå´Ô∏è', text: 'Mlha' },
                51: { icon: 'üå¶Ô∏è', text: 'Mrholen√≠' },
                53: { icon: 'üå¶Ô∏è', text: 'Mrholen√≠' },
                55: { icon: 'üåßÔ∏è', text: 'Hust√© mrholen√≠' },
                61: { icon: 'üåßÔ∏è', text: 'Slab√Ω d√©≈°≈•' },
                63: { icon: 'üåßÔ∏è', text: 'D√©≈°≈•' },
                65: { icon: 'üåßÔ∏è', text: 'Siln√Ω d√©≈°≈•' },
                71: { icon: '‚ùÑÔ∏è', text: 'Slab√Ω sn√≠h' },
                73: { icon: '‚ùÑÔ∏è', text: 'Sn√≠h' },
                75: { icon: '‚ùÑÔ∏è', text: 'Siln√Ω sn√≠h' },
                77: { icon: '‚ùÑÔ∏è', text: 'Snƒõhov√© zrna' },
                80: { icon: 'üåßÔ∏è', text: 'P≈ôeh√°≈àky' },
                81: { icon: 'üåßÔ∏è', text: 'Siln√© p≈ôeh√°≈àky' },
                82: { icon: '‚õàÔ∏è', text: 'Pr≈Øtr≈æ mraƒçen' },
                95: { icon: '‚õàÔ∏è', text: 'Bou≈ôka' },
                96: { icon: '‚õàÔ∏è', text: 'Bou≈ôka s kroupami' },
                99: { icon: '‚õàÔ∏è', text: 'Siln√° bou≈ôka' }
            };
            return map[code] || { icon: 'üå°Ô∏è', text: 'Nezn√°m√©' };
        }

        async function fetchLocationWeather(lat, lng) {
            const weatherContainer = document.getElementById('detail-weather-badge');
            
            // Loading stav
            if(weatherContainer) {
                weatherContainer.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Naƒç√≠t√°m poƒças√≠...`;
                weatherContainer.className = "text-[10px] px-2 py-0.5 rounded bg-[#202225] text-gray-400 border border-gray-700 flex items-center gap-1";
            }

            try {
                // Vol√°n√≠ Open-Meteo API
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                const data = await response.json();
                
                const weather = data.current_weather;
                const info = getWeatherInfo(weather.weathercode);
                
                // Update UI
                if(weatherContainer) {
                    weatherContainer.innerHTML = `${info.icon} ${Math.round(weather.temperature)}¬∞C ‚Ä¢ ${info.text}`;
                    // Zmƒõn√≠me barvu podle teploty (pro efekt)
                    if(weather.temperature < 5) weatherContainer.className = "text-[10px] px-2 py-0.5 rounded bg-[#2f3136] text-blue-300 border border-blue-900/50 font-bold animate-fade-in";
                    else if(weather.temperature > 25) weatherContainer.className = "text-[10px] px-2 py-0.5 rounded bg-[#2f3136] text-orange-400 border border-orange-900/50 font-bold animate-fade-in";
                    else weatherContainer.className = "text-[10px] px-2 py-0.5 rounded bg-[#2f3136] text-white border border-gray-600 font-bold animate-fade-in";
                }
            } catch (error) {
                console.error("Weather error:", error);
                if(weatherContainer) weatherContainer.innerHTML = "‚ö†Ô∏è Poƒças√≠ nedostupn√©";
            }
        }

        // --- MOBILE PLANNER LOGIC ---

        function toggleMobileList() {
            const sidebar = document.getElementById('planner-sidebar');
            sidebar.classList.toggle('active');
        }

        function closeDetailPanel() {
            const panel = document.getElementById('detail-panel');
            
            // Zav≈ôeme panel posunut√≠m dol≈Ø (funguje teƒè na mobilu i PC)
            if (panel) {
                panel.style.transform = 'translateY(100%)';
            }
            
            // Zru≈°√≠me v√Ωbƒõr
            selectedDateLocation = null;
        }

        // --- ROUTE PLANNER LOGIC ---
        function addToRoute() {
            if(!selectedDateLocation) return;
            
            // Kontrola, jestli u≈æ m√≠sto v trase nen√≠
            if(state.route.some(loc => loc.id === selectedDateLocation.id)) {
                showNotification("U≈æ je v trase!", "info");
                return;
            }
            
            // P≈ôid√°n√≠ do pole a aktualizace UI
            state.route.push(selectedDateLocation);
            updateRouteUI();
            showNotification(`P≈ôid√°no: ${selectedDateLocation.name}`, "success");

            // --- MOBILN√ç FIX: Automaticky uk√°zat pl√°novaƒç ---
            if (window.innerWidth < 768) {
                // 1. Zav≈ôeme detail panel (to okno dole)
                closeDetailPanel();
                
                // 2. Otev≈ôeme sidebar (seznam tras), aby vidƒõla, ≈æe se to tam p≈ôidalo
                const sidebar = document.getElementById('planner-sidebar');
                if (sidebar) {
                    sidebar.classList.add('active');
                    // Pro jistotu vyrolujeme nahoru, kde je sekce "Trasa"
                    sidebar.scrollTop = 0; 
                }
            }
        }

        function removeFromRoute(id) {
            state.route = state.route.filter(loc => loc.id !== id);
            updateRouteUI();
        }

        function clearRoute() {
            state.route = [];
            updateRouteUI();
        }

        function updateRouteUI() {
            const list = document.getElementById('route-list');
            const count = document.getElementById('route-count');
            const btn = document.getElementById('open-route-btn');
            
            if(!list) return; // Guard clause if not rendered

            count.innerText = state.route.length;

            if(state.route.length === 0) {
                list.innerHTML = '<span class="text-gray-500 italic pl-1">Vyber m√≠sta a klikni na "+ P≈ôidat do trasy"</span>';
                btn.classList.add('bg-[#202225]', 'text-gray-500', 'cursor-not-allowed');
                btn.classList.remove('bg-[#5865F2]', 'text-white', 'hover:bg-[#4752c4]');
                btn.disabled = true;
            } else {
                list.innerHTML = '';
                state.route.forEach((loc, index) => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-[#202225] p-1.5 rounded border border-gray-700 animate-fade-in">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <div class="bg-[#5865F2] w-4 h-4 rounded-full flex items-center justify-center text-[8px] text-white font-bold flex-shrink-0">${index + 1}</div>
                                <span class="text-white text-xs truncate">${loc.name}</span>
                            </div>
                            <button onclick="removeFromRoute(${loc.id})" class="text-red-400 hover:text-red-200 px-1"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                });
                btn.classList.remove('bg-[#202225]', 'text-gray-500', 'cursor-not-allowed');
                btn.classList.add('bg-[#5865F2]', 'text-white', 'hover:bg-[#4752c4]');
                btn.disabled = false;
            }
        }

        function openRouteInGoogle() {
            if(state.route.length === 0) return;
            
            // Zaƒçneme z√°kladn√≠ URL pro trasy
            let url = "https://www.google.com/maps/dir/";
            
            // P≈ôid√°me sou≈ôadnice v≈°ech bod≈Ø v trase
            state.route.forEach(loc => {
                url += `${loc.lat},${loc.lng}/`;
            });
            
            window.open(url, '_blank');
        }

        function filterDates(filter) {
            state.dateFilter = filter;
            renderDatePlanner();
        }

        function openMap(query) {
            // Pou≈æijeme ofici√°ln√≠ URL pro vyhled√°v√°n√≠ v Google Map√°ch
            const url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(query);
            window.open(url, '_blank');
}

        function renderMusic() {
            const container = document.getElementById('messages-container');
            // Vlo≈æ Embed k√≥d ze Spotify - Full Screen verze
            container.innerHTML = `
                <div class="flex flex-col h-full w-full p-4">
                    <div class="flex items-center gap-4 mb-4 flex-shrink-0">
                        <div class="w-12 h-12 bg-[#1DB954] rounded-full flex items-center justify-center text-white text-2xl animate-pulse shadow-lg flex-shrink-0">
                            <i class="fab fa-spotify"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">Music Bot ü§ñ</h2>
                            <p class="text-gray-400 text-sm">Playlist: <span class="text-[#1DB954]">Our Vibe</span> ‚Ä¢ P≈ôehr√°v√° se...</p>
                        </div>
                    </div>
                    
                    <div class="flex-1 w-full bg-[#202225] rounded-xl overflow-hidden relative shadow-2xl border border-[#202225]">
                        <iframe style="border-radius:12px" 
                            src="https://open.spotify.com/embed/playlist/2zUVrUmI3NHhIPtiboRE9O?utm_source=generator" 
                            width="100%" height="100%" frameBorder="0" allowfullscreen="" 
                            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                            loading="lazy" class="absolute inset-0">
                        </iframe>                    
                    </div>
                    
                    <p class="text-xs text-gray-600 mt-2 text-center select-none flex-shrink-0">
                        <i class="fas fa-info-circle mr-1"></i> Pro p≈ôehr√°n√≠ cel√Ωch skladeb bez limitu se p≈ôihla≈° do Spotify v tomto oknƒõ.
                    </p>
                </div>
            `;
        }

        function inviteToDate(title) {
             const message = `üìÖ **POZV√ÅNKA NA RANDE**\n\nüìç **Kam:** ${title}\n‚ùì **Kdy:** (Dopl≈à datum)\n\n*Odesl√°no z Pl√°novaƒçe*`;
             
             // Create a temporary modal for confirmation
             const modal = document.createElement('div');
             modal.className = 'fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in';
             modal.innerHTML = `
                <div class="bg-[#36393f] p-6 rounded-xl border border-[#5865F2] max-w-sm text-center shadow-2xl">
                    <div class="text-4xl mb-2">üíå</div>
                    <h3 class="text-xl font-bold text-white mb-2">Skvƒõl√° volba!</h3>
                    <p class="text-gray-300 text-sm mb-6">M√°m ti p≈ôipravit pozv√°nku na <strong>${title}</strong> do schr√°nky?</p>
                    <div class="flex gap-2">
                        <button id="copy-invite-btn" class="flex-1 bg-[#5865F2] hover:bg-[#4752c4] text-white py-2 rounded font-bold transition">Ano, zkop√≠rovat</button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-[#202225] hover:bg-[#2f3136] text-gray-400 hover:text-white py-2 rounded font-bold transition">Zru≈°it</button>
                    </div>
                </div>
             `;
             document.body.appendChild(modal);
             
             document.getElementById('copy-invite-btn').onclick = function() {
                 navigator.clipboard.writeText(message).then(() => {
                     showNotification('Pozv√°nka zkop√≠rov√°na! Po≈°li mi ji na Discordu.', 'success');
                     modal.remove();
                 });
             };
        }


        // --- WATCHLIST LOGIC ---
        function toggleBookmark(id, type) {
            let item;
            for(let k in library) { item = library[k].find(i => i.id === id); if(item) { item.type = type; break; } }
            const idx = state.watchlist.findIndex(w => w.id === id);
            if(idx === -1) { state.watchlist.push(item); showNotification('P≈ôid√°no', 'success'); }
            else { state.watchlist.splice(idx, 1); showNotification('Odebr√°no', 'info'); }
            localStorage.setItem('klarka_watchlist', JSON.stringify(state.watchlist));
            updateBookmarkCounter();
            if(['movies','series','games'].includes(state.currentChannel)) renderLibrary(state.currentChannel);
        }
        function updateBookmarkCounter() {
            const count = state.watchlist.length;
            const counter = document.getElementById('bookmark-count');
            const counterContainer = document.getElementById('bookmark-counter');
            
            // Only update if the elements exist in the DOM
            if (counter && counterContainer) {
                counter.textContent = count;
                counterContainer.style.display = count > 0 ? 'flex' : 'none';
            }
        }
        function showWatchlist() {
            document.getElementById('watchlist-modal').style.display = 'flex';
            const container = document.getElementById('watchlist-items');
            document.getElementById('watchlist-total').textContent = state.watchlist.length;
            if(state.watchlist.length === 0) container.innerHTML = '<div class="text-center text-gray-500 py-10">Pr√°zdno.</div>';
            else container.innerHTML = state.watchlist.map(i => `<div class="bg-[#2f3136] p-3 rounded flex justify-between items-center mb-2"><div class="flex items-center gap-3"><span class="text-xl">${i.icon}</span><span class="text-white">${i.title}</span></div><button onclick="toggleBookmark(${i.id},'${i.type}');showWatchlist()" class="text-[#ed4245]"><i class="fas fa-trash"></i></button></div>`).join('');
        }
        function clearWatchlist() {
            if(confirm('Vyƒçistit?')) { state.watchlist = []; localStorage.setItem('klarka_watchlist', '[]'); showWatchlist(); updateBookmarkCounter(); if(['movies','series','games'].includes(state.currentChannel)) renderLibrary(state.currentChannel); showNotification('Watchlist vyƒçi≈°tƒõn', 'info'); }
        }
        function exportWatchlist() {
            if(state.watchlist.length === 0) { showNotification('Watchlist je pr√°zdn√Ω!', 'warning'); return; }
            const listText = state.watchlist.map(item => `‚Ä¢ ${item.title} (${item.type === 'movies' ? 'Film' : item.type === 'series' ? 'Seri√°l' : 'Hra'})`).join('\n');
            const fullText = `üßæ N√Å≈† SPOLEƒåN√ù WATCHLIST\n\n${listText}\n\nüìÖ Vytvo≈ôeno: ${new Date().toLocaleDateString('cs-CZ')}\n‚ù§Ô∏è Tƒõ≈°√≠m se na spoleƒçn√© sledov√°n√≠!`;
            const fallbackCopy = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select(); try { document.execCommand('copy'); showNotification('Watchlist zkop√≠rov√°n do schr√°nky!', 'success'); } catch (err) { showNotification('Nepoda≈ôilo se zkop√≠rovat text', 'error'); } document.body.removeChild(textArea); };
            if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(fullText).then(() => showNotification('Watchlist zkop√≠rov√°n do schr√°nky!', 'success')).catch(() => fallbackCopy(fullText));
            else fallbackCopy(fullText);
        }
        function showNotification(msg, type) {
            const div = document.createElement('div'); div.className = `fixed top-4 right-4 text-white px-4 py-2 rounded shadow-lg z-[100] ${type==='success'?'bg-[#3ba55c]':'bg-[#5865F2]'}`;
            div.innerHTML = msg; document.body.appendChild(div); setTimeout(()=>div.remove(), 3000);
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // --- DOWNLOAD ---
        function initiateDownload(id) {
            let item = null;
            for (const category in library) { const found = library[category].find(i => i.id === id); if (found) { item = found; break; } }
            if (!item) return;
            state.currentDownload = item;
            document.getElementById('download-message').textContent = `St√°hnout "${item.title}"?`;
            document.getElementById('download-modal').style.display = 'flex';
        }

        function openMagnetLink() { 
            if (state.currentDownload && state.currentDownload.magnet) {
                // T√≠mto ≈ô√°dkem skuteƒçnƒõ "proklikne≈°" magnet link
                window.location.href = state.currentDownload.magnet;
                showNotification('Spou≈°t√≠m qBittorrent...', 'success'); 
            } else {
                showNotification('Magnet link nenalezen.', 'error');
            }
            closeModal('download-modal'); 
}
        function openGoogleDrive() { 
    if (state.currentDownload && state.currentDownload.gdrive && state.currentDownload.gdrive !== "") {
        // Otev≈ôe odkaz na Google Drive v nov√©m oknƒõ/panelu
        window.open(state.currentDownload.gdrive, '_blank');
        showNotification('Otev√≠r√°m Google Drive...', 'success'); 
    } else {
        // Pokud odkaz v datech chyb√≠, upozorn√≠me u≈æivatele
        showNotification('Odkaz na Google Drive nen√≠ k dispozici.', 'info');
    }
    closeModal('download-modal'); 
}

        // --- CONFESSION ---
        function startConfession() {
            // Play music 1
            const music1 = document.getElementById('audio-final-countdown');
            if(music1) {
                music1.currentTime = 0;
                music1.volume = 0.5;
                music1.play().catch(e => console.log("Audio play failed:", e));
            }

            const modal = document.getElementById('confession-modal');
            const output = document.getElementById('terminal-output');
            const typingArea = document.getElementById('typing-area');
            const promptText = document.getElementById('prompt-text');
            const cmdCursor = document.getElementById('cmd-cursor');
            
            // Reset CMD window
            modal.style.display = 'flex';
            output.innerHTML = `<div>Microsoft Windows [Version 10.0.19045]</div><div>(c) Microsoft Corporation. All rights reserved.</div><br>`;
            typingArea.textContent = '';
            promptText.textContent = "C:\\Users\\Kl√°rka\\Heart>";
            cmdCursor.style.display = 'inline-block';
            
            const command = " system_patch_v2.0.exe";
            let charIndex = 0;
            const lines = ["Loading shared memory database...", "‚úì Discord logs... OK", "‚úì Co-op games... OK", "‚úì Inside jokes... OK", "Running compatibility analysis...", ">> Humor: MATCH", ">> Values: SYNCED", "Tetris Logic: Perfect fit detected.", "Analysis complete.", "Decrypting final message..."];
            
            function typeCommand() {
                if (charIndex < command.length) { 
                    typingArea.textContent += command.charAt(charIndex); 
                    charIndex++; 
                    setTimeout(typeCommand, Math.random() * 50 + 50); 
                } else {
                    setTimeout(runLogs, 500);
                }
            }

            function runLogs() {
                const cmdLine = document.createElement('div');
                cmdLine.innerHTML = `C:\\Users\\Kl√°rka\\Heart>${command}`;
                output.appendChild(cmdLine);
                typingArea.textContent = ''; promptText.textContent = ''; cmdCursor.style.display = 'none';
                
                let lineIndex = 0;
                function printLine() {
                    if (lineIndex < lines.length) {
                        const div = document.createElement('div');
                        div.textContent = lines[lineIndex];
                        output.appendChild(div);
                        document.getElementById('terminal-body').scrollTop = document.getElementById('terminal-body').scrollHeight;
                        lineIndex++;
                        
                        if(lineIndex === lines.length) {
                             // Konec log≈Ø - ƒçek√°me na kliknut√≠
                             const cursorSpan = document.createElement('span');
                             cursorSpan.className = 'cmd-cursor';
                             cursorSpan.innerText = ' ';
                             const pressKey = document.createElement('span');
                             pressKey.className = 'animate-pulse text-gray-500 ml-2';
                             pressKey.innerText = 'Press any key to continue...';
                             
                             const lastLine = document.createElement('div');
                             lastLine.appendChild(pressKey);
                             lastLine.appendChild(cursorSpan);
                             output.appendChild(lastLine);
                             
                             const proceed = () => {
                                document.removeEventListener('keydown', proceed);
                                document.removeEventListener('click', proceed);
                                document.getElementById('confession-modal').style.display = 'none';
                                
                                // Switch Music
                                const music1 = document.getElementById('audio-final-countdown');
                                const music2 = document.getElementById('audio-divka');
                                if(music1) music1.pause();
                                if(music2) {
                                    music2.currentTime = 0;
                                    music2.volume = 0.5;
                                    music2.play().catch(e => console.log("Audio 2 play failed:", e));
                                }

                                const finalModal = document.getElementById('final-confession-modal');
                                const modalBox = document.getElementById('final-modal-box');
                                const finalModalContent = document.getElementById('final-modal-content');

                                // --- OPRAVA: TADY V≈ΩDY RESETUJEME OBSAH OKNA ---
                                // Vr√°t√≠me tam p≈Øvodn√≠ HTML pro psan√≠ textu a tlaƒç√≠tka,
                                // i kdy≈æ to Kl√°rka minule p≈ôepsala kliknut√≠m na "Ano".
                                finalModalContent.innerHTML = `
                                    <div id="typing-container" class="text-gray-300 mb-8 text-left space-y-4 leading-relaxed min-h-[200px] mt-8"></div>
                                    <div id="confession-buttons" class="space-y-3 hidden">
                                        <button onclick="responseYes()" class="w-full bg-gradient-to-r from-[#eb459e] to-[#5865F2] hover:opacity-90 text-white py-4 rounded-lg font-bold text-lg transition shadow-lg">Ano, pojƒème to zkusit <i class="fas fa-heart ml-2"></i></button>
                                        <button onclick="responseNo()" class="w-full bg-[#4f545c] hover:bg-[#5d6269] text-white py-3 rounded-lg transition">Z≈Østa≈àme kamar√°di</button>
                                    </div>
                                `;
                                // -----------------------------------------------
                                
                                finalModal.style.display = 'flex';
                                
                                setTimeout(() => {
                                    modalBox.classList.remove('opacity-0', 'scale-95');
                                    modalBox.classList.add('opacity-100', 'scale-100');
                                    setTimeout(typeFinalMessage, 500);
                                }, 50);
                             };
                             
                             setTimeout(() => {
                                document.addEventListener('keydown', proceed);
                                document.addEventListener('click', proceed);
                             }, 500);
                        } else {
                            setTimeout(printLine, 400 + Math.random() * 400);
                        }
                    }
                }
                printLine();
            }
            typeCommand();
        }

        function typeFinalMessage() {
            const container = document.getElementById('typing-container');
            container.innerHTML = '';
            document.getElementById('confession-buttons').classList.add('hidden');
            
            const textParts = [
                { text: "Kl√°rko,", bold: true },
                { text: "hroznƒõ si v√°≈æ√≠m toho, co mezi sebou m√°me. M√°me podobn√© hodnoty, ve v≈°em si rozum√≠me a jsi neuvƒõ≈ôitelnƒõ inteligentn√≠ a klidn√°." },
                { text: "Hlavnƒõ jsi ale ƒçlovƒõk, se kter√Ωm m≈Ø≈æu b√Ωt naprosto s√°m sebou, proto≈æe v√≠m, ≈æe mƒõ bere≈° p≈ôesnƒõ takov√©ho, jak√Ω jsem." },
                { text: "M√°m tƒõ hroznƒõ r√°d.", highlight: true },
                { text: "Na≈°e p≈ô√°telstv√≠ pro mƒõ znamen√° stra≈°nƒõ moc a nikdy o nƒõj nechci p≈ôij√≠t. Z√°rove≈à ale c√≠t√≠m, ≈æe k tobƒõ m√°m mnohem bl√≠≈æ, a byl bych moc r√°d, kdybychom to spolu zkusili i jako p√°r." },
                { text: "Nechtƒõla bys to se mnou zkusit?", bold: true, center: true }
            ];
            
            let partIndex = 0;
            let charIndex = 0;
            let currentP = null;
            
            function typeChar() {
                if (partIndex >= textParts.length) {
                    setTimeout(() => {
                        const btns = document.getElementById('confession-buttons');
                        btns.classList.remove('hidden');
                        btns.classList.add('animate-fade-in');
                    }, 500);
                    return;
                }
                
                const part = textParts[partIndex];
                
                if (!currentP) {
                    currentP = document.createElement('p');
                    if (part.bold) currentP.className = "font-bold text-white text-lg";
                    if (part.highlight) currentP.className = "text-[#eb459e] font-bold text-center text-xl my-2";
                    if (part.center) currentP.className = "font-bold text-white text-center mt-4 text-lg";
                    currentP.classList.add('typing-cursor');
                    container.appendChild(currentP);
                }
                
                if (charIndex < part.text.length) {
                    currentP.textContent = part.text.substring(0, charIndex + 1);
                    charIndex++;
                    setTimeout(typeChar, 60); // Faster typing speed per char
                } else {
                    currentP.classList.remove('typing-cursor');
                    currentP = null;
                    charIndex = 0;
                    partIndex++;
                    setTimeout(typeChar, 600); // Shorter pause between lines
                }
            }
            
            typeChar();
        }

        function responseYes() { 
            document.getElementById('final-modal-content').innerHTML = `
                <div class="animate-fade-in">
                    <h2 class="text-3xl font-bold text-[#eb459e] mb-2">‚ù§Ô∏è CONNECTION ESTABLISHED! ‚ù§Ô∏è</h2>
                    <p class="text-gray-300 text-lg leading-relaxed mb-6">
                        Dƒõkuju, ≈æe jsi mi dala ≈°anci. Jsi moje kotva v cel√©m tom m√©m chaosu a slibuju, ≈æe si toho budu v√°≈æit ka≈æd√Ω den.
                        <br><br>
                        Tƒõ≈°√≠m se na v≈°echno, co n√°s ƒçek√°.
                    </p>
                    <div class="mt-8">
                        <button onclick="closeModal('final-confession-modal'); switchChannel('dateplanner');" class="w-full bg-gradient-to-r from-[#eb459e] to-[#5865F2] hover:opacity-90 text-white py-4 rounded-lg font-bold text-xl shadow-lg transition transform hover:scale-105">
                            J√≠t na rande
                        </button>
                    </div>
                </div>
            `;
        }
        function responseNo() { 
            document.getElementById('final-modal-content').innerHTML = `
                <div class="animate-fade-in">
                    <h2 class="text-2xl font-bold text-white mb-4">D√≠ky za up≈ô√≠mnost, Kl√°rko.</h2>
                    <p class="text-gray-300 text-lg mb-6 leading-relaxed">
                        Moc si tƒõ v√°≈æ√≠m a jsem r√°d, ≈æe si m≈Ø≈æeme d√°l z≈Østat bl√≠zc√≠ tak, jak jsme.
                        <br><br>
                        Nic se nemƒõn√≠ ‚Äì d√°l budeme yappovat o teori√≠ch a hr√°t Tetris. üòä
                    </p>
                    <button onclick="closeModal('final-confession-modal')" class="w-full bg-[#5865F2] hover:bg-[#4752c4] text-white py-3 rounded-lg font-bold transition">
                        Zpƒõt na server
                    </button>
                </div>
            `; 
        }

        function planDate() {
            const modal = document.getElementById('final-confession-modal');
            const modalBox = document.getElementById('final-modal-box'); // Use the inner box for content replacement
            
            // Create content HTML
            const content = `
                <div class="animate-fade-in">
                    <div class="text-4xl mb-2">üìÖ</div>
                    <h2 class="text-xl font-bold text-white mb-4">Pl√°novaƒç Rande v2.0</h2>
                    <div class="space-y-4 text-left">
                        <div>
                            <label class="block text-[#b9bbbe] text-xs font-bold uppercase mb-1">Kdy m√°≈° ƒças?</label>
                            <select id="date-select" class="w-full bg-[#202225] text-white p-2.5 rounded border border-[#202225] focus:border-[#5865F2] focus:outline-none transition">
                                <option value="Co nejd≈ô√≠ve">Co nejd≈ô√≠ve! üöÄ</option>
                                <option value="Tento v√≠kend">Tento v√≠kend</option>
                                <option value="P≈ô√≠≈°t√≠ t√Ωden">P≈ô√≠≈°t√≠ t√Ωden</option>
                                <option value="Po zkou≈°k√°ch">A≈æ po zkou≈°k√°ch</option>
                                <option value="Jindy">Jindy (napi≈°u ti)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[#b9bbbe] text-xs font-bold uppercase mb-1">Co podnikneme?</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="selectActivity(this, 'Kino')" class="activity-btn bg-[#2f3136] hover:bg-[#40444b] text-white p-3 rounded text-sm font-medium transition border border-transparent hover:border-[#5865F2]">Kino üçø</button>
                                <button type="button" onclick="selectActivity(this, 'Kav√°rna')" class="activity-btn bg-[#2f3136] hover:bg-[#40444b] text-white p-3 rounded text-sm font-medium transition border border-transparent hover:border-[#5865F2]">Kav√°rna ‚òï</button>
                                <button type="button" onclick="selectActivity(this, 'Proch√°zka')" class="activity-btn bg-[#2f3136] hover:bg-[#40444b] text-white p-3 rounded text-sm font-medium transition border border-transparent hover:border-[#5865F2]">Proch√°zka üå≤</button>
                                <button type="button" onclick="selectActivity(this, 'Chill')" class="activity-btn bg-[#2f3136] hover:bg-[#40444b] text-white p-3 rounded text-sm font-medium transition border border-transparent hover:border-[#5865F2]">Chill u mƒõ üéÆ</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[#b9bbbe] text-xs font-bold uppercase mb-1">Detaily / Pozn√°mka</label>
                            <textarea id="custom-note" class="w-full bg-[#202225] text-white p-2.5 rounded border border-[#202225] focus:border-[#5865F2] focus:outline-none transition text-sm h-20 resize-none" placeholder="Nap≈ô. na co m√°≈° chu≈•, jak√Ω film..."></textarea>
                        </div>
                    </div>
                    <button onclick="confirmDate()" class="mt-6 w-full bg-[#5865F2] hover:bg-[#4752c4] text-white py-3 rounded font-bold transition transform active:scale-95 shadow-md"><i class="fas fa-paper-plane mr-2"></i> Odeslat n√°vrh</button>
                </div>
            `;
            
            // Replace only content inside the box
            document.getElementById('final-modal-content').innerHTML = content;
        }
        function selectActivity(btn, act) {
            document.querySelectorAll('.activity-btn').forEach(b => { b.classList.remove('bg-[#5865F2]', 'border-[#5865F2]', 'selected'); b.classList.add('bg-[#2f3136]'); });
            btn.classList.remove('bg-[#2f3136]'); btn.classList.add('bg-[#5865F2]', 'selected'); btn.dataset.value = act;
        }
        function confirmDate() {
            const date = document.getElementById('date-select').value;
            const actBtn = document.querySelector('.activity-btn.selected');
            const activity = actBtn ? actBtn.dataset.value : "Nƒõco vymysl√≠me";
            const note = document.getElementById('custom-note').value;
            const message = `üìÖ **N√ÅVRH RANDE**\n\nüïí **Kdy:** ${date}\nüé≠ **Co:** ${activity}\nüìù **Pozn√°mka:** ${note || "Bez pozn√°mky"}\n\n*Odesl√°no z Kiscordu*`;
            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select();
                try { document.execCommand('copy'); showRedirect(); } catch (err) { showNotification('Chyba', 'error'); }
                document.body.removeChild(textArea);
            };
            if (navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(message).then(showRedirect).catch(() => fallbackCopy(message));
            else fallbackCopy(message);
        }
        function showRedirect() { document.getElementById('final-confession-modal').style.display = 'none'; document.getElementById('redirect-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showNotification(msg, type) {
            const div = document.createElement('div'); div.className = `fixed top-4 right-4 text-white px-4 py-2 rounded shadow-lg z-[100] ${type==='success'?'bg-[#3ba55c]':'bg-[#5865F2]'}`;
            div.innerHTML = msg; document.body.appendChild(div); setTimeout(()=>div.remove(), 3000);
        }

        // --- SEARCH INPUT LISTENER (Global Smart Search) ---
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const val = e.target.value;
                
                // Pokud je pr√°zdno, obnov√≠me aktu√°ln√≠ kan√°l
                if (!val) {
                    switchChannel(state.currentChannel);
                } else {
                    // Jinak spust√≠me glob√°ln√≠ vyhled√°v√°n√≠
                    renderGlobalSearch(val);
                }
            });
            
            // Easter egg p≈ô√≠kazy
            searchInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter' && e.target.value.startsWith('/')) {
                    const cmd = e.target.value.trim();
                    if(cmd === '/sova') showNotification('ü¶â Sovy otoƒç√≠ hlavu o 270¬∞!', 'info');
                    else if(cmd === '/chobotnice') showNotification('üêô Chobotnice maj√≠ modrou krev.', 'info');
                    else if(cmd === '/miluju') showNotification('‚ù§Ô∏è Taky tƒõ miluju!', 'success');
                    e.target.value = '';
                    switchChannel(state.currentChannel); // Reset
                }
            });
        }

        // --- MAP LOGIC FUNCTIONS ---

        function initMap() {
            // 1. Bezpeƒçnostn√≠ kontrola: Existuje kontejner?
            // Pokud u≈æivatel rychle p≈ôepnul jinam, 'leaflet-map' u≈æ v DOMu nen√≠.
            if (!document.getElementById('leaflet-map')) {
                console.warn("Map container not found, skipping init.");
                return;
            }

            // 2. √öklid star√© mapy (pro jistotu)
            if (state.mapInstance) {
                state.mapInstance.remove();
                state.mapInstance = null;
            }

            // 3. Vytvo≈ôen√≠ nov√© mapy
            const map = L.map('leaflet-map').setView([49.069, 17.464], 13);
            state.mapInstance = map;

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            renderMarkers(dateLocations);
        }

        function renderMarkers(locations) {
            if (!state.mapInstance) return;

            state.mapInstance.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    state.mapInstance.removeLayer(layer);
                }
            });

            locations.forEach(loc => {
                let color = '#5865F2'; 
                let iconClass = 'fa-map-marker-alt';
                if (loc.cat === 'food') { color = '#faa61a'; iconClass = 'fa-utensils'; }
                if (loc.cat === 'view') { color = '#eb459e'; iconClass = 'fa-binoculars'; }
                if (loc.cat === 'walk') { color = '#3ba55c'; iconClass = 'fa-tree'; }
                if (loc.cat === 'fun') { color = '#ed4245'; iconClass = 'fa-bolt'; }

                // Zjistit hodnocen√≠
                const rating = state.dateRatings[loc.id] || 0;
                
                // Pokud je to "Top Tier" (5 hvƒõzd), d√°me mu speci√°ln√≠ zlat√Ω marker
                if (rating === 5) { color = '#ffd700'; iconClass = 'fa-heart'; }

                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div class="marker-pin" style="background-color: ${color};">
                            <i class="fas ${iconClass}"></i>
                        </div>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42],
                    popupAnchor: [0, -35]
                });

                const marker = L.marker([loc.lat, loc.lng], { icon: customIcon }).addTo(state.mapInstance);
                
                const starStr = rating > 0 ? `<br><span style="color:#faa61a; font-size:14px; letter-spacing:2px;">${'‚òÖ'.repeat(rating)}</span>` : '';

                marker.bindPopup(`
                    <div style="text-align:center">
                        <b style="color:#fff;font-size:14px">${loc.name}</b>
                        ${starStr}<br>
                        <span style="font-size:11px;color:#b9bbbe">${loc.desc}</span>
                    </div>
                `);
                
                marker.on('click', () => selectLocation(loc.id));
            });
        }

        // --- VYLEP≈†EN√â FUNKCE MAPY A HLED√ÅN√ç ---

        // 1. Spoleƒçn√° funkce pro vykreslen√≠ seznamu (aby se k√≥d neopakoval)
        function renderLocationList(locations) {
            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = '';

            // Se≈ôad√≠me: Nejd≈ô√≠v ta ohodnocen√° (probƒõhl√° rande), pak zbytek
            const sortedLocs = [...locations].sort((a, b) => {
                const rateA = state.dateRatings[a.id] || 0;
                const rateB = state.dateRatings[b.id] || 0;
                return rateB - rateA; // Vy≈°≈°√≠ hodnocen√≠ naho≈ôe
            });

            if (sortedLocs.length === 0) {
                listContainer.innerHTML = '<div class="text-gray-500 text-xs text-center p-4">Nic nenalezeno... üîç</div>';
                return;
            }

            sortedLocs.forEach(loc => {
                const icons = { view: '‚õ∞Ô∏è', food: 'üçî', fun: '‚ö°', walk: 'üå≤' };
                let icon = icons[loc.cat] || 'üìç';
                
                // Zjistit hodnocen√≠
                const rating = state.dateRatings[loc.id] || 0;
                let ratingHtml = '';
                if(rating > 0) {
                    ratingHtml = `<div class="text-[#faa61a] text-[10px] mt-0.5">${'‚òÖ'.repeat(rating)}</div>`;
                }

                // Pokud je ohodnoceno, d√°me mu zlat√Ω okraj
                const borderClass = rating > 0 ? 'border-[#faa61a]/50' : 'border-[#202225]';

                listContainer.innerHTML += `
                    <div onclick="selectLocation(${loc.id})" class="p-3 bg-[#36393f] hover:bg-[#40444b] rounded cursor-pointer transition flex items-center gap-3 border ${borderClass} group mb-1 relative overflow-hidden">
                        ${rating > 0 ? '<div class="absolute top-0 right-0 w-3 h-3 bg-[#faa61a] rounded-bl-lg"></div>' : ''}
                        <div class="text-lg group-hover:scale-110 transition">${icon}</div>
                        <div class="min-w-0">
                            <div class="font-bold text-gray-200 text-sm truncate">${loc.name}</div>
                            <div class="text-[10px] text-gray-500 truncate">${loc.desc}</div>
                            ${ratingHtml}
                        </div>
                    </div>
                `;
            });
        }

        // 2. Upraven√° filtrace podle kategori√≠
        function filterMap(category) {
            // 1. Vyƒçistit vyhled√°vac√≠ pole p≈ôi zmƒõnƒõ filtru
            const mobileSearch = document.getElementById('planner-search-mobile');
            const desktopSearch = document.getElementById('planner-search-desktop');
            if(mobileSearch) mobileSearch.value = '';
            if(desktopSearch) desktopSearch.value = '';

            // 2. Filtrovat data
            const filtered = category === 'all' ? dateLocations : dateLocations.filter(l => l.cat === category);
            renderLocationList(filtered);
            renderMarkers(filtered);

            // 3. AKTUALIZACE TLAƒå√çTEK (Visual)
            const buttons = document.querySelectorAll('.filter-btn');
            
            // Definice barev pro aktivn√≠ stav
            const activeColors = {
                'all': 'bg-[#5865F2]', // Modr√°
                'view': 'bg-[#eb459e]', // R≈Ø≈æov√°
                'fun': 'bg-[#ed4245]',  // ƒåerven√°
                'food': 'bg-[#faa61a]', // Oran≈æov√°
                'walk': 'bg-[#3ba55c]'  // Zelen√°
            };

            buttons.forEach(btn => {
                const btnCat = btn.getAttribute('data-filter');
                const isActive = btnCat === category;

                // Reset: Odstran√≠me v≈°echny barvy a "active" classy
                btn.className = btn.className
                    .replace(/bg-\[#\w+\]/g, '') // Pryƒç s hex barvami pozad√≠
                    .replace('text-white', '')
                    .replace('text-gray-300', '')
                    .replace('shadow-lg', '')
                    .replace('scale-105', '');

                if (isActive) {
                    // AKTIVN√ç: Spr√°vn√° barva, b√≠l√Ω text, st√≠n
                    btn.classList.add(activeColors[btnCat], 'text-white', 'shadow-lg', 'scale-105');
                    // Na mobilu zru≈°√≠me pr≈Øhlednost, a≈• to sv√≠t√≠
                    btn.classList.remove('bg-[#202225]/90'); 
                } else {
                    // NEAKTIVN√ç: Tmav√© pozad√≠, ≈°ed√Ω text
                    btn.classList.add('text-gray-400'); // Neaktivn√≠ text
                    
                    // Pozad√≠ podle toho, jestli je to mobil (backdrop) nebo desktop
                    if (btn.classList.contains('backdrop-blur')) {
                        btn.classList.add('bg-[#202225]/90');
                    } else {
                        btn.classList.add('bg-[#202225]');
                    }
                }
            });
        }

        // --- NOV√Å FUNKCE: J√Å M√ÅM ≈†TƒöST√ç (Random Picker) ---
        function pickRandomLocation() {
            // 1. Zjist√≠me, jak√Ω je aktivn√≠ filtr (ulo≈æen√Ω v state.dateFilter, nebo 'all')
            // Pokud state.dateFilter nem√°≈° nastaven√Ω p≈ôesnƒõ, vezmeme to z DOMu tlaƒç√≠tka
            const activeBtn = document.querySelector('.filter-btn.bg-\\[\\#5865F2\\]') 
                              || document.querySelector('.filter-btn.bg-\\[\\#eb459e\\]') // V√Ωhledy
                              || document.querySelector('.filter-btn.bg-\\[\\#ed4245\\]') // Z√°bava
                              || document.querySelector('.filter-btn.bg-\\[\\#faa61a\\]') // J√≠dlo
                              || document.querySelector('.filter-btn.bg-\\[\\#3ba55c\\]'); // Proch√°zky
            
            const currentFilter = activeBtn ? activeBtn.dataset.filter : 'all';

            // 2. Vyfiltrujeme dostupn√° m√≠sta
            const candidates = currentFilter === 'all' 
                ? dateLocations 
                : dateLocations.filter(loc => loc.cat === currentFilter);

            if (candidates.length === 0) {
                showNotification("≈Ω√°dn√° m√≠sta k v√Ωbƒõru!", "info");
                return;
            }

            // 3. Efekt "m√≠ch√°n√≠" (dobrovoln√© - jen vizu√°ln√≠ sranda)
            triggerHaptic('medium');
            
            // 4. Vybereme n√°hodn√© m√≠sto
            const randomIndex = Math.floor(Math.random() * candidates.length);
            const winner = candidates[randomIndex];

            // 5. Otev≈ôeme ho
            selectLocation(winner.id);
            
            // 6. Ozn√°men√≠
            showNotification(`üé≤ Kostka vybrala: ${winner.name}`, "success");
        }

        // 3. NOV√Å FUNKCE: Vyhled√°v√°n√≠
        function searchLocations(query) {
            const term = query.toLowerCase();
            const filtered = dateLocations.filter(l => 
                l.name.toLowerCase().includes(term) || 
                l.desc.toLowerCase().includes(term)
            );
            
            renderLocationList(filtered);
            renderMarkers(filtered);
        }

        function selectLocation(id) {
            const loc = dateLocations.find(l => l.id === id);
            if (!loc) return;
            
            selectedDateLocation = loc;

            // 1. Zav≈ô√≠t seznam m√≠st (pro mobiln√≠ zobrazen√≠)
            const sidebar = document.getElementById('planner-sidebar');
            if (sidebar) sidebar.classList.remove('active');

            // 2. UI UPDATE - Zobrazen√≠ obsahu
            const emptyState = document.getElementById('detail-empty'); 
            const contentState = document.getElementById('detail-content');
            if(emptyState) emptyState.classList.add('hidden');
            if(contentState) contentState.classList.remove('hidden');
            
            // 3. VYPLNƒöN√ç Z√ÅKLADN√çCH DAT
            document.getElementById('detail-title').innerText = loc.name;
            document.getElementById('detail-desc').innerText = loc.desc;
            
            // Kategorie
            const catEl = document.getElementById('detail-cat');
            catEl.innerText = loc.cat.toUpperCase();
            
            // --- OPRAVA: POƒåAS√ç (Weather Badge) ---
            // Zkontrolujeme, jestli element pro poƒças√≠ existuje, pokud ne, vytvo≈ô√≠me ho hned za kategori√≠
            let weatherBadge = document.getElementById('detail-weather-badge');
            // Pokud tam badge nen√≠, nebo jsme p≈ôepli na jin√© m√≠sto (pro jistotu ho resetujeme/vytvo≈ô√≠me znovu v DOMu)
            if (!weatherBadge) {
                weatherBadge = document.createElement('span');
                weatherBadge.id = 'detail-weather-badge';
                // V√Ωchoz√≠ styl
                weatherBadge.className = "ml-2 text-[10px] px-2 py-0.5 rounded bg-[#202225] text-gray-400";
                // Vlo≈æ√≠me ho za kategorii
                catEl.parentNode.insertBefore(weatherBadge, catEl.nextSibling);
            }
            // Zavol√°me API pro z√≠sk√°n√≠ aktu√°ln√≠ho poƒças√≠
            // Ujisti se, ≈æe m√°≈° v k√≥du i funkci fetchLocationWeather!
            if (typeof fetchLocationWeather === "function") {
                fetchLocationWeather(loc.lat, loc.lng);
            } else {
                console.error("Chyb√≠ funkce fetchLocationWeather!");
            }
            // -------------------------------------

            // 4. HODNOCEN√ç (Hvƒõzdiƒçky)
            let ratingContainer = document.getElementById('detail-rating-container');
            if (!ratingContainer) {
                ratingContainer = document.createElement('div');
                ratingContainer.id = 'detail-rating-container';
                ratingContainer.className = "mt-3 mb-4 p-3 bg-[#202225] rounded border border-[#2f3136]";
                const descEl = document.getElementById('detail-desc');
                descEl.parentNode.insertBefore(ratingContainer, descEl.nextSibling);
            }

            // --- OPRAVA: V≈°e na jeden ≈ô√°dek, aby panel nesk√°kal ---
            const currentRating = state.dateRatings[loc.id] || 0;
            const notes = ["Nic moc üòï", "U≈°lo to üôÇ", "Dobr√Ω! üòÉ", "Super rande! üòç", "Best date ever! üíç"];
            const noteText = currentRating > 0 ? notes[currentRating-1] : "";

            // Obalovac√≠ kontejner s fixn√≠ v√Ω≈°kou (h-6), items-center zarovn√° v≈°e na st≈ôed ≈ô√°dku
            let starsHtml = `<div class="flex items-center h-6 overflow-hidden whitespace-nowrap">`;
            
            // 1. TEXT "HODNOCEN√ç RANDE"
            starsHtml += `<span class="text-xs font-bold text-gray-400 uppercase mr-2">Hodnocen√≠:</span>`;
            
            // 2. HVƒöZDIƒåKY
            starsHtml += `<div class="star-rating-group flex mr-3">`;
            for (let i = 5; i >= 1; i--) {
                const activeClass = i <= currentRating ? 'active' : '';
                // Zmen≈°il jsem text-xl na text-lg, aby se to l√©pe ve≈°lo
                starsHtml += `<button onclick="rateDate(${loc.id}, ${i})" class="star-btn ${activeClass} text-lg px-0.5">‚òÖ</button>`;
            }
            starsHtml += `</div>`;

            // 3. TEXT HODNOCEN√ç (Hned vedle hvƒõzd)
            if (noteText) {
                starsHtml += `<span class="text-[10px] text-[#faa61a] font-bold italic animate-fade-in">${noteText}</span>`;
            }

            starsHtml += `</div>`;
            
            ratingContainer.innerHTML = starsHtml;

            // 5. ODKAZ NA GOOGLE MAPS
            let mapsUrl = loc.url ? loc.url : "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(loc.name + " ƒåesk√° republika");
            const googleLink = document.getElementById('detail-google');
            if(googleLink) googleLink.href = mapsUrl;

            // 6. MAPA - P≈òELET (FlyTo) S OFFSETEM
            if (state.mapInstance) {
                const targetZoom = 16;
                
                // A) Vypoƒç√≠t√°me offset (posun)
                // Chceme marker dostat do horn√≠ ƒç√°sti obrazovky (cca v 25 % odshora)
                // Proto mus√≠me st≈ôed mapy posunout DOL≈Æ o 25 % v√Ω≈°ky mapy.
                
                // P≈ôevedeme GPS markeru na pixely (v r√°mci mapy)
                const targetPoint = state.mapInstance.project([loc.lat, loc.lng], targetZoom);
                
                // Z√≠sk√°me v√Ω≈°ku mapy
                const mapHeight = state.mapInstance.getSize().y;
                
                // Posuneme c√≠lov√Ω bod o 1/4 v√Ω≈°ky mapy dol≈Ø (pixely)
                // T√≠m p√°dem, a≈æ se mapa vycentruje na tento "fale≈°n√Ω st≈ôed", 
                // n√°≈° marker bude vizu√°lnƒõ v horn√≠ ƒçtvrtinƒõ.
                const offsetY = mapHeight * 0.15; 
                
                const newCenterPoint = targetPoint.add([0, offsetY]);
                
                // P≈ôevedeme pixely zpƒõt na GPS sou≈ôadnice pro Leaflet
                const newCenterLatLng = state.mapInstance.unproject(newCenterPoint, targetZoom);

                // Provedeme let na nov√© sou≈ôadnice
                state.mapInstance.flyTo(newCenterLatLng, targetZoom, { animate: true, duration: 1.0 });
                
                // Otev≈ôen√≠ bubliny (Popup)
                state.mapInstance.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer.getLatLng().lat === loc.lat) {
                        const rating = state.dateRatings[loc.id] || 0;
                        const starStr = rating > 0 ? `<br><span style="color:#faa61a">${'‚òÖ'.repeat(rating)}</span>` : '';
                        
                        layer.bindPopup(`
                            <div style="text-align:center">
                                <b style="color:#fff;font-size:14px">${loc.name}</b>
                                ${starStr}<br>
                                <span style="font-size:11px;color:#b9bbbe">${loc.desc}</span>
                            </div>
                        `);
                        // Otev≈ôeme popup s mal√Ωm zpo≈ædƒõn√≠m, a≈æ tam mapa dolet√≠
                        setTimeout(() => layer.openPopup(), 500);
                    }
                });

                //7. OTEV≈òEN√ç PANELU (Half mode)
                // Pou≈æijeme mal√Ω timeout, aby se stihl vykreslit obsah a spoƒç√≠tat v√Ω≈°ka
                setTimeout(() => {
                    setPanelPosition('half');
                }, 50);
            }
        }

        function copyDateInvite() {
            if (!selectedDateLocation) return;

            const dateVal = document.getElementById('date-input').value;
            const noteVal = document.getElementById('note-input').value;

            let dateStr = "Co nejd≈ô√≠ve";
            if (dateVal) {
                const d = new Date(dateVal);
                dateStr = d.toLocaleString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
            }

            const text = `üíå **POZV√ÅNKA NA RANDE** üíå\n\nüìç **M√≠sto:** ${selectedDateLocation.name}\nüìù **Popis:** ${selectedDateLocation.desc}\n‚è∞ **Kdy:** ${dateStr}\nüí¨ **Pozn√°mka:** ${noteVal || "Tƒõ≈°√≠m se!"}\n\n*Vygenerov√°no v Kiscord Planneru*`;

            navigator.clipboard.writeText(text).then(() => {
                showNotification("Zkop√≠rov√°no! Teƒè mi to po≈°li (Ctrl+V).", "success");
            }).catch(() => {
                alert("Ne≈°lo zkop√≠rovat automaticky, tady je text:\n" + text);
            });
        }
        

        function changeTheme(theme) {
            const root = document.documentElement;
            // Clear inline styles first (font-family, font-size from Tetris)
            document.body.style.fontFamily = '';
            document.body.style.fontSize = '';
            
            if (theme === 'christmas') { 
                root.style.setProperty('--bg-tertiary', '#420d0d'); 
                root.style.setProperty('--bg-secondary', '#5c1414'); 
                root.style.setProperty('--bg-primary', '#240a0a'); 
                root.style.setProperty('--blurple', '#c92a2a'); // Red
                root.style.setProperty('--green', '#ffd700'); // Gold
                root.style.setProperty('--text-header', '#ffffff');
                root.style.setProperty('--interactive-active', '#ffffff');
                root.style.setProperty('--interactive-normal', '#e8e8e8'); // Lighter text
                root.style.setProperty('--text-normal', '#f0f0f0');
            } 
            else if (theme === 'tetris') {
                root.style.setProperty('--bg-tertiary', '#0d0e15');
                root.style.setProperty('--bg-secondary', '#151620');
                root.style.setProperty('--bg-primary', '#1c1d29');
                root.style.setProperty('--blurple', '#00e5ff'); 
                root.style.setProperty('--green', '#69f0ae'); 
                root.style.setProperty('--red', '#ff5252'); 
                root.style.setProperty('--yellow', '#ffd740'); 
                root.style.setProperty('--pink', '#e040fb'); 
                root.style.setProperty('--text-normal', '#33ff00');
                root.style.setProperty('--interactive-normal', '#33ff00');
                document.body.style.fontFamily = "'Press Start 2P', cursive"; 
                document.body.style.fontSize = "0.8rem";
            }
            else { // default
                root.style.setProperty('--bg-tertiary', '#202225'); root.style.setProperty('--bg-secondary', '#2f3136'); root.style.setProperty('--bg-primary', '#36393f'); 
                root.style.setProperty('--blurple', '#5865F2');
                root.style.setProperty('--green', '#3ba55c');
                root.style.setProperty('--red', '#ed4245');
                root.style.setProperty('--yellow', '#faa61a');
                root.style.setProperty('--pink', '#eb459e');
                root.style.setProperty('--text-normal', '#dcddde');
                root.style.setProperty('--interactive-normal', '#b9bbbe');
            }
            showNotification(`T√©ma zmƒõnƒõno: ${theme}`, 'success');
        }

        // INIT
        if(state.quizAnswers.completed) { document.getElementById('login-screen').style.display = 'none'; showMainApp(); }
        const search = document.getElementById('search-input');
        if (search) search.addEventListener('input', () => { if (['movies', 'series', 'games'].includes(state.currentChannel)) renderLibrary(state.currentChannel); });

        // --- PWA: OFFLINE MODE REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => {
                        console.log('Service Worker zaregistrov√°n:', reg.scope);
                    })
                    .catch((err) => {
                        console.log('Service Worker registrace selhala:', err);
                    });
            });
        }

        // --- DETEKCE OFFLINE STAVU (Notifikace pro Kl√°rku) ---
        window.addEventListener('offline', () => {
            showNotification("üì° Ztr√°ta spojen√≠! P≈ôep√≠n√°m na offline re≈æim.", "error");
            document.body.style.filter = "grayscale(0.5)"; // Vizu√°ln√≠ efekt
        });

        window.addEventListener('online', () => {
            showNotification("üåê Jsi zpƒõt online!", "success");
            document.body.style.filter = "none";
            // Znovu naƒçteme mapu, kdyby chybƒõly dla≈ædice
            if(state.mapInstance) {
                state.mapInstance.invalidateSize();
            }
        });
    </script>
</body>
</html>